<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OnGoPool - Carpool App</title>
    <meta name="description" content="Share rides, save money, and reduce your carbon footprint with OnGoPool">
    <meta name="theme-color" content="#6C63FF">
    
    <!-- Production Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://js.stripe.com; style-src 'self' 'unsafe-inline' https://unpkg.com https://cdnjs.cloudflare.com; img-src 'self' data: blob: https: http:; connect-src 'self' https: wss:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    
    <!-- Performance Optimization -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://efjwsdxgelbgthcyltjr.supabase.co">
    <link rel="dns-prefetch" href="https://nominatim.openstreetmap.org">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%236C63FF'/%3E%3Cpath d='M25 45h50l-5-10H30z' fill='white'/%3E%3Crect x='30' y='45' width='40' height='20' rx='5' fill='white'/%3E%3Ccircle cx='35' cy='70' r='8' fill='%23333'/%3E%3Ccircle cx='65' cy='70' r='8' fill='%23333'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- TensorFlow.js for AI Features -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.0.0/dist/tf.min.js"></script>
    <style>
        :root {
            /* AI-inspired color palette */
            --primary-color: #6C63FF; /* Vibrant purple - AI primary */
            --secondary-color: #ffffff; /* White */
            --text-color: #2D3748; /* Dark slate for text */
            --background-color: #ffffff; /* White background */
            --border-color: #E2E8F0; /* Light gray border */
            --success-color: #38B2AC; /* Teal */
            --warning-color: #ED8936; /* Orange */
            --error-color: #E53E3E; /* Red */
            --accent-color: #4FD1C5; /* Light teal accent */
            --light-bg-color: #F7FAFC; /* Very light background */
            --dark-purple: #5A51DB; /* Darker purple for hover states */
            --medium-purple: #8B85F8; /* Medium purple for secondary elements */
            --gradient-start: #6C63FF; /* Gradient start color */
            --gradient-end: #4FD1C5; /* Gradient end color */
            --card-bg: #FAFAFA; /* Card background */
            --card-shadow: 0 4px 6px rgba(108, 99, 255, 0.1); /* Subtle purple shadow */
            --glow-effect: 0 0 15px rgba(108, 99, 255, 0.3); /* Subtle glow effect */
            --ai-dark: #2C2A54; /* Dark AI-inspired color */
            
            /* Admin specific colors */
            --admin-primary: #FF6B6B;
            --admin-secondary: #FF8E53;
            --admin-dark: #2C3E50;
            --admin-light: #ECF0F1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        h1, h2, h3, h4, h5, h6, .welcome-title, .auth-title {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: -0.02em;
        }

        .mobile-container {
            max-width: 428px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--background-color);
            position: relative;
            box-shadow: 0 0 20px rgba(108, 99, 255, 0.15);
            border-radius: 16px;
            overflow: hidden;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--secondary-color);
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .header h1 i {
            font-size: 1.25rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .nav-tabs {
            display: flex;
            background: var(--background-color);
            border-bottom: none;
            position: sticky;
            top: 60px;
            z-index: 99;
            padding: 0.5rem;
            gap: 0.25rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
            margin-bottom: 0;
        }

        .nav-tab {
            flex: 1;
            padding: 0.75rem 0.5rem;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--text-color);
            opacity: 0.7;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
        }
        
        .nav-tab i {
            font-size: 1rem;
            margin-bottom: 0.1rem;
        }

        .nav-tab.active {
            background: rgba(108, 99, 255, 0.1);
            font-weight: 600;
            color: var(--primary-color);
            opacity: 1;
            box-shadow: 0 4px 8px rgba(108, 99, 255, 0.1);
        }

        .nav-tab:hover {
            background: rgba(108, 99, 255, 0.05);
            opacity: 0.9;
        }

        .tab-content {
            display: none;
            padding: 1.25rem;
            padding-top: 0.5rem;
            min-height: calc(100vh - 200px);
            animation: fadeIn 0.5s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: var(--card-bg);
            border: none;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            margin-top: 0;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-effect);
        }
        
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 60px);
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #f8f9fa, #f1f3f9);
            position: relative;
            overflow: hidden;
        }
        
        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(108, 99, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 70% 60%, rgba(79, 209, 197, 0.08) 0%, transparent 50%);
            z-index: 0;
        }
        
        .auth-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }
        
        .auth-logo {
            text-align: center;
            margin-bottom: 1.5rem;
            font-size: 3rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(108, 99, 255, 0.3));
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .auth-link {
            display: block;
            text-align: center;
            margin-top: 1rem;
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        .welcome-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #f1f3f9);
            text-align: center;
            position: relative;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        
        .welcome-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 30% 20%, rgba(108, 99, 255, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 70% 60%, rgba(79, 209, 197, 0.08) 0%, transparent 50%);
            z-index: 0;
        }
        
        .welcome-logo {
            position: relative;
            z-index: 1;
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(108, 99, 255, 0.3));
        }
        
        .welcome-title {
            position: relative;
            z-index: 1;
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
            letter-spacing: -0.03em;
        }
        
        .welcome-subtitle {
            position: relative;
            z-index: 1;
            font-size: 1.25rem;
            color: var(--text-color);
            margin-bottom: 2.5rem;
            max-width: 400px;
            line-height: 1.6;
            opacity: 0.8;
        }
        
        .welcome-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 300px;
            position: relative;
            z-index: 2;
        }
        
        .welcome-container .btn {
            padding: 1rem 1.5rem;
            border-radius: 14px;
        }
        
        /* Admin Dashboard Styles */
        #admin-dashboard {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
        }
            
        /* Pricing Tiers Styles */
        .pricing-tiers-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .pricing-tiers-table th,
        .pricing-tiers-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .pricing-tiers-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        /* Daily Ride Limits Styles */
        .ride-limits-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .ride-limits-table th,
        .ride-limits-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        
        .ride-limits-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 0;
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        
        .admin-container {
            display: flex;
            height: 100vh;
            background: #f8f9fa;
        }

        /* Sidebar Styles */
        .admin-sidebar {
            width: 280px;
            background: #ffffff;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .admin-sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--admin-primary);
            margin-bottom: 1.5rem;
        }

        .admin-logo > div {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .sidebar-close {
            background: none;
            border: none;
            font-size: 1.1rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 2rem;
            height: 2rem;
        }

        .sidebar-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        .admin-logo i {
            font-size: 1.5rem;
        }

        .admin-user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--admin-primary), var(--admin-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .admin-details {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        .admin-role {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.25rem;
        }

        /* Navigation Styles */
        .admin-nav {
            flex: 1;
            padding: 1.5rem 0;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0 1.5rem;
            margin-bottom: 0.75rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: #4a5568;
            text-decoration: none;
            transition: all 0.2s ease;
            position: relative;
            gap: 0.75rem;
        }

        .nav-item:hover {
            background: #f7fafc;
            color: var(--admin-primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(255, 107, 107, 0.1), transparent);
            color: var(--admin-primary);
            border-right: 3px solid var(--admin-primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            background: #e2e8f0;
            color: #4a5568;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            margin-left: auto;
            font-weight: 600;
        }

        .nav-badge.urgent {
            background: #fed7d7;
            color: #c53030;
        }

        .nav-badge.warning {
            background: #feebc8;
            color: #c05621;
        }

        .admin-sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .logout-btn {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            color: #4a5568;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: #edf2f7;
            color: #c53030;
        }

        /* Main Content Area */
        .admin-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .admin-topbar {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #4a5568;
            cursor: pointer;
        }

        .breadcrumb {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .topbar-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .quick-stats {
            display: flex;
            gap: 1.5rem;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #4a5568;
        }

        .text-success { color: #38a169; }

        .admin-notifications {
            position: relative;
        }

        .notification-btn {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #4a5568;
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--admin-primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Content Styles */
        .admin-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #f8f9fa;
        }

        /* Stop management styles */
        .stop-group {
            position: relative;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(108, 99, 255, 0.02);
        }

        .btn-remove-stop {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-remove-stop:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* Enhanced stop management styles */
        .enhanced-stop {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--light-bg-color);
            transition: all 0.3s ease;
            position: relative;
        }

        .enhanced-stop:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(108, 99, 255, 0.15);
        }

        .enhanced-stop.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            z-index: 1000;
        }

        .enhanced-stop.drag-over {
            border-color: var(--primary-color);
            background: rgba(108, 99, 255, 0.05);
            transform: translateY(-2px);
        }

        .stop-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stop-drag-handle {
            cursor: grab;
            color: #888;
            margin-right: 0.75rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .stop-drag-handle:hover {
            background: rgba(108, 99, 255, 0.1);
            color: var(--primary-color);
        }

        .stop-drag-handle:active {
            cursor: grabbing;
        }

        .stop-timing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            margin-top: 0.5rem;
        }

        .stop-eta {
            font-weight: 500;
            color: var(--primary-color);
        }

        .arrival-time {
            font-weight: 600;
            color: #059669;
        }

        .travel-time {
            color: #7c3aed;
        }

        .btn-outline {
            background: transparent;
            border: 2px dashed var(--primary-color);
            color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
            border-style: solid;
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .content-header p {
            color: #718096;
            font-size: 1rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .header-status {
            margin-top: 1rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.urgent {
            background: #fed7d7;
            color: #c53030;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .kpi-card.primary .kpi-icon { background: #667eea; }
        .kpi-card.success .kpi-icon { background: #48bb78; }
        .kpi-card.warning .kpi-icon { background: #ed8936; }
        .kpi-card.info .kpi-icon { background: #4299e1; }

        .kpi-content {
            flex: 1;
        }

        .kpi-label {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 0.25rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .kpi-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kpi-change.positive { color: #38a169; }
        .kpi-change.negative { color: #e53e3e; }
        .kpi-change.neutral { color: #718096; }

        /* Dashboard Layout */
        .dashboard-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .content-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #e9ecef;
            overflow: hidden;
        }

        .card-header {
            padding: 1.5rem 1.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f1f3f4;
        }

        .card-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2d3748;
        }

        .btn-link {
            background: none;
            border: none;
            color: var(--admin-primary);
            font-size: 0.85rem;
            cursor: pointer;
        }

        /* Activity Feed */
        .activity-feed {
            padding: 1rem 1.5rem;
        }

        .activity-item {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f7fafc;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .activity-icon.success { background: #48bb78; }
        .activity-icon.primary { background: #667eea; }
        .activity-icon.warning { background: #ed8936; }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            color: #2d3748;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            color: #a0aec0;
            font-size: 0.8rem;
        }

        /* Quick Actions */
        .quick-actions {
            padding: 1rem 1.5rem;
        }

        .quick-action-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: #f8f9fa;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .quick-action-item:hover {
            background: white;
            transform: translateY(-1px);
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .action-icon.pending { background: #ed8936; }
        .action-icon.warning { background: #e53e3e; }
        .action-icon.info { background: #4299e1; }
        .action-icon.success { background: #48bb78; }

        .action-content {
            flex: 1;
            text-align: left;
        }

        .action-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .action-count {
            color: #718096;
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* Filters and Search */
        .filters-bar {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: var(--admin-primary);
            color: white;
            border-color: var(--admin-primary);
        }

        /* Data Tables */
        .data-table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 1rem;
            background: #f8f9fa;
            color: #4a5568;
            font-weight: 600;
            font-size: 0.85rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.9rem;
        }

        /* Tab Content */
        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        /* Additional Utility Styles */
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-driver { background: #e6fffa; color: #234e52; }
        .badge-passenger { background: #e0e7ff; color: #3730a3; }
        .badge-both { background: #f0fff4; color: #22543d; }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.active { background: #d1fae5; color: #065f46; }
        .status-badge.suspended { background: #fee2e2; color: #991b1b; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #4a5568;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .btn-icon.danger:hover {
            background: #fed7d7;
            color: #c53030;
        }

        .verification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .verification-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .verification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .user-email {
            font-size: 0.8rem;
            color: #718096;
        }

        .verification-details {
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .detail-label {
            color: #718096;
            font-size: 0.85rem;
        }

        .detail-value {
            color: #2d3748;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .verification-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        .btn-success {
            background: #48bb78;
            color: white;
            border: none;
        }

        .btn-danger {
            background: #f56565;
            color: white;
            border: none;
        }

        .btn-secondary {
            background: #edf2f7;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        /* Desktop sidebar states */
        .admin-sidebar.collapsed {
            transform: translateX(-280px);
            transition: transform 0.3s ease;
        }

        .admin-main.expanded {
            margin-left: 0;
            transition: margin-left 0.3s ease;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
                transform: none;
            }

            .admin-sidebar.open {
                left: 0;
            }

            .admin-sidebar.collapsed {
                transform: none;
                left: -280px;
            }

            .sidebar-toggle {
                display: block;
            }

            .admin-main {
                margin-left: 0;
            }

            .admin-main.expanded {
                margin-left: 0;
            }
        }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-row {
                grid-template-columns: 1fr;
            }

            .filters-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-stats {
                display: none;
            }

            .verification-grid {
                grid-template-columns: 1fr;
            }

            .admin-content {
                padding: 1rem;
            }

            .topbar-right {
                gap: 1rem;
            }
        }
            display: flex;
            gap: 2rem;
            overflow-x: auto;
        }

        .admin-tab {
            background: none;
            border: none;
            padding: 1rem 0.5rem;
            color: #666;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-tab.active {
            color: var(--admin-primary);
            border-bottom-color: var(--admin-primary);
        }

        .admin-tab:hover {
            color: var(--admin-primary);
        }

        .admin-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .admin-tab-content {
            display: none;
        }

        .admin-tab-content.active {
            display: block;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .admin-stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-content h3 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
            color: #2d3748;
        }

        .stat-content p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .stat-change {
            font-size: 0.8rem;
            font-weight: 500;
            margin-top: 0.25rem;
            display: block;
        }

        .stat-change.positive { color: #22c55e; }
        .stat-change.negative { color: #ef4444; }
        .stat-change.neutral { color: #6b7280; }

        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .admin-section-header h2 {
            margin: 0;
            color: #2d3748;
        }

        .admin-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .admin-search {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            width: 250px;
        }

        .admin-select {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .admin-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--admin-primary);
            color: white;
            border-color: var(--admin-primary);
        }

        .admin-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #4a5568;
        }

        .admin-table tr:hover {
            background: #f8f9fa;
        }

        .admin-quick-actions {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-quick-actions h3 {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .quick-action-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }

        .quick-action-btn:hover {
            border-color: var(--admin-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .quick-action-btn i {
            font-size: 1.5rem;
            color: var(--admin-primary);
            margin-bottom: 0.5rem;
            display: block;
        }

        .action-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--admin-primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .admin-recent-activity {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .admin-recent-activity h3 {
            margin: 0 0 1rem 0;
            color: #2d3748;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: white;
        }

        .license-verification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .license-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #fbbf24;
        }

        .license-card.approved {
            border-left-color: #22c55e;
        }

        .license-card.rejected {
            border-left-color: #ef4444;
        }

        .license-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .license-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .license-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .license-status.approved {
            background: #d1fae5;
            color: #047857;
        }

        .license-status.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .revenue-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .revenue-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .revenue-card h3 {
            margin: 0 0 0.5rem 0;
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .revenue-amount {
            font-size: 2rem;
            font-weight: 700;
            color: var(--admin-primary);
            margin-bottom: 0.5rem;
        }

        .revenue-change {
            font-size: 0.8rem;
            font-weight: 500;
        }

        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .report-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .report-card h3 {
            margin: 0 0 0.5rem 0;
            color: #2d3748;
        }

        .report-card p {
            color: #666;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .admin-content {
                padding: 1rem;
            }
            
            .admin-tabs {
                padding: 0 1rem;
            }
            
            .admin-header {
                padding: 1rem;
            }
            
            .admin-nav {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .admin-section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            
            .admin-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .admin-search {
                width: 100%;
                max-width: 200px;
            }
        }
        
        .floating-shapes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }
        
        .shape {
            position: absolute;
            opacity: 0.1;
            filter: blur(8px);
            border-radius: 50%;
        }
        
        .shape-1 {
            width: 150px;
            height: 150px;
            background: var(--gradient-start);
            top: 10%;
            left: 10%;
            animation: float 20s infinite alternate ease-in-out;
        }
        
        .shape-2 {
            width: 100px;
            height: 100px;
            background: var(--gradient-end);
            bottom: 20%;
            right: 15%;
            animation: float 15s infinite alternate-reverse ease-in-out;
        }
        
        .shape-3 {
            width: 80px;
            height: 80px;
            background: var(--primary-color);
            bottom: 30%;
            left: 20%;
            animation: float 18s infinite alternate ease-in-out;
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) translateX(0) rotate(0);
            }
            50% {
                transform: translateY(-20px) translateX(20px) rotate(10deg);
            }
            100% {
                transform: translateY(20px) translateX(-20px) rotate(-10deg);
            }
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(108, 99, 255, 0.15);
            background: rgba(255, 255, 255, 0.95);
        }
        
        .form-group {
            position: relative;
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--ai-dark);
            transition: color 0.3s ease;
        }
        
        .form-group:focus-within .form-label {
            color: var(--primary-color);
        }

        .user-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .user-type-btn:hover {
            border-color: var(--primary-color);
            background: rgba(108, 99, 255, 0.05);
            transform: translateY(-2px);
        }
        
        .user-type-btn.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            box-shadow: var(--glow-effect);
        }
        
        .user-type-btn i {
            font-size: 1.2rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.85rem 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.01em;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: var(--secondary-color);
            box-shadow: 0 4px 10px rgba(108, 99, 255, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(108, 99, 255, 0.35);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: var(--ai-dark);
            border: 1px solid rgba(226, 232, 240, 0.6);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(5px);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2C9F9A);
            color: white;
            box-shadow: 0 4px 10px rgba(56, 178, 172, 0.25);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(56, 178, 172, 0.35);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #D97B26);
            color: white;
            box-shadow: 0 4px 10px rgba(237, 137, 54, 0.25);
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(237, 137, 54, 0.35);
        }

        .btn-full {
            width: 100%;
        }

        .relative {
            position: relative;
        }

        /* Address Suggestions Styling */
        .address-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover {
            background-color: rgba(108, 99, 255, 0.05);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-main {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .suggestion-detail {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Price Slider Styling */
        .price-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
            margin: 0.5rem 0;
        }

        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(108, 99, 255, 0.3);
            transition: all 0.2s ease;
        }

        .price-slider::-webkit-slider-thumb:hover {
            background: var(--dark-purple);
            transform: scale(1.1);
        }

        .price-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(108, 99, 255, 0.3);
        }

        /* Map Styling */
        .leaflet-container {
            border-radius: 12px !important;
        }

        /* Make form groups relative for absolute positioning of suggestions */
        .form-group {
            position: relative;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .modal.active,
        .modal[style*="display: flex"],
        .modal[style*="display: block"] {
            display: flex !important;
        }

        /* Booking Modal Styles */
        .booking-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .booking-modal.active {
            display: flex;
        }

        .booking-modal-content {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .booking-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .booking-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .booking-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-color);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .booking-close:hover {
            background-color: rgba(108, 99, 255, 0.1);
        }

        .ride-info-card {
            background: rgba(108, 99, 255, 0.05);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(108, 99, 255, 0.1);
        }

        .ride-info-driver {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ride-info-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .ride-info-details {
            flex: 1;
        }

        .ride-info-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .ride-info-rating {
            font-size: 0.875rem;
            opacity: 0.7;
        }

        .ride-info-route {
            margin-bottom: 0.5rem;
        }

        .ride-info-price {
            font-weight: 600;
            color: var(--primary-color);
        }

        .address-section {
            margin-bottom: 1.5rem;
        }

        .address-section-title {
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--ai-dark);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .booking-form-group {
            position: relative;
            margin-bottom: 1rem;
        }

        .booking-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .booking-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .booking-buttons .btn {
            flex: 1;
        }

        /* Review System Styles */
        .review-category {
            padding: 1rem;
            background: rgba(108, 99, 255, 0.02);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .star-rating {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .star-rating .star {
            color: #e5e5e5;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1.25rem;
        }

        .star-rating .star:hover,
        .star-rating .star.active {
            color: var(--warning-color);
            transform: scale(1.1);
        }

        .star-rating .star:hover ~ .star {
            color: #e5e5e5;
        }

        /* Request Management Styles */
        .request-filter-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .request-filter-tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .notification-badge {
            background: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            margin-left: 0.25rem;
        }

        .request-item {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .request-item.pending {
            border-left: 4px solid var(--warning-color);
        }

        .request-item.accepted {
            border-left: 4px solid var(--success-color);
        }

        .request-item.declined {
            border-left: 4px solid #dc3545;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .request-passenger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .passenger-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .passenger-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .passenger-rating {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .request-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .request-status.pending {
            background: rgba(237, 137, 54, 0.1);
            color: var(--warning-color);
        }

        .request-status.accepted {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }

        .request-status.declined {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .request-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .request-details > div {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .request-earnings {
            color: var(--primary-color);
            font-weight: 600;
            grid-column: 1 / -1;
        }

        .request-special {
            background: rgba(108, 99, 255, 0.05);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Earnings Styles */
        .earnings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .earnings-card {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 1rem;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .earnings-amount {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .earnings-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .earnings-change {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .earnings-change.positive {
            color: #4ade80;
        }

        .earnings-change.negative {
            color: #f87171;
        }

        .earnings-change.neutral {
            opacity: 0.5;
        }

        .earnings-list {
            background: rgba(108, 99, 255, 0.02);
            border-radius: 12px;
            overflow: hidden;
        }

        .earnings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .earnings-item:last-child {
            border-bottom: none;
        }

        .earnings-item-route {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .earnings-item-date {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .earnings-item-amount {
            font-weight: 700;
            color: var(--success-color);
        }
        
        /* Payout Section Styles */
        .payout-section {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(108, 99, 255, 0.05), rgba(79, 209, 197, 0.05));
            border-radius: 16px;
            border: 1px solid rgba(108, 99, 255, 0.1);
        }
        
        .payout-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .payout-info .payout-amount .amount {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
        }
        
        .payout-info .available-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .payout-schedule {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #888;
        }
        
        .payout-btn {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .payout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .payout-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
        }
        
        /* Payment Method Styles */
        .payment-method-section {
            margin-top: 1.5rem;
        }
        
        .payment-method-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .payment-toggle {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }
        
        .payment-mode-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-mode-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            color: var(--primary-color);
        }
        
        /* Earnings History Additional Styles */
        .earnings-history, .payout-history {
            margin: 1.5rem 0;
        }
        
        .earnings-filter {
            margin-bottom: 1rem;
        }
        
        .earnings-filter select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
        }
        
        .earnings-item.payout-item {
            background: rgba(255, 165, 0, 0.05);
            border-color: rgba(255, 165, 0, 0.2);
        }
        
        .earnings-item-info .ride-details strong {
            color: var(--primary-color);
        }
        
        .earnings-item-info .ride-date, .payout-date {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .earnings-item-info .passenger-info {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .earnings-amount.payout {
            color: #ff9800;
        }
        
        .payout-history-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .payout-amount {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .payout-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.8rem;
        }
        
        .payout-status.completed {
            color: var(--success-color);
        }

        /* Rating Cards Styles */
        #ratings-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .rating-card {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 16px;
            padding: 1.25rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            text-align: left;
        }

        .rating-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .rating-overview {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .rating-score {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-right: 1rem;
        }

        .rating-stars {
            font-size: 1.25rem;
            color: var(--warning-color);
            margin-right: 1rem;
        }

        .rating-count {
            font-size: 0.875rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .rating-categories {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .rating-category {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-name {
            font-size: 0.875rem;
            width: 110px;
            flex-shrink: 0;
        }

        .category-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            flex: 1;
            overflow: hidden;
        }

        .category-fill {
            height: 100%;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            border-radius: 4px;
        }

        .category-score {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary-color);
            width: 30px;
            text-align: right;
        }

        .view-reviews-btn {
            width: 100%;
            margin-top: 0.5rem;
        }

        /* Chat Modal Styles */
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chat-message {
            max-width: 70%;
            padding: 0.75rem;
            border-radius: 12px;
            position: relative;
        }

        .chat-message.sent {
            align-self: flex-end;
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.received {
            align-self: flex-start;
            background: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
        }

        .message-content {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 0.25rem;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
        }

        .chat-message.received .message-time {
            text-align: left;
        }

        /* Reviews Modal Styles */
        .reviews-modal-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .reviews-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .reviews-modal-header h3 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0;
            color: var(--primary-color);
        }

        .reviews-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .review-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid var(--border-color);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .reviewer-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .review-date {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .review-rating {
            color: var(--warning-color);
            font-weight: 600;
        }

        .review-categories {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .review-category-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
        }

        .review-category-name {
            width: 100px;
            flex-shrink: 0;
        }

        .review-category-bar {
            height: 6px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
            flex: 1;
            overflow: hidden;
        }

        .review-category-fill {
            height: 100%;
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            border-radius: 3px;
        }

        .review-category-score {
            font-weight: 600;
            width: 30px;
            text-align: right;
        }

        .review-comment {
            font-style: italic;
            background: rgba(255, 255, 255, 0.5);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        /* Stops Styles */
        .stop-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .stop-number {
            width: 24px;
            height: 24px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .stop-input {
            flex: 1;
            border: none;
            background: none;
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .stop-input:focus {
            outline: none;
        }

        .stop-remove {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .stop-remove:hover {
            background: rgba(220, 53, 69, 0.1);
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Start Page -->
        <div id="start-page" class="welcome-container">
            <div class="floating-shapes">
                <div class="shape shape-1"></div>
                <div class="shape shape-2"></div>
                <div class="shape shape-3"></div>
            </div>
            <div class="welcome-logo">
                <i class="fas fa-car"></i>
            </div>
            <h1 class="welcome-title">OnGoPool</h1>
            <p class="welcome-subtitle">Share rides, save money, and reduce your carbon footprint with AI-powered matching</p>
            <div class="welcome-buttons">
                <button class="btn btn-primary btn-full" onclick="showPage('login-page')">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>

                <button class="btn btn-secondary btn-full" onclick="showPage('signup-page')">
                    <i class="fas fa-user-plus"></i> Sign Up
                </button>
                
                <!-- Admin functionality moved to database management -->
                <button class="btn btn-secondary btn-full" onclick="window.open('https://supabase.com/dashboard/project/efjwsdxgelbgthcyltjr', '_blank')" style="margin-top: 0.5rem;">
                    <i class="fas fa-database"></i> Database Admin
                </button>
            </div>
        </div>

        <!-- Admin login removed - use Supabase dashboard for admin functions -->

        <!-- Login Page -->
        <div id="login-page" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="auth-logo">
                    <i class="fas fa-car"></i>
                </div>
                <h2 class="auth-title">Log In to OnGoPool</h2>
                <form class="auth-form" onsubmit="loginUser(event)">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="login-email" placeholder="Your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="login-password" placeholder="Your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-sign-in-alt"></i> Log In
                    </button>
                </form>
                <a href="#" class="auth-link" onclick="showPage('signup-page')">Don't have an account? Sign up</a>
                <a href="#" class="auth-link" onclick="showPage('start-page')">Back to welcome page</a>
            </div>
        </div>

        <!-- Signup Page -->
        <div id="signup-page" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="auth-logo">
                    <i class="fas fa-car"></i>
                </div>
                <h2 class="auth-title">Create an Account</h2>
                <form class="auth-form" onsubmit="signupUser(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="signup-name" placeholder="Your full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="signup-email" placeholder="Your email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="signup-phone" placeholder="Your phone number" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="signup-password" placeholder="Create a password" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" class="form-input" id="signup-confirm-password" placeholder="Confirm your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        <i class="fas fa-user-plus"></i> Sign Up
                    </button>
                </form>
                <a href="#" class="auth-link" onclick="showPage('login-page')">Already have an account? Log in</a>
                <a href="#" class="auth-link" onclick="showPage('start-page')">Back to welcome page</a>
            </div>
        </div>

        <!-- Main App (initially hidden) -->
        <div id="main-app" style="display: none;">
            <header class="header">
                <h1><i class="fas fa-car"></i> OnGoPool</h1>
            </header>

            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </button>
                <button class="nav-tab" data-tab="find-rides">
                    <i class="fas fa-search"></i>
                    <span>Find</span>
                </button>
                <button class="nav-tab" data-tab="post-ride">
                    <i class="fas fa-plus-circle"></i>
                    <span>Post</span>
                </button>
                <button class="nav-tab" data-tab="my-rides">
                    <i class="fas fa-route"></i>
                    <span>My Rides</span>
                </button>
                <button class="nav-tab" data-tab="profile">
                    <i class="fas fa-user-circle"></i>
                    <span>Profile</span>
                </button>
                <button class="nav-tab" data-tab="earnings" id="earnings-nav" style="display: none;">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Earnings</span>
                </button>
            </nav>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <!-- Passenger Dashboard -->
                <div id="passenger-dashboard" class="card">
                    <h2><i class="fas fa-chart-line"></i> Dashboard</h2>
                    <p>Welcome to OnGoPool! Our AI helps you find perfect ride matches.</p>
                
                <!-- Driver Dashboard -->
                <div id="driver-dashboard" class="card" style="display: none;">
                    <h2><i class="fas fa-car"></i> Driver Dashboard</h2>
                    <p>Manage your rides and view incoming booking requests.</p>
                    
                    <!-- Ride Requests Management -->
                    <div class="card" style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3><i class="fas fa-bell"></i> Ride Requests</h3>
                            <button class="btn btn-sm btn-outline" onclick="loadMyRidesFromDatabase()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        
                        <!-- Filter Tabs -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                            <button class="request-filter-tab active" data-filter="pending" onclick="filterRequests('pending')">
                                Pending <span class="notification-badge" id="pending-count">2</span>
                            </button>
                            <button class="request-filter-tab" data-filter="accepted" onclick="filterRequests('accepted')">
                                Accepted <span class="notification-badge" id="accepted-count">1</span>
                            </button>
                            <button class="request-filter-tab" data-filter="declined" onclick="filterRequests('declined')">
                                Declined <span class="notification-badge" id="declined-count">0</span>
                            </button>
                        </div>
                        
                        <div id="booking-requests-list">
                            <!-- Pending Requests -->
                            <div class="request-item pending" data-status="pending">
                                <div class="request-header">
                                    <div class="request-passenger">
                                        <div class="passenger-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="passenger-info">
                                            <div class="passenger-name" id="dashboard-passenger-name">Loading...</div>
                                            <div class="passenger-rating" id="dashboard-passenger-rating">Loading...</div>
                                        </div>
                                    </div>
                                    <div class="request-status pending">
                                        <i class="fas fa-clock"></i> Pending
                                    </div>
                                </div>
                                
                                <div class="request-details" id="request-details-section">
                                    <!-- Dynamic request details loaded from database -->
                                </div>
                                
                                <div class="request-special" style="display: none;">
                                    <div class="special-requests">
                                        <strong>Special Requests:</strong> "Need help with luggage, traveling with small child"
                                    </div>
                                </div>
                                
                                <div class="request-actions">
                                    <button class="btn btn-sm btn-outline" onclick="toggleRequestDetails(this)">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="acceptBookingRequest('request-1', this)">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="declineBookingRequest('request-1', this)">
                                        <i class="fas fa-times"></i> Decline
                                    </button>
                                </div>
                            </div>
                            
                            <div class="request-item pending" data-status="pending">
                                <div class="request-header">
                                    <div class="request-passenger">
                                        <div id="dashboard-recent-passengers">
                                            <!-- Dynamic passenger data from database -->
                                        </div>
                                    </div>
                                    <div class="request-status pending">
                                        <i class="fas fa-clock"></i> Pending
                                    </div>
                                </div>
                                
                                <div class="request-details" id="additional-request-details">
                                    <!-- Dynamic additional request details loaded from database -->
                                </div>
                                
                                <div class="request-special" style="display: none;">
                                    <div class="special-requests">
                                        <strong>Special Requests:</strong> None
                                    </div>
                                </div>
                                
                                <div class="request-actions">
                                    <button class="btn btn-sm btn-outline" onclick="toggleRequestDetails(this)">
                                        <i class="fas fa-eye"></i> View Details
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="acceptBookingRequest('request-2', this)">
                                        <i class="fas fa-check"></i> Accept
                                    </button>
                                    <button class="btn btn-sm btn-secondary" onclick="declineBookingRequest('request-2', this)">
                                        <i class="fas fa-times"></i> Decline
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Accepted Requests (hidden by default) -->
                            <div class="request-item accepted" data-status="accepted" style="display: none;">
                                <div class="request-header">
                                    <div class="request-passenger">
                                        <div class="passenger-avatar">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="passenger-info">
                                            <div class="passenger-name">Emma K.</div>
                                            <div class="passenger-rating">4.9 ⭐ (31 rides)</div>
                                        </div>
                                    </div>
                                    <div class="request-status accepted">
                                        <i class="fas fa-check-circle"></i> Accepted
                                    </div>
                                </div>
                                
                                <div class="request-details">
                                    <div class="request-route">
                                        <i class="fas fa-route"></i> Central → Beach
                                    </div>
                                    <div class="request-datetime">
                                        <i class="fas fa-calendar"></i> Today, 4:00 PM
                                    </div>
                                    <div class="request-seats">
                                        <i class="fas fa-users"></i> 1 seat confirmed
                                    </div>
                                    <div class="request-earnings">
                                        <i class="fas fa-dollar-sign"></i> Earnings: $13.20 (after platform fee)
                                    </div>
                                </div>
                                
                                <div class="request-actions">
                                    <button class="btn btn-sm btn-primary" onclick="contactPassenger('Emma K.')">
                                        <i class="fas fa-phone"></i> Contact
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="cancelAcceptedBooking('request-3')">
                                        <i class="fas fa-ban"></i> Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <div id="no-requests" style="text-align: center; padding: 2rem; color: #999; display: none;">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <div>No requests in this category</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem;">Requests will appear here when passengers book your rides.</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Earnings Overview -->
                    <div class="card" style="margin-top: 1rem;">
                        <h3><i class="fas fa-chart-line"></i> Earnings Overview</h3>
                        
                        <div class="earnings-grid">
                            <div class="earnings-card">
                                <div class="earnings-amount">$247.50</div>
                                <div class="earnings-label">This Week</div>
                                <div class="earnings-change positive">+12.5%</div>
                            </div>
                            <div class="earnings-card">
                                <div class="earnings-amount">$1,024.80</div>
                                <div class="earnings-label">This Month</div>
                                <div class="earnings-change positive">+8.3%</div>
                            </div>
                            <div class="earnings-card">
                                <div class="earnings-amount">$45.75</div>
                                <div class="earnings-label">Today</div>
                                <div class="earnings-change neutral">--</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.75rem;">Recent Earnings</h4>
                            <div class="earnings-list">
                                <div class="earnings-item">
                                    <div class="earnings-item-info">
                                        <div class="earnings-item-route" id="dashboard-recent-earning-route">Loading...</div>
                                        <div class="earnings-item-date" id="dashboard-recent-earning-date">Loading...</div>
                                    </div>
                                    <div class="earnings-item-amount" id="dashboard-recent-earning-amount">+$0.00</div>
                                </div>
                                <div class="earnings-item">
                                    <div id="dashboard-recent-earnings">
                                        <!-- Dynamic earnings data from database -->
                                    </div>
                                </div>
                                <div id="additional-earnings-data">
                                    <!-- Additional dynamic earnings from database -->
                                </div>
                            </div>
                            
                            <button class="btn btn-outline btn-full" style="margin-top: 1rem;" onclick="viewDetailedEarnings()">
                                <i class="fas fa-chart-bar"></i> View Detailed Earnings Report
                            </button>
                        </div>
                    </div>
                </div>
                    
                    <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #6C63FF, #7F78FF); padding: 1rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.8rem; opacity: 0.8;">CO₂ Saved</div>
                            <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem;">47.2 kg</div>
                        </div>
                        
                        <div style="flex: 1; min-width: 120px; background: linear-gradient(135deg, #4FD1C5, #38B2AC); padding: 1rem; border-radius: 12px; color: white;">
                            <div style="font-size: 0.8rem; opacity: 0.8;">Total Rides</div>
                            <div style="font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem;">8</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-bolt" style="color: var(--primary-color);"></i> 
                        Recommended Rides
                    </h3>
                    
                    <div id="dashboard-recommended-rides-1">
                        <!-- Dynamic recommended rides from database -->
                    </div>
                    
                    <div id="dashboard-recommended-rides-2">
                        <!-- Additional dynamic recommended rides from database -->
                    </div>
                </div>
            </div>

            <!-- Find Rides Tab -->
            <div id="find-rides" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-search"></i> Find Rides</h2>
                    <p>Search for available rides with OpenStreetMap integration.</p>
                    
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <input type="text" id="find-from" class="form-input" placeholder="Enter pickup location">
                        <div id="find-from-suggestions" class="address-suggestions"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">To</label>
                        <input type="text" id="find-to" class="form-input" placeholder="Enter destination">
                        <div id="find-to-suggestions" class="address-suggestions"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" id="find-date" class="form-input">
                    </div>
                    
                    <!-- Map Container -->
                    <div class="form-group">
                        <label class="form-label">Route Preview</label>
                        <div id="find-map" style="height: 200px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);"></div>
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="searchRides()">
                        <i class="fas fa-search"></i> Search Rides
                    </button>
                </div>
                
                <div class="card" id="search-results" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Available Rides</h3>
                    <div id="ride-results"></div>
                </div>
            </div>

            <!-- Post Ride Tab -->
            <div id="post-ride" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> Post a Ride</h2>
                    <p>Offer a ride and earn money while helping the environment.</p>
                    
                    <div class="form-group">
                        <label class="form-label">From</label>
                        <input type="text" id="post-from" class="form-input" placeholder="Enter pickup location">
                        <div id="post-from-suggestions" class="address-suggestions"></div>
                    </div>
                    
                    <!-- Intermediate Stops -->
                    <div class="form-group">
                        <label class="form-label">Stops (Optional)</label>
                        <div style="background: var(--light-bg-color); padding: 1rem; border-radius: 12px; border: 2px solid var(--border-color);">
                            <div style="margin-bottom: 0.75rem; color: var(--text-color); font-size: 0.9rem;">
                                <i class="fas fa-info-circle"></i> Add convenient stops along your route to attract more passengers
                            </div>
                            
                            <div id="stops-container">
                                <!-- Stops will be dynamically added here -->
                            </div>
                            
                            <button type="button" class="btn btn-outline btn-full" onclick="addStop()" style="margin-top: 0.5rem;">
                                <i class="fas fa-plus"></i> Add Stop
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">To (Final Destination)</label>
                        <input type="text" id="post-to" class="form-input" placeholder="Enter final destination">
                        <div id="post-to-suggestions" class="address-suggestions"></div>
                    </div>
                    
                    <!-- Map Container -->
                    <div class="form-group">
                        <label class="form-label">Route Preview</label>
                        <div id="post-map" style="height: 200px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-color);"></div>
                        <div id="route-info" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-color); background: rgba(108, 99, 255, 0.05); padding: 0.75rem; border-radius: 8px; display: none;">
                            <div><strong>Distance:</strong> <span id="route-distance">-</span> km</div>
                            <div><strong>Estimated Time:</strong> <span id="route-time">-</span> minutes</div>
                            <div><strong>Suggested Price:</strong> $<span id="suggested-price">0.00</span> per seat</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Date</label>
                            <input type="date" id="post-date" class="form-input" onchange="validateFutureDate()">
                            <div id="date-limit-info" style="font-size: 0.75rem; color: var(--text-color); opacity: 0.7; margin-top: 0.25rem;">
                                Maximum 30 days in advance
                            </div>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Time</label>
                            <select id="post-time" class="form-input">
                                <option value="">Select time</option>
                                <option value="12:00">12:00 AM</option>
                                <option value="12:30">12:30 AM</option>
                                <option value="01:00">1:00 AM</option>
                                <option value="01:30">1:30 AM</option>
                                <option value="02:00">2:00 AM</option>
                                <option value="02:30">2:30 AM</option>
                                <option value="03:00">3:00 AM</option>
                                <option value="03:30">3:30 AM</option>
                                <option value="04:00">4:00 AM</option>
                                <option value="04:30">4:30 AM</option>
                                <option value="05:00">5:00 AM</option>
                                <option value="05:30">5:30 AM</option>
                                <option value="06:00">6:00 AM</option>
                                <option value="06:30">6:30 AM</option>
                                <option value="07:00">7:00 AM</option>
                                <option value="07:30">7:30 AM</option>
                                <option value="08:00">8:00 AM</option>
                                <option value="08:30">8:30 AM</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="09:30">9:30 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="10:30">10:30 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="11:30">11:30 AM</option>
                                <option value="12:00">12:00 PM</option>
                                <option value="12:30">12:30 PM</option>
                                <option value="13:00">1:00 PM</option>
                                <option value="13:30">1:30 PM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="14:30">2:30 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="15:30">3:30 PM</option>
                                <option value="16:00">4:00 PM</option>
                                <option value="16:30">4:30 PM</option>
                                <option value="17:00">5:00 PM</option>
                                <option value="17:30">5:30 PM</option>
                                <option value="18:00">6:00 PM</option>
                                <option value="18:30">6:30 PM</option>
                                <option value="19:00">7:00 PM</option>
                                <option value="19:30">7:30 PM</option>
                                <option value="20:00">8:00 PM</option>
                                <option value="20:30">8:30 PM</option>
                                <option value="21:00">9:00 PM</option>
                                <option value="21:30">9:30 PM</option>
                                <option value="22:00">10:00 PM</option>
                                <option value="22:30">10:30 PM</option>
                                <option value="23:00">11:00 PM</option>
                                <option value="23:30">11:30 PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Available Seats</label>
                            <select id="post-seats" class="form-input">
                                <option value="1">1 seat</option>
                                <option value="2">2 seats</option>
                                <option value="3">3 seats</option>
                                <option value="4">4 seats</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Price per seat: $<span id="price-display">5.00</span></label>
                            <input type="range" id="price-slider" class="price-slider" min="0" max="50" value="5" step="0.01">
                            <div class="slider-range-display" style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-color); opacity: 0.7; margin-top: 0.25rem;">
                                <span>$0.00</span>
                                <span>$50.00</span>
                            </div>
                            <div id="price-validation-message" style="font-size: 0.75rem; margin-top: 0.5rem; display: none;"></div>
                        </div>
                    </div>
                    
                    <div id="price-breakdown" style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; display: none;">
                        <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">Price Breakdown (per seat)</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Driver Portion:</span>
                            <span>$<span id="driver-portion">4.40</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                            <span>Service Fee (12%):</span>
                            <span>$<span id="service-fee">0.60</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem;">
                            <span>Total Price:</span>
                            <span>$<span id="total-price">5.00</span></span>
                        </div>
                        <div style="font-size: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; background: rgba(255, 255, 255, 0.7); border-radius: 6px; color: var(--text-color);">
                            <strong>Platform Limits:</strong> $0.15 - $0.25 per seat per km (including service fee)
                        </div>
                    </div>
                    
                    <!-- Additional notes section -->

                    <div class="form-group">
                        <label class="form-label">Additional Notes</label>
                        <textarea id="post-notes" class="form-input" rows="3" placeholder="Any additional information for passengers..."></textarea>
                    </div>
                    
                    <div id="license-verification-warning" style="background: rgba(237, 137, 54, 0.1); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid var(--warning-color); display: none;">
                        <div style="display: flex; align-items: flex-start; gap: 1rem;">
                            <div style="color: var(--warning-color); font-size: 1.5rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--warning-color);">License Verification Required</div>
                                <div style="font-size: 0.9rem;">
                                    You must verify your driver's license before posting rides. Please go to your profile and complete the verification process.
                                </div>
                                <button class="btn btn-warning" style="margin-top: 1rem;" onclick="switchTab('profile')">
                                    <i class="fas fa-id-card"></i> Go to Profile
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button id="post-ride-btn" class="btn btn-primary btn-full" onclick="postRide()">
                        <i class="fas fa-plus"></i> Post Ride
                    </button>
                </div>
            </div>

            <!-- My Rides Tab -->
            <div id="my-rides" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-route"></i> My Rides</h2>
                    <p>Manage your offered and booked rides.</p>
                    
                    <!-- Top Navigation Tabs -->
                    <div class="ride-nav-tabs" style="display: flex; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); gap: 0.5rem;">
                        <button id="driver-tab" onclick="switchRideView('driver')" class="ride-tab active" style="flex: 1; padding: 0.75rem; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--primary-color); border-bottom: 2px solid var(--primary-color);">
                            <i class="fas fa-car"></i> As Driver
                        </button>
                        <button id="passenger-tab" onclick="switchRideView('passenger')" class="ride-tab" style="flex: 1; padding: 0.75rem; border: none; background: transparent; cursor: pointer; font-weight: 600; color: var(--text-color); opacity: 0.7;">
                            <i class="fas fa-user"></i> As Passenger
                        </button>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div id="rides-filter-section" style="background: rgba(240, 240, 245, 0.3); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <h4 style="margin: 0; color: var(--text-color);"><i class="fas fa-filter"></i> Filter Rides</h4>
                            <button onclick="clearAllFilters()" style="background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                                <i class="fas fa-times"></i> Clear All
                            </button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <!-- Date Range Picker -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-color); margin-bottom: 0.5rem; display: block;">Date From</label>
                                <input type="date" id="filter-date-from" onchange="applyFilters()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: white;">
                            </div>
                            
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-color); margin-bottom: 0.5rem; display: block;">Date To</label>
                                <input type="date" id="filter-date-to" onchange="applyFilters()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: white;">
                            </div>
                            
                            <!-- Status Filter -->
                            <div>
                                <label style="font-size: 0.85rem; font-weight: 600; color: var(--text-color); margin-bottom: 0.5rem; display: block;">Ride Status</label>
                                <select id="filter-status" onchange="applyFilters()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: white;">
                                    <option value="all">All Status</option>
                                    <option value="upcoming">Upcoming</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="pending">Pending Approval</option>
                                    <option value="confirmed">Confirmed</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Active Filters Display -->
                        <div id="active-filters" style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                    </div>
                    
                    <!-- Removed demo buttons - now using real-time database only -->
                    
                    <!-- Ride Requests Section for Drivers -->
                    <div id="ride-requests-section" style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-inbox"></i> Ride Requests 
                            <span id="pending-request-count" style="background: var(--primary-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">2 pending</span>
                        </h3>
                        
                        <div id="driver-requests-container">
                            <div id="ride-requests-dynamic-container">
                                <!-- Dynamic ride requests will be loaded from database -->
                            </div>
                        </div>
                        
                        <div id="no-driver-requests" style="display: none; text-align: center; padding: 2rem 1rem; background: var(--light-bg-color); border-radius: 8px;">
                            <i class="fas fa-inbox-out" style="font-size: 2rem; color: var(--border-color); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-color); opacity: 0.7;">No pending ride requests at the moment</p>
                        </div>
                    </div>
                    
                    <!-- All Rides Container (will be dynamically populated) -->
                    <div id="all-rides-container">
                        <!-- Filtered rides will appear here -->
                    </div>
                    
                    <div id="offered-rides-section" style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-car"></i> My Offered Rides
                            <span id="offered-rides-count" style="background: var(--primary-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">1 active</span>
                        </h3>
                        
                        <div id="driver-rides-container">
                            <div id="offered-rides-dynamic-container">
                                <!-- Dynamic offered rides will be loaded from database -->
                            </div>
                        </div>
                        
                        <div id="no-offered-rides" style="display: none; text-align: center; padding: 2rem 1rem; background: var(--light-bg-color); border-radius: 8px;">
                            <i class="fas fa-car" style="font-size: 2rem; color: var(--border-color); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-color); opacity: 0.7;">You haven't offered any rides yet</p>
                            <button onclick="switchTab('post-ride')" style="background: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; margin-top: 1rem; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-plus"></i> Offer a Ride
                            </button>
                        </div>
                    </div>
                    
                    <div id="passenger-requests-section" style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-paper-plane"></i> My Ride Requests 
                            <span id="my-request-count" style="background: var(--warning-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">1 pending</span>
                        </h3>
                        
                        <div id="passenger-requests-container">
                            <div id="passenger-requests-dynamic-container">
                                <!-- Dynamic passenger requests will be loaded from database -->
                            </div>
                        </div>
                        
                        <div id="no-passenger-requests" style="display: none; text-align: center; padding: 2rem 1rem; background: var(--light-bg-color); border-radius: 8px;">
                            <i class="fas fa-paper-plane" style="font-size: 2rem; color: var(--border-color); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-color); opacity: 0.7;">You haven't requested any rides yet</p>
                        </div>
                    </div>
                    
                    <div id="booked-rides-section" style="margin-bottom: 1.5rem;">
                        <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-ticket-alt"></i> My Booked Rides
                            <span id="booked-rides-count" style="background: var(--accent-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">1 confirmed</span>
                        </h3>
                        
                        <div id="passenger-rides-container">
                            <div id="booked-rides-dynamic-container">
                                <!-- Dynamic booked rides will be loaded from database -->
                            </div>
                        </div>
                        
                        <div id="no-booked-rides" style="display: none; text-align: center; padding: 2rem 1rem; background: var(--light-bg-color); border-radius: 8px;">
                            <i class="fas fa-ticket-alt" style="font-size: 2rem; color: var(--border-color); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-color); opacity: 0.7;">You haven't booked any rides yet</p>
                            <button onclick="switchTab('find-rides')" style="background: var(--accent-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; margin-top: 1rem; cursor: pointer; font-weight: 500;">
                                <i class="fas fa-search"></i> Find Rides
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Tab -->
            <div id="profile" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-user-circle"></i> Profile</h2>
                    <p>Manage your account settings and preferences.</p>
                    
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3 style="margin-bottom: 0.5rem;" id="profile-name-display">Loading...</h3>
                        
                        <!-- Enhanced Ratings Display Section -->
                        <div id="ratings-container">
                            <!-- Passenger Rating Card -->
                            <div id="passenger-rating-card" class="rating-card">
                                <div class="rating-header">
                                    <i class="fas fa-user"></i> Passenger Rating
                                </div>
                                <div class="rating-overview">
                                    <div class="rating-score" id="passenger-rating-score">0.0</div>
                                    <div class="rating-stars" id="passenger-rating-stars">⭐⭐⭐⭐⭐</div>
                                    <div class="rating-count" id="passenger-rides-count">Based on 0 rides</div>
                                </div>
                                <div class="rating-categories">
                                    <div class="rating-category">
                                        <span class="category-name">Punctuality</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 92%;"></div>
                                        </div>
                                        <span class="category-score">4.6</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Friendliness</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 98%;"></div>
                                        </div>
                                        <span class="category-score">4.9</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Communication</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 90%;"></div>
                                        </div>
                                        <span class="category-score">4.5</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Respectfulness</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 96%;"></div>
                                        </div>
                                        <span class="category-score">4.8</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline view-reviews-btn" onclick="viewAllReviews('passenger')">
                                    <i class="fas fa-comment-alt"></i> View all reviews
                                </button>
                            </div>
                            
                            <!-- Driver Rating Card -->
                            <div id="driver-rating-card" class="rating-card" style="display: none;">
                                <div class="rating-header">
                                    <i class="fas fa-car"></i> Driver Rating
                                </div>
                                <div class="rating-overview">
                                    <div class="rating-score" id="driver-rating-score">0.0</div>
                                    <div class="rating-stars" id="driver-rating-stars">⭐⭐⭐⭐⭐</div>
                                    <div class="rating-count" id="driver-rides-count">Based on 0 rides</div>
                                </div>
                                <div class="rating-categories">
                                    <div class="rating-category">
                                        <span class="category-name">Driving Safety</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 98%;"></div>
                                        </div>
                                        <span class="category-score">4.9</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Car Cleanliness</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 100%;"></div>
                                        </div>
                                        <span class="category-score">5.0</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Punctuality</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 94%;"></div>
                                        </div>
                                        <span class="category-score">4.7</span>
                                    </div>
                                    <div class="rating-category">
                                        <span class="category-name">Communication</span>
                                        <div class="category-bar">
                                            <div class="category-fill" style="width: 96%;"></div>
                                        </div>
                                        <span class="category-score">4.8</span>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline view-reviews-btn" onclick="viewAllReviews('driver')">
                                    <i class="fas fa-comment-alt"></i> View all reviews
                                </button>
                            </div>
                        </div>
                        
                        <!-- Legacy rating divs (kept for compatibility) -->
                        <div id="passenger-rating" style="display: none;">4.7 ⭐ Passenger Rating</div>
                        <div id="driver-rating" style="display: none;">4.9 ⭐ Driver Rating</div>
                        
                        <div id="license-status" style="font-size: 0.8rem; margin-top: 0.5rem; display: none;">
                            <i class="fas fa-exclamation-triangle"></i> <span id="license-status-text">License verification pending</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="profile-fullname">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="profile-email" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-input" id="profile-phone">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">User Type</label>
                        <div style="background: var(--light-bg-color); padding: 1rem; border-radius: 12px; border: 2px solid var(--border-color);">
                            <div style="margin-bottom: 1rem; text-align: center; color: var(--primary-color); font-weight: 600;">
                                <i class="fas fa-exchange-alt"></i> Choose your mode
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;" id="user-type-toggle">
                                <button type="button" class="user-type-btn" data-type="passenger" onclick="selectUserType('passenger')">
                                    <i class="fas fa-user"></i>
                                    <span>Passenger</span>
                                </button>
                                <button type="button" class="user-type-btn" data-type="driver" onclick="selectUserType('driver')">
                                    <i class="fas fa-car"></i>
                                    <span>Driver</span>
                                </button>
                                <button type="button" class="user-type-btn" data-type="both" onclick="selectUserType('both')">
                                    <i class="fas fa-users"></i>
                                    <span>Both</span>
                                </button>
                            </div>
                            <div style="margin-top: 1rem; text-align: center; font-size: 0.85rem; color: #666;">
                                <span id="user-type-description">Select how you want to use OnGoPool</span>
                            </div>
                        </div>
                        <input type="hidden" id="user-type" value="passenger">
                    </div>
                    
                    <div id="driver-fields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Car Model</label>
                            <input type="text" class="form-input" id="car-model" value="" placeholder="Enter your car model">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Driver License Verification</label>
                            <div style="background: var(--light-bg-color); padding: 1rem; border-radius: 12px; border: 2px solid var(--border-color);">
                                <div style="margin-bottom: 1rem; color: var(--primary-color);">
                                    <i class="fas fa-id-card"></i> Verification required to post rides
                                </div>
                                
                                <div id="license-verification-status" style="padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;">
                                    <div id="license-status-message"></div>
                                    <div id="license-expiry-info" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
                                </div>

                                <div id="license-verification-form">
                                    <div class="form-group">
                                        <label class="form-label">Province/Territory</label>
                                        <select id="license-province" class="form-input">
                                            <option value="">Select Province/Territory</option>
                                            <option value="AB">Alberta</option>
                                            <option value="BC">British Columbia</option>
                                            <option value="MB">Manitoba</option>
                                            <option value="NB">New Brunswick</option>
                                            <option value="NL">Newfoundland and Labrador</option>
                                            <option value="NS">Nova Scotia</option>
                                            <option value="NT">Northwest Territories</option>
                                            <option value="NU">Nunavut</option>
                                            <option value="ON">Ontario</option>
                                            <option value="PE">Prince Edward Island</option>
                                            <option value="QC">Quebec</option>
                                            <option value="SK">Saskatchewan</option>
                                            <option value="YT">Yukon</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">License Number</label>
                                        <input type="text" id="license-number" class="form-input" placeholder="Enter your license number">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">License Expiry Date</label>
                                        <input type="date" id="license-expiry" class="form-input">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Upload License Image</label>
                                        <input type="file" id="license-image" class="form-input" accept="image/*">
                                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                                            Please upload a clear image of your driver's license. Both sides are required.
                                        </div>
                                    </div>
                                    
                                    <button class="btn btn-primary btn-full" onclick="verifyLicense()">
                                        <i class="fas fa-check-circle"></i> Submit for Verification
                                    </button>
                                </div>
                                
                                <div style="font-size: 0.8rem; color: #666; margin-top: 1rem; text-align: center;">
                                    Your license information is securely stored and will only be used for verification purposes.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="updateUserProfile()" style="flex: 1;">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                        
                        <button class="btn btn-secondary" onclick="logoutUser()" style="flex: 1;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Earnings Tab -->
            <div id="earnings" class="tab-content" style="padding: 0.5rem 1.25rem 1.25rem 1.25rem;">
                <div class="card" style="margin-top: 0; margin-bottom: 0.5rem; padding: 1rem; padding-top: 0.75rem;">
                    <h2 style="margin-top: 0; margin-bottom: 0.5rem;"><i class="fas fa-dollar-sign"></i> Driver Earnings</h2>
                    <p style="margin-bottom: 1rem;">Track your earnings and manage weekly payouts</p>
                    
                    <!-- Quick Stats -->
                    <div class="earnings-grid" style="margin-bottom: 2rem;">
                        <div class="earnings-card">
                            <div class="earnings-amount">$247.50</div>
                            <div class="earnings-label">This Week</div>
                            <div class="earnings-change positive">+12.5%</div>
                        </div>
                        <div class="earnings-card">
                            <div class="earnings-amount">$1,024.80</div>
                            <div class="earnings-label">This Month</div>
                            <div class="earnings-change positive">+8.3%</div>
                        </div>
                    </div>
                    
                    <!-- Payout Section -->
                    <div class="payout-section">
                        <h3><i class="fas fa-money-check-alt"></i> Weekly Payout</h3>
                        <div class="payout-card">
                            <div class="payout-info">
                                <div class="payout-amount">
                                    <span class="amount">$247.50</span>
                                    <span class="available-label">Available for payout</span>
                                </div>
                                <div class="payout-schedule">
                                    <i class="fas fa-calendar"></i>
                                    <span>Next payout available: Monday, Dec 18</span>
                                </div>
                            </div>
                            <button class="payout-btn" id="payout-btn" onclick="initiatePayout()" disabled>
                                <i class="fas fa-arrow-circle-down"></i>
                                Request Payout
                            </button>
                        </div>
                        
                        <div class="payout-schedule-text">
                            <p><i class="fas fa-info-circle"></i> Payouts are processed every Monday for the previous week's earnings. Minimum payout amount is $25.</p>
                        </div>
                    </div>
                    
                    <!-- Earnings History -->
                    <div class="earnings-history">
                        <h3><i class="fas fa-history"></i> Recent Earnings</h3>
                        <div class="earnings-list">
                            <div id="earnings-history-container">
                                <!-- Dynamic earnings history will be loaded from database -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Modal -->
        <div id="booking-modal" class="booking-modal">
            <div class="booking-modal-content">
                <div class="booking-modal-header">
                    <h2 class="booking-modal-title">Book Your Ride</h2>
                    <button class="booking-close" onclick="closeBookingModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Ride Information -->
                <div class="ride-info-card">
                    <div class="ride-info-driver">
                        <div class="ride-info-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="ride-info-details">
                            <div class="ride-info-name" id="booking-driver-name">Loading...</div>
                            <div class="ride-info-rating" id="booking-driver-rating">-- ⭐</div>
                        </div>
                    </div>
                    <div class="ride-info-route" id="booking-route">-- → --</div>
                    <div id="booking-datetime">Loading...</div>
                    <div class="ride-info-price" id="booking-price">$-- per seat</div>
                </div>

                <!-- Pickup Address -->
                <div class="address-section">
                    <div class="address-section-title">
                        <i class="fas fa-map-marker-alt" style="color: var(--success-color);"></i>
                        Pickup Address
                    </div>
                    
                    <!-- Available Stops for Pickup -->
                    <div id="booking-pickup-stops" style="display: none; margin-bottom: 1rem;">
                        <div class="booking-form-group">
                            <label class="form-label">
                                <i class="fas fa-route" style="color: var(--success-color);"></i>
                                Choose from available stops or enter custom address
                            </label>
                            <div id="booking-pickup-stops-list" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: #f8f9fa;">
                                <!-- Dynamic stops will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="booking-form-group">
                        <label class="form-label">Full pickup address</label>
                        <input type="text" id="booking-pickup" class="form-input" placeholder="Enter your exact pickup location or select from stops above" required>
                        <div id="booking-pickup-suggestions" class="booking-suggestions"></div>
                    </div>
                    <div class="booking-form-group">
                        <label class="form-label">Additional pickup notes (optional)</label>
                        <input type="text" id="booking-pickup-notes" class="form-input" placeholder="e.g., Building entrance, apartment number">
                    </div>
                </div>

                <!-- Drop-off Address -->
                <div class="address-section">
                    <div class="address-section-title">
                        <i class="fas fa-flag-checkered" style="color: var(--error-color);"></i>
                        Drop-off Address
                    </div>
                    
                    <!-- Available Stops for Drop-off -->
                    <div id="booking-dropoff-stops" style="display: none; margin-bottom: 1rem;">
                        <div class="booking-form-group">
                            <label class="form-label">
                                <i class="fas fa-route" style="color: var(--error-color);"></i>
                                Choose from available stops or enter custom address
                            </label>
                            <div id="booking-dropoff-stops-list" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: #f8f9fa;">
                                <!-- Dynamic stops will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="booking-form-group">
                        <label class="form-label">Full drop-off address</label>
                        <input type="text" id="booking-dropoff" class="form-input" placeholder="Enter your exact drop-off location or select from stops above" required>
                        <div id="booking-dropoff-suggestions" class="booking-suggestions"></div>
                    </div>
                    <div class="booking-form-group">
                        <label class="form-label">Additional drop-off notes (optional)</label>
                        <input type="text" id="booking-dropoff-notes" class="form-input" placeholder="e.g., Terminal number, specific entrance">
                    </div>
                </div>

                <!-- Passenger Details -->
                <div class="address-section">
                    <div class="address-section-title">
                        <i class="fas fa-users" style="color: var(--primary-color);"></i>
                        Passenger Details
                    </div>
                    <div class="booking-form-group">
                        <label class="form-label">Number of seats</label>
                        <select id="booking-seats" class="form-input">
                            <option value="1">1 seat</option>
                            <option value="2">2 seats</option>
                            <option value="3">3 seats</option>
                        </select>
                    </div>
                    <div class="booking-form-group">
                        <label class="form-label">Special requests (optional)</label>
                        <textarea id="booking-requests" class="form-input" rows="3" placeholder="Any special requests or information for the driver..."></textarea>
                    </div>
                </div>

                <!-- Visual Route Map -->
                <div class="ride-info-card" style="margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">
                        <i class="fas fa-map"></i> Route Map & Seat Availability
                    </h4>
                    <div id="visual-route-map" style="position: relative; height: 150px; background: linear-gradient(90deg, var(--light-bg-color) 0%, var(--background-color) 100%); border-radius: 8px; padding: 1rem; overflow: hidden;">
                        <!-- Route visualization -->
                        <div style="position: absolute; top: 50%; left: 10px; right: 10px; height: 3px; background: var(--border-color); border-radius: 2px;"></div>
                        
                        <!-- Start point -->
                        <div style="position: absolute; left: 10px; top: 45%; width: 15px; height: 15px; background: var(--success-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <div style="position: absolute; left: 5px; top: 65%; font-size: 0.7rem; font-weight: 600;" id="route-start-label"><!-- Dynamic start location --></div>
                        
                        <!-- Intermediate stops with seat indicators -->
                        <div style="position: absolute; left: 40%; top: 35%;">
                            <div style="width: 20px; height: 20px; background: var(--warning-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: var(--warning-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; white-space: nowrap;">3/4</div>
                            </div>
                            <div style="position: absolute; top: 35px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 600; white-space: nowrap;" id="route-intermediate-label"><!-- Dynamic intermediate location --></div>
                            <div style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--warning-color); white-space: nowrap;">
                                <i class="fas fa-clock"></i> 2 waiting
                            </div>
                        </div>
                        
                        <div style="position: absolute; left: 70%; top: 35%;">
                            <div style="width: 20px; height: 20px; background: var(--error-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); position: relative;">
                                <div style="position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background: var(--error-color); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; white-space: nowrap;">0/4</div>
                            </div>
                            <div style="position: absolute; top: 35px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 600; white-space: nowrap;" id="route-end-label"><!-- Dynamic end location --></div>
                            <div style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); font-size: 0.6rem; color: var(--error-color); white-space: nowrap;">
                                <i class="fas fa-clock"></i> 5 waiting
                            </div>
                        </div>
                        
                        <!-- End point -->
                        <div style="position: absolute; right: 10px; top: 45%; width: 15px; height: 15px; background: var(--primary-color); border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        <div style="position: absolute; right: 5px; top: 65%; font-size: 0.7rem; font-weight: 600;" id="route-destination-label"><!-- Dynamic destination location --></div>
                    </div>
                    
                    <!-- Legend -->
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.75rem;">
                        <div><span style="color: var(--success-color);">●</span> Available</div>
                        <div><span style="color: var(--warning-color);">●</span> Limited</div>
                        <div><span style="color: var(--error-color);">●</span> Full</div>
                        <div><i class="fas fa-clock" style="color: var(--text-color);"></i> Waitlist</div>
                    </div>
                </div>

                <!-- Segment Availability Details -->
                <div class="ride-info-card" style="margin-bottom: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">Detailed Seat Availability</h4>
                    <div id="segment-availability" style="font-size: 0.9rem;">
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-route"></i> <strong>Segment 1:</strong> Chicago → Mall</span>
                            <span style="background: var(--warning-color); color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">3/4 seats</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-route"></i> <strong>Segment 2:</strong> Mall → University</span>
                            <span style="background: var(--error-color); color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">0/4 seats</span>
                        </div>
                        <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-route"></i> <strong>Segment 3:</strong> University → New York</span>
                            <span style="background: var(--success-color); color: white; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">4/4 seats</span>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--warning-color); margin-top: 0.5rem; padding: 0.5rem; background: var(--light-bg-color); border-radius: 6px;">
                            <i class="fas fa-info-circle"></i> Your booking will occupy segments where you're traveling. If fully booked, you can join the waitlist.
                        </div>
                    </div>
                </div>

                <!-- Total Cost -->
                <div class="ride-info-card">
                    <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">Booking Summary</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span>Price per seat:</span>
                        <span id="booking-summary-price">$5.75</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <span>Number of seats:</span>
                        <span id="booking-summary-seats">1</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600; border-top: 1px solid var(--border-color); padding-top: 0.5rem; margin-top: 0.5rem; color: var(--primary-color);">
                        <span>Total Amount:</span>
                        <span id="booking-summary-total">$5.75</span>
                    </div>
                </div>

                <!-- Waitlist Option -->
                <div class="ride-info-card" style="margin-bottom: 1rem; border: 2px solid var(--warning-color);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--warning-color);">
                        <i class="fas fa-clock"></i> Waitlist Available
                    </h4>
                    <div style="font-size: 0.9rem; margin-bottom: 0.75rem;">
                        Some segments are fully booked, but you can join the waitlist to be notified when seats become available.
                    </div>
                    <div style="background: var(--light-bg-color); padding: 0.75rem; border-radius: 6px; font-size: 0.85rem;">
                        <div style="margin-bottom: 0.5rem;"><strong>How it works:</strong></div>
                        <div style="margin-bottom: 0.25rem;">• Join the waitlist for your desired route</div>
                        <div style="margin-bottom: 0.25rem;">• Get notified when seats open up</div>
                        <div style="margin-bottom: 0.25rem;">• 1 hour to claim your spot once notified</div>
                        <div>• First-come, first-served priority</div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="booking-buttons">
                    <button class="btn btn-secondary" onclick="closeBookingModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="btn btn-primary" onclick="confirmBooking()">
                        <i class="fas fa-check"></i> Book Available Seats
                    </button>
                    <button class="btn" onclick="joinWaitlistDirectly()" style="background: var(--warning-color); color: white;">
                        <i class="fas fa-clock"></i> Join Waitlist
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div class="modal" id="review-modal" style="display: none;">
        <div class="modal-content" style="max-width: 480px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3 id="review-modal-title">Rate User</h3>
                <button class="modal-close" onclick="closeReviewModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="review-form-content">
                    <!-- Dynamic content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chat-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 400px; height: 600px; display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div class="chat-header" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border-color); background: var(--primary-color); color: white; border-radius: 12px 12px 0 0;">
                <div class="chat-participant-info">
                    <div style="font-weight: 600; font-size: 1rem;" id="chat-participant-name"><!-- Dynamic participant name --></div>
                    <div style="font-size: 0.8rem; opacity: 0.9;" id="chat-participant-type">Driver</div>
                </div>
                <button onclick="closeChat()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="chat-messages" style="flex: 1; padding: 1rem; overflow-y: auto; background: var(--light-bg-color);">
                <!-- Messages will be dynamically loaded here -->
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container" style="padding: 1rem; border-top: 1px solid var(--border-color); background: white;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;" onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()" style="background: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.75rem; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" style="display: none;">
        <!-- Mobile overlay for sidebar -->
        <div class="sidebar-overlay" onclick="closeSidebar()"></div>
        <div class="admin-container">
            <!-- Admin Sidebar -->
            <div class="admin-sidebar">
                <div class="admin-sidebar-header">
                    <div class="admin-logo">
                        <div>
                            <i class="fas fa-shield-alt"></i>
                            <span>OnGoPool Admin</span>
                        </div>
                        <button class="sidebar-close" onclick="toggleSidebar()" title="Close sidebar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="admin-user-info">
                        <div class="admin-avatar">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div class="admin-details">
                            <div class="admin-name">Administrator</div>
                            <div class="admin-role">Super Admin</div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="admin-nav">
                    <div class="nav-section">
                        <h4 class="nav-title">OVERVIEW</h4>
                        <a href="#" class="nav-item active" data-tab="dashboard" onclick="showAdminTab('dashboard')">
                            <i class="fas fa-chart-line"></i>
                            <span>Dashboard</span>
                        </a>
                        <a href="#" class="nav-item" data-tab="analytics" onclick="showAdminTab('analytics')">
                            <i class="fas fa-chart-bar"></i>
                            <span>Analytics</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <h4 class="nav-title">MANAGEMENT</h4>
                        <a href="#" class="nav-item" data-tab="users" onclick="showAdminTab('users')">
                            <i class="fas fa-users"></i>
                            <span>Users</span>
                            <div class="nav-badge">2,847</div>
                        </a>
                        <a href="#" class="nav-item" data-tab="rides" onclick="showAdminTab('rides')">
                            <i class="fas fa-car"></i>
                            <span>Rides</span>
                            <div class="nav-badge">1,256</div>
                        </a>
                        <a href="#" class="nav-item" data-tab="verification" onclick="showAdminTab('verification')">
                            <i class="fas fa-id-card"></i>
                            <span>Verification</span>
                            <div class="nav-badge urgent">7</div>
                        </a>
                        <a href="#" class="nav-item" data-tab="payments" onclick="showAdminTab('payments')">
                            <i class="fas fa-credit-card"></i>
                            <span>Payments</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <h4 class="nav-title">OPERATIONS</h4>
                        <a href="#" class="nav-item" data-tab="safety" onclick="showAdminTab('safety')">
                            <i class="fas fa-shield-alt"></i>
                            <span>Safety Center</span>
                            <div class="nav-badge warning">3</div>
                        </a>
                        <a href="#" class="nav-item" data-tab="support" onclick="showAdminTab('support')">
                            <i class="fas fa-headset"></i>
                            <span>Support</span>
                        </a>
                        <a href="#" class="nav-item" data-tab="settings" onclick="showAdminTab('settings')">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </div>
                </nav>

                <div class="admin-sidebar-footer">
                    <button class="logout-btn" onclick="adminLogout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="admin-main">
                <!-- Top Bar -->
                <div class="admin-topbar">
                    <div class="topbar-left">
                        <button class="sidebar-toggle" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="breadcrumb">
                            <span id="current-section">Dashboard</span>
                        </div>
                    </div>
                    <div class="topbar-right">
                        <div class="quick-stats">
                            <div class="stat-item">
                                <i class="fas fa-circle text-success"></i>
                                <span>System Healthy</span>
                            </div>
                            <div class="stat-item">
                                <i class="fas fa-users"></i>
                                <span>47 Online</span>
                            </div>
                        </div>
                        <div class="admin-notifications">
                            <button class="notification-btn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge">5</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content Container -->
                <div class="admin-content">
                    <!-- Dashboard Tab -->
                    <div id="admin-dashboard-tab" class="admin-tab-content active">
                        <div class="content-header">
                            <h1>Dashboard Overview</h1>
                            <p>Welcome back! Here's what's happening with OnGoPool today.</p>
                        </div>

                        <!-- KPI Cards -->
                        <div class="kpi-grid">
                            <div class="kpi-card primary">
                                <div class="kpi-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Total Users</div>
                                    <div class="kpi-value">2,847</div>
                                    <div class="kpi-change positive">
                                        <i class="fas fa-arrow-up"></i> +12% this month
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card success">
                                <div class="kpi-icon">
                                    <i class="fas fa-car"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Active Rides</div>
                                    <div class="kpi-value">1,256</div>
                                    <div class="kpi-change positive">
                                        <i class="fas fa-arrow-up"></i> +8% this month
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card warning">
                                <div class="kpi-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Total Revenue</div>
                                    <div class="kpi-value">$15,647</div>
                                    <div class="kpi-change positive">
                                        <i class="fas fa-arrow-up"></i> +15% this month
                                    </div>
                                </div>
                            </div>
                            <div class="kpi-card info">
                                <div class="kpi-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="kpi-content">
                                    <div class="kpi-label">Verified Drivers</div>
                                    <div class="kpi-value">543</div>
                                    <div class="kpi-change neutral">
                                        89% verified rate
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions & Recent Activity Row -->
                        <div class="dashboard-row">
                            <div class="dashboard-col-8">
                                <div class="content-card">
                                    <div class="card-header">
                                        <h3>Recent Activity</h3>
                                        <button class="btn-link">View All</button>
                                    </div>
                                    <div class="activity-feed" id="admin-activity-feed">
                                        <div class="activity-item">
                                            <div class="activity-icon success">
                                                <i class="fas fa-user-plus"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">
                                                    <strong>Sarah Johnson</strong> completed registration
                                                </div>
                                                <div class="activity-time">2 minutes ago</div>
                                            </div>
                                        </div>
                                        <div class="activity-item">
                                            <div class="activity-icon primary">
                                                <i class="fas fa-car"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">
                                                    New ride posted: <strong>Toronto to Montreal</strong>
                                                </div>
                                                <div class="activity-time">5 minutes ago</div>
                                            </div>
                                        </div>
                                        <div class="activity-item">
                                            <div class="activity-icon success">
                                                <i class="fas fa-check"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">
                                                    License verified: <strong id="admin-activity-license-user">User</strong>
                                                </div>
                                                <div class="activity-time">12 minutes ago</div>
                                            </div>
                                        </div>
                                        <div class="activity-item">
                                            <div class="activity-icon warning">
                                                <i class="fas fa-credit-card"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">
                                                    Payment processed: <strong>$45.50</strong>
                                                </div>
                                                <div class="activity-time">18 minutes ago</div>
                                            </div>
                                        </div>
                                        <div class="activity-item">
                                            <div class="activity-icon primary">
                                                <i class="fas fa-star"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">
                                                    New review submitted: <strong>5 stars</strong>
                                                </div>
                                                <div class="activity-time">25 minutes ago</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="dashboard-col-4">
                                <div class="content-card">
                                    <div class="card-header">
                                        <h3>Quick Actions</h3>
                                    </div>
                                    <div class="quick-actions">
                                        <button class="quick-action-item" onclick="showAdminTab('verification')">
                                            <div class="action-icon pending">
                                                <i class="fas fa-clipboard-check"></i>
                                            </div>
                                            <div class="action-content">
                                                <div class="action-title">Pending Verifications</div>
                                                <div class="action-count">7 pending</div>
                                            </div>
                                        </button>
                                        <button class="quick-action-item" onclick="showAdminTab('safety')">
                                            <div class="action-icon warning">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                            <div class="action-content">
                                                <div class="action-title">Safety Reports</div>
                                                <div class="action-count">3 new reports</div>
                                            </div>
                                        </button>
                                        <button class="quick-action-item" onclick="exportData('all')">
                                            <div class="action-icon info">
                                                <i class="fas fa-download"></i>
                                            </div>
                                            <div class="action-content">
                                                <div class="action-title">Export Data</div>
                                                <div class="action-count">Generate reports</div>
                                            </div>
                                        </button>
                                        <button class="quick-action-item" onclick="showSystemHealth()">
                                            <div class="action-icon success">
                                                <i class="fas fa-heartbeat"></i>
                                            </div>
                                            <div class="action-content">
                                                <div class="action-title">System Health</div>
                                                <div class="action-count">All systems normal</div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Users Tab -->
                    <div id="admin-users-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>User Management</h1>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="exportData('users')">
                                    <i class="fas fa-download"></i> Export Users
                                </button>
                            </div>
                        </div>

                        <div class="filters-bar">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" placeholder="Search users..." id="user-search" oninput="searchUsers()">
                            </div>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all" onclick="filterUsers('all')">All Users</button>
                                <button class="filter-btn" data-filter="drivers" onclick="filterUsers('drivers')">Drivers</button>
                                <button class="filter-btn" data-filter="passengers" onclick="filterUsers('passengers')">Passengers</button>
                                <button class="filter-btn" data-filter="suspended" onclick="filterUsers('suspended')">Suspended</button>
                            </div>
                        </div>

                        <div class="content-card">
                            <div class="data-table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>User</th>
                                            <th>Role</th>
                                            <th>Status</th>
                                            <th>Joined</th>
                                            <th>Rides</th>
                                            <th>Rating</th>
                                            <th>Daily Limit</th>
                                            <th>Price Constraint</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <!-- User rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Verification Tab -->
                    <div id="admin-verification-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>License Verification</h1>
                            <div class="header-status">
                                <span class="status-badge urgent">7 pending verifications</span>
                            </div>
                        </div>

                        <div class="filters-bar">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="pending" onclick="filterLicenses('pending')">Pending</button>
                                <button class="filter-btn" data-filter="approved" onclick="filterLicenses('approved')">Approved</button>
                                <button class="filter-btn" data-filter="rejected" onclick="filterLicenses('rejected')">Rejected</button>
                                <button class="filter-btn" data-filter="all" onclick="filterLicenses('all')">All</button>
                            </div>
                        </div>

                        <div class="verification-grid" id="license-grid">
                            <!-- License verification cards will be populated here -->
                        </div>
                    </div>

                    <!-- Rides Tab -->
                    <div id="admin-rides-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>Ride Management</h1>
                            <div class="header-actions">
                                <button class="btn btn-primary" onclick="exportData('rides')">
                                    <i class="fas fa-download"></i> Export Rides
                                </button>
                            </div>
                        </div>

                        <div class="content-card">
                            <div class="card-header">
                                <h3>All Rides</h3>
                                <div class="card-stats">
                                    <span class="stat-item">Total: 1,256</span>
                                    <span class="stat-item">Active: 847</span>
                                    <span class="stat-item">Completed: 409</span>
                                </div>
                            </div>
                            <div class="table-container">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Route</th>
                                            <th>Driver</th>
                                            <th>Date</th>
                                            <th>Price</th>
                                            <th>Passengers</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rides-table-body">
                                        <!-- Ride data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Tab -->
                    <div id="admin-analytics-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>Analytics & Reports</h1>
                            <p>Detailed insights and performance metrics</p>
                        </div>
                        <div class="content-card">
                            <h3>Analytics dashboard coming soon...</h3>
                        </div>
                    </div>

                    <!-- Payments Tab -->
                    <div id="admin-payments-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>Payment Management</h1>
                            <p>Transaction history and payment processing</p>
                        </div>
                        <div class="content-card">
                            <h3>Payment management coming soon...</h3>
                        </div>
                    </div>

                    <!-- Safety Tab -->
                    <div id="admin-safety-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>Safety Center</h1>
                            <p>Safety reports and incident management</p>
                        </div>
                        <div class="content-card">
                            <h3>Safety center coming soon...</h3>
                        </div>
                    </div>

                    <!-- Support Tab -->
                    <div id="admin-support-tab" class="admin-tab-content">
                        <div class="content-header">
                            <h1>Support Center</h1>
                            <p>Customer support tickets and help requests</p>
                        <!-- Admin dashboard content removed - use Supabase database for admin management -->
                        
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Define constants globally for all scripts to access
        const MAX_DAILY_RIDES = 2;
        const MAX_FUTURE_DAYS = 30;
        const MIN_PRICE_PER_KM = 0.15; // $0.15 per seat per km
        const MAX_PRICE_PER_KM = 0.25; // $0.25 per seat per km
        
        // Global variables
        let findMap = null;
        let postMap = null;
        let supabase = null;
        let currentUser = null;
        let debounceTimer = null;
        
        // AI System - TensorFlow.js Implementation
        let aiModel = null;
        let userPreferences = {};
        let rideHistory = [];
        
        // AI Feature Configuration
        const AI_CONFIG = {
            MATCHING_THRESHOLD: 0.7,
            PRICE_TOLERANCE: 0.15,
            TIME_WINDOW: 60, // minutes
            DISTANCE_WEIGHT: 0.3,
            PRICE_WEIGHT: 0.2,
            TIME_WEIGHT: 0.25,
            HISTORY_WEIGHT: 0.25
        };
        
        // Admin override configuration
        const DAILY_RIDE_LIMIT = 2;
        const MAX_ADVANCE_DAYS = 30;
        const ADMIN_OVERRIDE_KEY = 'admin_override_daily_limit';
        const ADMIN_PRICE_OVERRIDE_KEY = 'admin_override_price_constraint';
        
        // Route data
        let fromCoords = null;
        let toCoords = null;
        let routeDistance = 0;
        let fromCityName = '';
        let toCityName = '';
        
        // Booking modal data
        let currentBookingData = {};
        let bookingDebounceTimer = null;
        
        // Show a specific page and hide others
        function showPage(pageId) {
            // Hide all pages
            document.getElementById('start-page').style.display = 'none';
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('signup-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'none';
            
            // Show requested page
            if (pageId === 'main-app') {
                document.getElementById(pageId).style.display = 'block';
            } else {
                document.getElementById(pageId).style.display = 'flex';
            }
            

        }
        
        // Switch between tabs in the main app
        function switchTab(tabId) {
            // First check if the tab elements exist
            const tabButton = document.querySelector(`.nav-tab[data-tab="${tabId}"]`);
            const tabContent = document.getElementById(tabId);
            
            // Verify both elements exist before proceeding
            if (!tabButton || !tabContent) {
                console.error(`Tab ${tabId} not found. Button exists: ${!!tabButton}, Content exists: ${!!tabContent}`);
                return; // Exit the function to prevent errors
            }
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Add active class to selected tab
            tabButton.classList.add('active');
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab content
            tabContent.classList.add('active');
            
            // Load live data when switching to specific tabs
            if (tabId === 'dashboard') {
                // Load dashboard data including recent rides, earnings, and requests
                setTimeout(() => {
                    loadUserProfile();
                    loadDashboardData();
                }, 100);
            } else if (tabId === 'my-rides') {
                loadMyRidesFromDatabase();
                setupRealTimeSubscriptions();
                
                // Initialize the My Rides view to show the Driver tab by default
                setTimeout(() => switchRideView('driver'), 100);
            } else if (tabId === 'find-rides') {
                // Clear previous results when switching to find rides
                const ridesListContainer = document.getElementById('rides-list-container');
                if (ridesListContainer) {
                    ridesListContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">Enter your route above to find available rides</p>';
                }
            } else if (tabId === 'profile') {
                // Load user profile data when switching to profile tab
                loadUserProfile();
            }
        }
        
        // Function to switch between driver and passenger views in My Rides
        function switchRideView(viewType) {
            // Update the active tab styling
            document.querySelectorAll('.ride-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.borderBottom = 'none';
                tab.style.color = 'var(--text-color)';
                tab.style.opacity = '0.7';
            });
            
            const activeTab = document.getElementById(`${viewType}-tab`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.borderBottom = '2px solid var(--primary-color)';
                activeTab.style.color = 'var(--primary-color)';
                activeTab.style.opacity = '1';
            }
            
            // Show/hide appropriate sections based on the view type
            if (viewType === 'driver') {
                // Show driver sections
                showElement('ride-requests-section');
                showElement('offered-rides-section');
                // Hide passenger sections
                hideElement('passenger-requests-section');
                hideElement('booked-rides-section');
            } else {
                // Hide driver sections
                hideElement('ride-requests-section');
                hideElement('offered-rides-section');
                // Show passenger sections
                showElement('passenger-requests-section');
                showElement('booked-rides-section');
            }
            
            // Apply filters to update visible rides
            applyFilters();
        }
        
        // Helper functions to show/hide elements
        function showElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'block';
            }
        }
        
        function hideElement(id) {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = 'none';
            }
        }
        
        // Handle email confirmation on page load
        function handleEmailConfirmation() {
            const urlParams = new URLSearchParams(window.location.search);
            const tokenHash = urlParams.get('token_hash');
            const type = urlParams.get('type');
            
            if (tokenHash && type === 'email') {
                verifyEmailToken(tokenHash);
            }
        }

        // Update user profile information
        async function updateUserProfile() {
            if (!currentUser) {
                alert('You must be logged in to update your profile');
                return;
            }
            
            // Get values from form fields
            const fullName = document.getElementById('profile-fullname').value;
            const phone = document.getElementById('profile-phone').value;
            
            // Validate required fields
            if (!fullName || !phone) {
                alert('Please fill in all required fields:\n- Full Name\n- Phone');
                return;
            }
            
            try {
                // Update user data in database
                const { data, error } = await supabase
                    .from('users')
                    .update({
                        full_name: fullName,
                        phone: phone,
                        updated_at: new Date()
                    })
                    .eq('id', currentUser.id);
                
                if (error) {
                    console.error('Error updating user data:', error);
                    alert('Failed to update profile: ' + error.message);
                    return;
                }
                
                // Show success message
                alert('Profile updated successfully!');
                
                // Reload profile data to show updated information
                loadUserProfile();
                
            } catch (error) {
                console.error('Error in updateUserProfile:', error);
                alert('An error occurred while updating your profile');
            }
        }
        
        // Load user profile data from database
        async function loadUserProfile() {
            if (!currentUser) {
                console.log('No user logged in - cannot load profile');
                // Clear profile UI when not logged in
                const profileElements = [
                    'profile-name-display',
                    'profile-fullname', 
                    'profile-email',
                    'profile-phone'
                ];
                profileElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.tagName === 'INPUT') {
                            element.value = '';
                        } else {
                            element.textContent = '';
                        }
                    }
                });
                return;
            }
            
            try {
                // Get user data from database
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (userError) {
                    console.error('Error fetching user data:', userError);
                    return;
                }
                
                if (!userData) {
                    console.error('No user data found');
                    return;
                }
                
                // Update profile UI with user data
                document.getElementById('profile-name-display').textContent = userData.full_name || 'No name provided';
                document.getElementById('profile-fullname').value = userData.full_name || '';
                document.getElementById('profile-email').value = userData.email || '';
                document.getElementById('profile-phone').value = userData.phone || '';
                
                // Update ratings
                document.getElementById('passenger-rating-score').textContent = parseFloat(userData.passenger_rating).toFixed(1);
                document.getElementById('passenger-rides-count').textContent = `Based on ${userData.total_rides_as_passenger || 0} rides`;
                
                document.getElementById('driver-rating-score').textContent = parseFloat(userData.driver_rating).toFixed(1);
                document.getElementById('driver-rides-count').textContent = `Based on ${userData.total_rides_as_driver || 0} rides`;
                
                // Show/hide driver rating card based on user having rides as driver
                const driverRatingCard = document.getElementById('driver-rating-card');
                if (driverRatingCard) {
                    driverRatingCard.style.display = userData.license_verified ? 'block' : 'none';
                }
                
                // Show/hide license verification status
                const licenseStatus = document.getElementById('license-status');
                const licenseStatusText = document.getElementById('license-status-text');
                
                if (licenseStatus && licenseStatusText) {
                    licenseStatus.style.display = 'block';
                    
                    if (userData.license_verified) {
                        licenseStatus.style.color = 'var(--success-color)';
                        licenseStatusText.innerHTML = '<i class="fas fa-check-circle"></i> License verified';
                    } else {
                        licenseStatus.style.color = 'var(--warning-color)';
                        licenseStatusText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> License verification pending';
                    }
                }
                
                console.log('User profile loaded successfully');
                
                // Load My Rides data after profile is loaded
                loadMyRidesFromDatabase();
                
            } catch (error) {
                console.error('Error in loadUserProfile:', error);
            }
        }
        
        // Load My Rides data from Supabase
        async function loadMyRidesFromDatabase() {
            if (!currentUser) {
                console.log('No user logged in - cannot load rides');
                // Clear My Rides UI when not logged in
                const containerIds = [
                    'offered-rides-dynamic-container',
                    'booked-rides-dynamic-container', 
                    'ride-requests-dynamic-container',
                    'passenger-requests-dynamic-container'
                ];
                containerIds.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        container.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666;">Please log in to view your rides</div>';
                    }
                });
                return;
            }
            
            try {
                // Show loading indicators
                document.getElementById('offered-rides-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading offered rides...</div>';
                document.getElementById('booked-rides-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading booked rides...</div>';
                document.getElementById('ride-requests-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading ride requests...</div>';
                document.getElementById('passenger-requests-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i> Loading passenger requests...</div>';
                
                // Fetch offered rides (as driver)
                const { data: offeredRides, error: offeredError } = await supabase
                    .from('rides')
                    .select('*, users(*)')
                    .eq('driver_id', currentUser.id)
                    .order('departure_time', { ascending: true });
                
                if (offeredError) {
                    console.error('Error fetching offered rides:', offeredError);
                    document.getElementById('offered-rides-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-exclamation-circle" style="color: var(--error-color);"></i> Error loading offered rides</div>';
                } else {
                    displayOfferedRides(offeredRides);
                }
                
                // Fetch booked rides (as passenger)
                const { data: bookedRides, error: bookedError } = await supabase
                    .from('ride_bookings')
                    .select('*, rides(*), rides.users(*)')
                    .eq('passenger_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (bookedError) {
                    console.error('Error fetching booked rides:', bookedError);
                    document.getElementById('booked-rides-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-exclamation-circle" style="color: var(--error-color);"></i> Error loading booked rides</div>';
                } else {
                    displayBookedRides(bookedRides);
                }
                
                // Fetch ride requests (as driver)
                const { data: rideRequests, error: requestsError } = await supabase
                    .from('ride_bookings')
                    .select('*, rides(*), users(*)')
                    .eq('status', 'pending')
                    .in('ride_id', offeredRides?.map(ride => ride.id) || []);
                
                if (requestsError) {
                    console.error('Error fetching ride requests:', requestsError);
                    document.getElementById('ride-requests-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-exclamation-circle" style="color: var(--error-color);"></i> Error loading ride requests</div>';
                } else {
                    displayRideRequests(rideRequests);
                }
                
                // Fetch passenger requests (as passenger)
                const { data: passengerRequests, error: passengerRequestsError } = await supabase
                    .from('ride_bookings')
                    .select('*, rides(*), rides.users(*)')
                    .eq('passenger_id', currentUser.id)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (passengerRequestsError) {
                    console.error('Error fetching passenger requests:', passengerRequestsError);
                    document.getElementById('passenger-requests-dynamic-container').innerHTML = '<div style="text-align: center; padding: 1rem;"><i class="fas fa-exclamation-circle" style="color: var(--error-color);"></i> Error loading passenger requests</div>';
                } else {
                    displayPassengerRequests(passengerRequests);
                }
                
                console.log('My Rides data loaded successfully');
            } catch (error) {
                console.error('Error loading My Rides data:', error);
            }
        }
        
        // Display offered rides
        function displayOfferedRides(rides) {
            const container = document.getElementById('offered-rides-dynamic-container');
            
            if (!rides || rides.length === 0) {
                // Show empty state
                document.getElementById('no-offered-rides').style.display = 'block';
                container.innerHTML = '';
                document.getElementById('offered-rides-count').textContent = '0 active';
                return;
            }
            
            // Hide empty state
            document.getElementById('no-offered-rides').style.display = 'none';
            
            // Update count
            const activeRides = rides.filter(ride => ride.status === 'available').length;
            document.getElementById('offered-rides-count').textContent = `${activeRides} active`;
            
            let html = '';
            
            rides.forEach(ride => {
                const departureDate = new Date(ride.departure_time);
                const formattedDate = departureDate.toLocaleDateString();
                const formattedTime = departureDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                
                const isPastRide = new Date(ride.departure_time) < new Date();
                const statusClass = isPastRide ? 'completed' : ride.status === 'available' ? 'upcoming' : ride.status;
                const statusText = isPastRide ? 'Completed' : ride.status === 'available' ? 'Upcoming' : ride.status.charAt(0).toUpperCase() + ride.status.slice(1);
                
                html += `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${isPastRide ? '#4CAF50' : ride.status === 'available' ? '#2196F3' : '#F44336'};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${ride.departure_address} → ${ride.destination_address}</h4>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <i class="fas fa-calendar"></i> ${formattedDate} at ${formattedTime}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-users"></i> ${ride.available_seats} seats available
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-dollar-sign"></i> $${parseFloat(ride.total_price_per_seat || ride.price_per_seat).toFixed(2)} per seat
                                </div>
                                ${ride.additional_notes ? `
                                <div style="font-size: 0.9rem; margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,0,0,0.05); border-radius: 4px;">
                                    <i class="fas fa-info-circle"></i> ${ride.additional_notes}
                                </div>` : ''}
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}" style="font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 12px; background: ${isPastRide ? 'rgba(76, 175, 80, 0.1)' : ride.status === 'available' ? 'rgba(33, 150, 243, 0.1)' : 'rgba(244, 67, 54, 0.1)'}; color: ${isPastRide ? '#4CAF50' : ride.status === 'available' ? '#2196F3' : '#F44336'};">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewRideDetails('${ride.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="viewRideBookings('${ride.id}')">
                                <i class="fas fa-clipboard-list"></i> View Bookings
                            </button>
                            ${!isPastRide && ride.status === 'available' ? `
                            <button class="btn btn-sm btn-warning" onclick="cancelRide('${ride.id}')">
                                <i class="fas fa-ban"></i> Cancel Ride
                            </button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Display booked rides
        function displayBookedRides(bookings) {
            const container = document.getElementById('booked-rides-dynamic-container');
            
            if (!bookings || bookings.length === 0) {
                // Show empty state
                document.getElementById('no-booked-rides').style.display = 'block';
                container.innerHTML = '';
                document.getElementById('booked-rides-count').textContent = '0 confirmed';
                return;
            }
            
            // Hide empty state
            document.getElementById('no-booked-rides').style.display = 'none';
            
            // Update count
            const confirmedBookings = bookings.filter(booking => booking.status === 'confirmed').length;
            document.getElementById('booked-rides-count').textContent = `${confirmedBookings} confirmed`;
            
            let html = '';
            
            bookings.forEach(booking => {
                if (!booking.rides) {
                    console.warn('Booking missing ride data:', booking);
                    return; // Skip this booking
                }
                
                const ride = booking.rides;
                const driver = ride.users || { full_name: 'Unknown Driver' };
                
                const departureDate = new Date(ride.departure_time);
                const formattedDate = departureDate.toLocaleDateString();
                const formattedTime = departureDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                
                const isPastRide = new Date(ride.departure_time) < new Date();
                const statusClass = isPastRide ? 'completed' : booking.status;
                const statusText = isPastRide ? 'Completed' : booking.status.charAt(0).toUpperCase() + booking.status.slice(1);
                
                const statusColor = isPastRide ? '#4CAF50' : 
                                    booking.status === 'confirmed' ? '#2196F3' : 
                                    booking.status === 'cancelled' ? '#F44336' : 
                                    booking.status === 'pending' ? '#FFC107' : '#9E9E9E';
                
                html += `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${booking.pickup_address || ride.departure_address} → ${booking.dropoff_address || ride.destination_address}</h4>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <i class="fas fa-calendar"></i> ${formattedDate} at ${formattedTime}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-user-circle"></i> Driver: ${driver.full_name}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-users"></i> ${booking.seats_requested} seats booked
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-dollar-sign"></i> Total: $${parseFloat(booking.total_price || ride.total_price_per_seat * booking.seats_requested).toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <span class="status-badge ${statusClass}" style="font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 12px; background: rgba(${statusColor.replace('#', '').match(/.{2}/g).map(hex => parseInt(hex, 16)).join(',')}, 0.1); color: ${statusColor};">
                                    ${statusText}
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewBookingDetails('${booking.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${!isPastRide && booking.status === 'confirmed' ? `
                            <button class="btn btn-sm btn-warning" onclick="cancelBooking('${booking.id}')">
                                <i class="fas fa-ban"></i> Cancel Booking
                            </button>` : ''}
                            ${isPastRide && booking.status !== 'cancelled' ? `
                            <button class="btn btn-sm btn-success" onclick="rateRide('${booking.id}', '${ride.driver_id}')">
                                <i class="fas fa-star"></i> Rate Ride
                            </button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Display ride requests
        function displayRideRequests(requests) {
            const container = document.getElementById('ride-requests-dynamic-container');
            
            if (!requests || requests.length === 0) {
                // Show empty state
                document.getElementById('no-driver-requests').style.display = 'block';
                container.innerHTML = '';
                document.getElementById('pending-request-count').textContent = '0 pending';
                return;
            }
            
            // Hide empty state
            document.getElementById('no-driver-requests').style.display = 'none';
            
            // Update count
            document.getElementById('pending-request-count').textContent = `${requests.length} pending`;
            
            let html = '';
            
            requests.forEach(request => {
                const ride = request.rides || {};
                const passenger = request.users || { full_name: 'Unknown Passenger' };
                
                const formattedDate = new Date(request.created_at).toLocaleDateString();
                const formattedTime = new Date(request.created_at).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                
                html += `
                    <div class="request-item pending" data-status="pending">
                        <div class="request-header">
                            <div class="request-passenger">
                                <div class="passenger-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="passenger-info">
                                    <div class="passenger-name">${passenger.full_name}</div>
                                    <div class="passenger-rating">${parseFloat(passenger.passenger_rating || 4.5).toFixed(1)} ⭐ (${passenger.total_rides_as_passenger || 0} rides)</div>
                                </div>
                            </div>
                            <div class="request-status pending">
                                <i class="fas fa-clock"></i> Pending
                            </div>
                        </div>
                        
                        <div class="request-details">
                            <div>
                                <i class="fas fa-map-marker-alt"></i> From: ${request.pickup_address || ride.departure_address}
                            </div>
                            <div>
                                <i class="fas fa-map-marker-alt"></i> To: ${request.dropoff_address || ride.destination_address}
                            </div>
                            <div>
                                <i class="fas fa-users"></i> ${request.seats_requested} seat(s)
                            </div>
                            <div>
                                <i class="fas fa-calendar"></i> ${formattedDate} ${formattedTime}
                            </div>
                            <div class="request-earnings">
                                <i class="fas fa-dollar-sign"></i> Earnings: $${parseFloat(request.total_price || (ride.total_price_per_seat * request.seats_requested)).toFixed(2)} (after platform fee)
                            </div>
                        </div>
                        
                        <div class="request-special" style="display: ${request.special_requests ? 'block' : 'none'};">
                            <div class="special-requests">
                                <strong>Special Requests:</strong> "${request.special_requests || 'None'}"
                            </div>
                        </div>
                        
                        <div class="request-actions">
                            <button class="btn btn-sm btn-outline" onclick="toggleRequestDetails(this)">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-sm btn-success" onclick="acceptBookingRequest('${request.id}', this)">
                                <i class="fas fa-check"></i> Accept
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="declineBookingRequest('${request.id}', this)">
                                <i class="fas fa-times"></i> Decline
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Display passenger requests
        function displayPassengerRequests(requests) {
            const container = document.getElementById('passenger-requests-dynamic-container');
            
            if (!requests || requests.length === 0) {
                // Show empty state
                document.getElementById('no-passenger-requests').style.display = 'block';
                container.innerHTML = '';
                document.getElementById('my-request-count').textContent = '0 pending';
                return;
            }
            
            // Hide empty state
            document.getElementById('no-passenger-requests').style.display = 'none';
            
            // Update count
            document.getElementById('my-request-count').textContent = `${requests.length} pending`;
            
            let html = '';
            
            requests.forEach(request => {
                const ride = request.rides || {};
                const driver = ride.users || { full_name: 'Unknown Driver' };
                
                const departureDate = new Date(ride.departure_time);
                const formattedDate = departureDate.toLocaleDateString();
                const formattedTime = departureDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                
                html += `
                    <div class="card" style="margin-bottom: 1rem; border-left: 4px solid #FFC107;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h4 style="margin: 0 0 0.5rem 0;">${request.pickup_address || ride.departure_address} → ${request.dropoff_address || ride.destination_address}</h4>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <i class="fas fa-calendar"></i> ${formattedDate} at ${formattedTime}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-user-circle"></i> Driver: ${driver.full_name}
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-users"></i> ${request.seats_requested} seats requested
                                </div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">
                                    <i class="fas fa-dollar-sign"></i> Total: $${parseFloat(request.total_price || ride.total_price_per_seat * request.seats_requested).toFixed(2)}
                                </div>
                            </div>
                            <div>
                                <span class="status-badge pending" style="font-size: 0.8rem; padding: 0.25rem 0.75rem; border-radius: 12px; background: rgba(255, 193, 7, 0.1); color: #FFC107;">
                                    Pending
                                </span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-sm btn-secondary" onclick="viewBookingDetails('${request.id}')">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="cancelRequest('${request.id}')">
                                <i class="fas fa-ban"></i> Cancel Request
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Function to handle viewing ride details
        function viewRideDetails(rideId) {
            alert(`View details for ride: ${rideId}`);
            // In a real implementation, you would show a modal with detailed ride information
        }
        
        // Function to handle viewing ride bookings
        function viewRideBookings(rideId) {
            alert(`View bookings for ride: ${rideId}`);
            // In a real implementation, you would show a modal with all bookings for this ride
        }
        
        // Function to handle canceling a ride
        async function cancelRide(rideId) {
            if (confirm('Are you sure you want to cancel this ride? This will also cancel all bookings for this ride.')) {
                try {
                    // Update ride status in database
                    const { error } = await supabase
                        .from('rides')
                        .update({ status: 'cancelled', updated_at: new Date() })
                        .eq('id', rideId);
                    
                    if (error) {
                        console.error('Error canceling ride:', error);
                        alert('Failed to cancel ride: ' + error.message);
                        return;
                    }
                    
                    // Also update all associated bookings
                    const { error: bookingError } = await supabase
                        .from('ride_bookings')
                        .update({ status: 'cancelled', updated_at: new Date() })
                        .eq('ride_id', rideId);
                    
                    if (bookingError) {
                        console.error('Error canceling bookings:', bookingError);
                        // Don't block the UI, continue with success message
                    }
                    
                    alert('Ride cancelled successfully');
                    loadMyRidesFromDatabase(); // Reload rides data
                } catch (error) {
                    console.error('Error in cancelRide:', error);
                    alert('An error occurred while canceling the ride');
                }
            }
        }
        
        // Function to handle viewing booking details
        function viewBookingDetails(bookingId) {
            alert(`View details for booking: ${bookingId}`);
            // In a real implementation, you would show a modal with detailed booking information
        }
        
        // Function to handle canceling a booking
        async function cancelBooking(bookingId) {
            if (confirm('Are you sure you want to cancel this booking?')) {
                try {
                    // Update booking status in database
                    const { error } = await supabase
                        .from('ride_bookings')
                        .update({ status: 'cancelled', updated_at: new Date() })
                        .eq('id', bookingId);
                    
                    if (error) {
                        console.error('Error canceling booking:', error);
                        alert('Failed to cancel booking: ' + error.message);
                        return;
                    }
                    
                    // Get the booking to update ride available seats
                    const { data: booking, error: fetchError } = await supabase
                        .from('ride_bookings')
                        .select('ride_id, seats_requested')
                        .eq('id', bookingId)
                        .single();
                    
                    if (fetchError) {
                        console.error('Error fetching booking details:', fetchError);
                        // Don't block the UI, continue with success message
                    } else if (booking) {
                        // Get current available seats
                        const { data: ride, error: rideError } = await supabase
                            .from('rides')
                            .select('available_seats')
                            .eq('id', booking.ride_id)
                            .single();
                        
                        if (!rideError && ride) {
                            // Update available seats on the ride
                            const newSeats = ride.available_seats + booking.seats_requested;
                            const { error: updateError } = await supabase
                                .from('rides')
                                .update({ available_seats: newSeats, updated_at: new Date() })
                                .eq('id', booking.ride_id);
                            
                            if (updateError) {
                                console.error('Error updating ride seats:', updateError);
                            }
                        }
                    }
                    
                    alert('Booking cancelled successfully');
                    loadMyRidesFromDatabase(); // Reload rides data
                } catch (error) {
                    console.error('Error in cancelBooking:', error);
                    alert('An error occurred while canceling the booking');
                }
            }
        }
        
        // Function to handle rating a ride
        function rateRide(bookingId, driverId) {
            alert(`Rate ride for booking: ${bookingId}, driver: ${driverId}`);
            // In a real implementation, you would show a modal with rating options
        }
        
        // Function to toggle request details
        function toggleRequestDetails(button) {
            const requestItem = button.closest('.request-item');
            const requestDetails = requestItem.querySelector('.request-details');
            const specialRequests = requestItem.querySelector('.request-special');
            
            // Toggle visibility
            if (requestDetails.style.display === 'none') {
                requestDetails.style.display = 'grid';
                if (specialRequests) specialRequests.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
            } else {
                requestDetails.style.display = 'none';
                if (specialRequests) specialRequests.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> View Details';
            }
        }
        
        // Function to accept a booking request
        async function acceptBookingRequest(requestId, button) {
            if (confirm('Are you sure you want to accept this booking request?')) {
                try {
                    // Update booking status in database
                    const { error } = await supabase
                        .from('ride_bookings')
                        .update({ status: 'confirmed', updated_at: new Date() })
                        .eq('id', requestId);
                    
                    if (error) {
                        console.error('Error accepting booking request:', error);
                        alert('Failed to accept booking request: ' + error.message);
                        return;
                    }
                    
                    alert('Booking request accepted successfully');
                    loadMyRidesFromDatabase(); // Reload rides data
                } catch (error) {
                    console.error('Error in acceptBookingRequest:', error);
                    alert('An error occurred while accepting the booking request');
                }
            }
        }
        
        // Function to decline a booking request
        async function declineBookingRequest(requestId, button) {
            if (confirm('Are you sure you want to decline this booking request?')) {
                try {
                    // Update booking status in database
                    const { error } = await supabase
                        .from('ride_bookings')
                        .update({ status: 'declined', updated_at: new Date() })
                        .eq('id', requestId);
                    
                    if (error) {
                        console.error('Error declining booking request:', error);
                        alert('Failed to decline booking request: ' + error.message);
                        return;
                    }
                    
                    // Get the booking to update ride available seats
                    const { data: booking, error: fetchError } = await supabase
                        .from('ride_bookings')
                        .select('ride_id, seats_requested')
                        .eq('id', requestId)
                        .single();
                    
                    if (fetchError) {
                        console.error('Error fetching booking details:', fetchError);
                        // Don't block the UI, continue with success message
                    } else if (booking) {
                        // Get current available seats
                        const { data: ride, error: rideError } = await supabase
                            .from('rides')
                            .select('available_seats')
                            .eq('id', booking.ride_id)
                            .single();
                        
                        if (!rideError && ride) {
                            // Update available seats on the ride
                            const newSeats = ride.available_seats + booking.seats_requested;
                            const { error: updateError } = await supabase
                                .from('rides')
                                .update({ available_seats: newSeats, updated_at: new Date() })
                                .eq('id', booking.ride_id);
                            
                            if (updateError) {
                                console.error('Error updating ride seats:', updateError);
                            }
                        }
                    }
                    
                    alert('Booking request declined successfully');
                    loadMyRidesFromDatabase(); // Reload rides data
                } catch (error) {
                    console.error('Error in declineBookingRequest:', error);
                    alert('An error occurred while declining the booking request');
                }
            }
        }
        
        // Function to cancel a passenger request
        async function cancelRequest(requestId) {
            if (confirm('Are you sure you want to cancel this request?')) {
                try {
                    // Update request status in database
                    const { error } = await supabase
                        .from('ride_bookings')
                        .update({ status: 'cancelled', updated_at: new Date() })
                        .eq('id', requestId);
                    
                    if (error) {
                        console.error('Error canceling request:', error);
                        alert('Failed to cancel request: ' + error.message);
                        return;
                    }
                    
                    // Get the booking to update ride available seats
                    const { data: booking, error: fetchError } = await supabase
                        .from('ride_bookings')
                        .select('ride_id, seats_requested')
                        .eq('id', requestId)
                        .single();
                    
                    if (fetchError) {
                        console.error('Error fetching booking details:', fetchError);
                        // Don't block the UI, continue with success message
                    } else if (booking) {
                        // Get current available seats
                        const { data: ride, error: rideError } = await supabase
                            .from('rides')
                            .select('available_seats')
                            .eq('id', booking.ride_id)
                            .single();
                        
                        if (!rideError && ride) {
                            // Update available seats on the ride
                            const newSeats = ride.available_seats + booking.seats_requested;
                            const { error: updateError } = await supabase
                                .from('rides')
                                .update({ available_seats: newSeats, updated_at: new Date() })
                                .eq('id', booking.ride_id);
                            
                            if (updateError) {
                                console.error('Error updating ride seats:', updateError);
                            }
                        }
                    }
                    
                    alert('Request cancelled successfully');
                    loadMyRidesFromDatabase(); // Reload rides data
                } catch (error) {
                    console.error('Error in cancelRequest:', error);
                    alert('An error occurred while canceling the request');
                }
            }
        }

        // Verify email confirmation token
        async function verifyEmailToken(tokenHash) {
            try {
                const { data, error } = await supabase.auth.verifyOtp({
                    token_hash: tokenHash,
                    type: 'email'
                });

                if (error) {
                    alert('Email verification failed: ' + error.message);
                    return;
                }

                if (data.user) {
                    currentUser = data.user;
                    alert('Email verified successfully! You can now log in.');
                    showPage('login-page');
                    // Clear the URL parameters
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('Email verification error:', error);
                alert('Email verification failed. Please try again.');
            }
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Stripe
            initializeStripe();
            
            // Enable payout button based on day and payment method
            enablePayoutIfEligible();
            
            // Handle email confirmation if present in URL
            handleEmailConfirmation();
            
            // App starts at welcome page by default - no auto-login
            

            

            // Set up tab switching
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                    
                    // Initialize maps when switching to tabs that need them
                    setTimeout(() => {
                        if (tabId === 'post-ride' && !postMap) {
                            postMap = initializeMap('post', 'post-map');
                        } else if (tabId === 'find-rides' && !findMap) {
                            findMap = initializeMap('find', 'find-map');
                        }
                    }, 100);
                });
            });
            
            // Function to set minimum date on date inputs
            function setMinDate() {
                const today = new Date();
                const dateInputs = document.querySelectorAll('input[type="date"]');
                dateInputs.forEach(input => {
                    input.min = today.toISOString().split('T')[0];
                });
            }
            
            // Call setMinDate function and initialize date constraints
            setMinDate();
            initializeDateConstraints();
            
            // Initialize Supabase
            const SUPABASE_URL = 'https://efjwsdxgelbgthcyltjr.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmandzZHhnZWxiZ3RoY3lsdGpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3OTUwODksImV4cCI6MjA2NjM3MTA4OX0.giqea72-32b0_AhVXyCxQ_6xpjDrd7Z33HcibB8xtNs';
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase initialized successfully');
                
                // Set up authentication state change listener
                setupAuthStateListener();
                
                // Check for existing session and restore user state
                checkExistingSession();
                
                // Check license verification status after Supabase is initialized
                setTimeout(() => {
                    checkProfileLicenseStatus();
                }, 500);
            } catch (error) {
                console.error('Supabase initialization error:', error);
            }
            
            // Initialize address autocomplete
            initializeAutocomplete();
            
            // Initialize booking modal autocomplete
            initializeBookingAutocomplete();
            
            // Initialize user type
            initializeUserType();
            
            // Initialize push notifications
            initializePushNotifications();
            
            // Initialize AI System
            initializeAISystem();
            
            // Initialize production features
            initializeProductionFeatures();
            
            // Show start page by default
            showPage('start-page');
        });
        
        // Helper function to validate date limits
        function checkDateLimit() {
            const dateInput = document.getElementById('post-date');
            if (!dateInput || !dateInput.value) return;
            
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            const maxDate = new Date();
            maxDate.setDate(today.getDate() + MAX_FUTURE_DAYS);
            
            // Reset to today if date is in the past
            if (selectedDate < today) {
                alert("You cannot select a date in the past.");
                dateInput.valueAsDate = today;
            }
            
            // Reset to max date if beyond the limit
            if (selectedDate > maxDate) {
                alert(`You cannot post rides more than ${MAX_FUTURE_DAYS} days in advance.`);
                dateInput.valueAsDate = maxDate;
            }
        }
        
        // Set up authentication state change listener
        function setupAuthStateListener() {
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session?.user?.email);
                
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    console.log('User signed in:', currentUser.email);
                    setupRealTimeSubscriptions();
                    loadUserProfile();
                    showPage('main-app');
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    console.log('User signed out');
                    localStorage.removeItem('currentUserId');
                    showPage('start-page');
                } else if (event === 'TOKEN_REFRESHED' && session) {
                    currentUser = session.user;
                    console.log('Token refreshed for user:', currentUser.email);
                }
            });
        }
        
        // Check for existing session on page load
        async function checkExistingSession() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Error checking session:', error);
                    return;
                }
                
                if (session && session.user) {
                    console.log('Existing session found, restoring user:', session.user.email);
                    currentUser = session.user;
                    loadUserProfile(); // Load the actual user's profile
                    showPage('main-app');
                } else {
                    console.log('No existing session found');
                    currentUser = null;
                    showPage('start-page');
                }
            } catch (error) {
                console.error('Error in checkExistingSession:', error);
                showPage('start-page');
            }
        }
        
        // Logout function
        async function logoutUser() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error('Error logging out:', error);
                    alert('Error logging out: ' + error.message);
                    return;
                }
                
                // Clear user state
                currentUser = null;
                
                // Clear any cached data
                localStorage.removeItem('currentUserId');
                
                console.log('User logged out successfully');
                
                // Return to start page
                showPage('start-page');
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed. Please try again.');
            }
        }
        
        // Admin functions removed - use Supabase dashboard for administration

        // Login user
        async function loginUser(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    alert('Login failed: ' + error.message);
                    return;
                }
                
                currentUser = data.user;
                console.log('User logged in successfully:', currentUser);
                setupRealTimeSubscriptions(); // Set up real-time subscriptions on login
                loadUserProfile(); // Load user profile data on login
                showPage('main-app');
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }
        
        // Sign up user
        async function signupUser(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const fullName = document.getElementById('signup-name').value;
            const phone = document.getElementById('signup-phone').value;
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: fullName,
                            phone: phone
                        },
                        emailRedirectTo: `${window.location.origin}/auth/confirm`
                    }
                });
                
                if (error) {
                    alert('Signup failed: ' + error.message);
                    return;
                }
                
                // Create user profile in our users table
                const { error: profileError } = await supabase
                    .from('users')
                    .insert([
                        {
                            id: data.user.id,
                            email: email,
                            phone: phone,
                            full_name: fullName
                        }
                    ]);
                
                if (profileError) {
                    console.error('Profile creation error:', profileError);
                }
                
                alert('Account created successfully! Please check your email to verify your account.');
                showPage('login-page');
            } catch (error) {
                console.error('Signup error:', error);
                alert('Signup failed: ' + error.message);
            }
        }
        
        // Global variables for stops
        let postStops = [];
        let stopCounter = 0;
        
        // Function to create ride segments for dynamic seat management
        function createRideSegments(from, stops, to, fromCoords, toCoords, totalSeats) {
            const segments = [];
            const allLocations = [from, ...stops, to];
            const allCoords = [fromCoords, ...stops.map(stop => stop.coords || [0, 0]), toCoords];
            
            for (let i = 0; i < allLocations.length - 1; i++) {
                segments.push({
                    order: i + 1,
                    from: allLocations[i],
                    to: allLocations[i + 1],
                    fromCoords: allCoords[i],
                    toCoords: allCoords[i + 1],
                    seats: totalSeats, // All segments start with full capacity
                    originalSeats: totalSeats,
                    passengers: [] // Track who's on this segment
                });
            }
            
            return segments;
        }
        
        // Function to check seat availability for a specific route segment
        function checkSegmentAvailability(segments, pickupLocation, dropoffLocation) {
            // Find which segments the passenger will occupy
            const occupiedSegments = [];
            let inRoute = false;
            
            segments.forEach((segment, index) => {
                // Simplified logic - in real app, would check exact coordinates
                if (segment.from.includes(pickupLocation) || pickupLocation.includes(segment.from)) {
                    inRoute = true;
                }
                if (inRoute) {
                    occupiedSegments.push(index);
                }
                if (segment.to.includes(dropoffLocation) || dropoffLocation.includes(segment.to)) {
                    inRoute = false;
                }
            });
            
            // Check minimum available seats across all occupied segments
            const minAvailableSeats = Math.min(...occupiedSegments.map(i => segments[i].seats));
            return { minAvailableSeats, occupiedSegments };
        }
        
        // Function to book seats on specific segments
        function bookSeatsOnSegments(segments, occupiedSegments, seatsToBook, passengerInfo) {
            occupiedSegments.forEach(segmentIndex => {
                segments[segmentIndex].seats -= seatsToBook;
                segments[segmentIndex].passengers.push({
                    ...passengerInfo,
                    seatsBooked: seatsToBook
                });
            });
        }
        
        // Function to add passenger to waitlist
        function addToWaitlist(pickupAddress, dropoffAddress, seatsRequested, occupiedSegments) {
            // Simulate waitlist entry
            const waitlistEntry = {
                id: 'waitlist-' + Date.now(),
                pickup: pickupAddress,
                dropoff: dropoffAddress,
                seats: seatsRequested,
                segments: occupiedSegments,
                timestamp: new Date(),
                status: 'active'
            };
            
            // In real app, this would save to database
            alert(`✅ Added to Waitlist!\n\nYou're now on the waitlist for this ride.\n\nPickup: ${pickupAddress}\nDrop-off: ${dropoffAddress}\nSeats requested: ${seatsRequested}\n\n📧 You'll be notified by email/push notification when seats become available.\n⏰ You'll have 1 hour to claim your spot once notified.\n\n🎯 Your position: #${occupiedSegments.length + 1} in queue`);
            
            closeModal('ride-booking-modal');
            
            // Update UI to show waitlist status
            updateWaitlistUI(waitlistEntry);
        }
        
        // Function to update UI with waitlist information
        function updateWaitlistUI(waitlistEntry) {
            // Add waitlist indicator to ride listing
            const rideCards = document.querySelectorAll('.available-ride-card');
            rideCards.forEach(card => {
                const waitlistBadge = document.createElement('div');
                waitlistBadge.className = 'waitlist-badge';
                waitlistBadge.style.cssText = 'background: var(--warning-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-top: 0.5rem;';
                waitlistBadge.innerHTML = '<i class="fas fa-clock"></i> On Waitlist (#' + (waitlistEntry.segments.length + 1) + ')';
                card.appendChild(waitlistBadge);
            });
        }
        
        // Function to check and notify waitlist when seats become available
        function processWaitlistNotifications(segments) {
            // Simulate checking waitlist for available seats
            segments.forEach((segment, index) => {
                if (segment.seats > 0 && segment.waitlist && segment.waitlist.length > 0) {
                    const nextInLine = segment.waitlist[0];
                    if (nextInLine.status === 'active' && nextInLine.seats <= segment.seats) {
                        // Notify passenger
                        notifyWaitlistPassenger(nextInLine, segment);
                    }
                }
            });
        }
        
        // Function to notify waitlist passenger
        function notifyWaitlistPassenger(waitlistEntry, segment) {
            // In real app, this would send email/push notification
            console.log(`🔔 Notifying passenger: Seats available for ${waitlistEntry.pickup} → ${waitlistEntry.dropoff}`);
            
            // Update waitlist entry status
            waitlistEntry.status = 'notified';
            waitlistEntry.notifiedAt = new Date();
            waitlistEntry.expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour to claim
        }
        
        // Function to join waitlist directly from booking modal
        function joinWaitlistDirectly() {
            const pickupAddress = document.getElementById('booking-pickup').value || 'Your pickup location';
            const dropoffAddress = document.getElementById('booking-dropoff').value || 'Your destination';
            const seats = document.getElementById('booking-seats').value || '1';
            
            // Calculate actually occupied segments based on current bookings
            const occupiedSegments = getCurrentlyOccupiedSegments();
            
            addToWaitlist(pickupAddress, dropoffAddress, seats, occupiedSegments);
        }
        
        // Get currently occupied segments from database
        function getCurrentlyOccupiedSegments() {
            // TODO: Implement proper segment calculation from ride bookings
            return [];
        }

        // Initialize address autocomplete for all address inputs
        function initializeAutocomplete() {
            const addressInputs = [
                { input: 'find-from', suggestions: 'find-from-suggestions' },
                { input: 'find-to', suggestions: 'find-to-suggestions' },
                { input: 'post-from', suggestions: 'post-from-suggestions' },
                { input: 'post-to', suggestions: 'post-to-suggestions' }
            ];
            
            addressInputs.forEach(({input, suggestions}) => {
                const inputElement = document.getElementById(input);
                const suggestionsElement = document.getElementById(suggestions);
                
                if (inputElement && suggestionsElement) {
                    inputElement.addEventListener('input', (e) => {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            searchAddresses(e.target.value, suggestionsElement, input);
                        }, 300);
                    });
                    
                    inputElement.addEventListener('blur', () => {
                        setTimeout(() => {
                            suggestionsElement.style.display = 'none';
                        }, 200);
                    });
                }
            });
            
            // Initialize price slider
            const priceSlider = document.getElementById('price-slider');
            if (priceSlider) {
                priceSlider.addEventListener('input', async () => {
                    await updatePriceDisplay();
                });
                updatePriceDisplay(); // Initial update
            }
        }

        // Add stop functionality for post ride with enhanced features
        function addStop() {
            stopCounter++;
            const stopId = `post-stop-${stopCounter}`;
            const suggestionsId = `post-stop-${stopCounter}-suggestions`;
            
            const stopHtml = `
                <div class="form-group stop-group enhanced-stop" id="stop-group-${stopCounter}" draggable="true" data-stop-id="${stopCounter}">
                    <div class="stop-header">
                        <div class="stop-drag-handle" title="Drag to reorder">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                        <label class="form-label">
                            Stop ${postStops.length + 1} - Pickup/Drop-off Point
                            <span class="stop-eta" id="eta-${stopCounter}" style="font-size: 0.8rem; color: #666; margin-left: 0.5rem;"></span>
                        </label>
                        <button type="button" class="btn-remove-stop" onclick="removeStop(${stopCounter})" title="Remove stop">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" id="${stopId}" class="form-input" placeholder="Enter convenient stop location (e.g., mall, station, landmark)">
                    <div id="${suggestionsId}" class="address-suggestions"></div>
                    <div class="stop-timing" id="timing-${stopCounter}" style="font-size: 0.75rem; color: #888; margin-top: 0.25rem; display: none;">
                        <i class="fas fa-clock"></i> <span class="arrival-time">--:--</span>
                        <span class="travel-time" style="margin-left: 1rem;"><i class="fas fa-route"></i> -- min</span>
                    </div>
                </div>
            `;
            
            document.getElementById('stops-container').insertAdjacentHTML('beforeend', stopHtml);
            postStops.push({
                id: stopCounter, 
                element: stopId, 
                suggestions: suggestionsId,
                coords: null,
                eta: null,
                travelTime: null
            });
            
            // Initialize autocomplete for the new stop
            initializeStopAutocomplete(stopId, suggestionsId);
            // Initialize drag and drop
            initializeDragAndDrop();
            updateRouteAndPrice();
        }



        // Remove stop for post ride
        function removeStop(stopId) {
            document.getElementById(`stop-group-${stopId}`).remove();
            postStops = postStops.filter(stop => stop.id !== stopId);
            updateStopLabels('post');
            updateRouteAndPrice();
        }



        // Update stop labels after removal or reordering
        function updateStopLabels(type) {
            const stops = type === 'post' ? postStops : [];
            stops.forEach((stop, index) => {
                const group = document.getElementById(`stop-group-${stop.id}`);
                if (group) {
                    const label = group.querySelector('.form-label');
                    const etaSpan = label.querySelector('.stop-eta');
                    const buttonHtml = label.innerHTML.includes('btn-remove-stop') ? 
                        label.innerHTML.substring(label.innerHTML.indexOf('<button')) : '';
                    const etaHtml = etaSpan ? etaSpan.outerHTML : '';
                    label.innerHTML = `Stop ${index + 1} - Pickup/Drop-off Point ${etaHtml} ${buttonHtml}`;
                }
            });
            // Update arrival times after reordering
            updateStopArrivalTimes();
        }

        // Initialize drag and drop functionality for stops
        function initializeDragAndDrop() {
            const stopElements = document.querySelectorAll('.enhanced-stop');
            
            stopElements.forEach(element => {
                element.addEventListener('dragstart', handleDragStart);
                element.addEventListener('dragover', handleDragOver);
                element.addEventListener('drop', handleDrop);
                element.addEventListener('dragend', handleDragEnd);
                element.addEventListener('dragenter', handleDragEnter);
                element.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedStopId = parseInt(draggedElement.dataset.stopId);
                const targetStopId = parseInt(this.dataset.stopId);
                
                // Reorder stops in array
                reorderStops(draggedStopId, targetStopId);
                
                // Insert dragged element before or after target
                const container = this.parentNode;
                const rect = this.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;
                
                if (e.clientY < midY) {
                    container.insertBefore(draggedElement, this);
                } else {
                    container.insertBefore(draggedElement, this.nextSibling);
                }
                
                updateStopLabels('post');
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.enhanced-stop').forEach(el => {
                el.classList.remove('drag-over');
            });
            updateRouteAndPrice();
        }

        function reorderStops(draggedId, targetId) {
            const draggedIndex = postStops.findIndex(stop => stop.id === draggedId);
            const targetIndex = postStops.findIndex(stop => stop.id === targetId);
            
            if (draggedIndex !== -1 && targetIndex !== -1) {
                const draggedStop = postStops.splice(draggedIndex, 1)[0];
                postStops.splice(targetIndex, 0, draggedStop);
            }
        }

        // Calculate and update estimated arrival times for stops
        function updateStopArrivalTimes() {
            if (!fromCoords || !toCoords || postStops.length === 0) {
                return;
            }

            // Get departure time
            const departureTimeInput = document.getElementById('post-time');
            if (!departureTimeInput.value) {
                return;
            }

            const [hours, minutes] = departureTimeInput.value.split(':');
            let currentTime = new Date();
            currentTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);

            // Build route points including from, stops, and to
            const routePoints = [
                { coords: fromCoords, name: 'Start' },
                ...postStops.map(stop => ({
                    coords: stop.coords,
                    name: `Stop ${postStops.indexOf(stop) + 1}`,
                    id: stop.id
                })).filter(point => point.coords),
                { coords: toCoords, name: 'End' }
            ];

            // Calculate cumulative travel times
            let cumulativeTime = 0;
            for (let i = 1; i < routePoints.length; i++) {
                if (routePoints[i-1].coords && routePoints[i].coords) {
                    const distance = calculateDistance(
                        routePoints[i-1].coords.lat, routePoints[i-1].coords.lng,
                        routePoints[i].coords.lat, routePoints[i].coords.lng
                    );
                    
                    // Estimate travel time: 50 km/h average speed + 5 min stop time
                    const travelTimeMinutes = Math.round((distance / 50) * 60);
                    cumulativeTime += travelTimeMinutes;
                    
                    if (routePoints[i].id) {
                        // Add 5 minute stop time
                        cumulativeTime += 5;
                        
                        // Calculate arrival time
                        const arrivalTime = new Date(currentTime.getTime() + cumulativeTime * 60000);
                        const arrivalTimeString = arrivalTime.toLocaleTimeString([], {
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        // Update UI elements
                        const etaElement = document.getElementById(`eta-${routePoints[i].id}`);
                        const timingElement = document.getElementById(`timing-${routePoints[i].id}`);
                        
                        if (etaElement) {
                            etaElement.textContent = `(ETA: ${arrivalTimeString})`;
                        }
                        
                        if (timingElement) {
                            const arrivalSpan = timingElement.querySelector('.arrival-time');
                            const travelSpan = timingElement.querySelector('.travel-time');
                            
                            if (arrivalSpan) {
                                arrivalSpan.textContent = arrivalTimeString;
                            }
                            if (travelSpan) {
                                travelSpan.innerHTML = `<i class="fas fa-route"></i> ${travelTimeMinutes} min`;
                            }
                            
                            timingElement.style.display = 'flex';
                        }
                    }
                }
            }
        }

        // Enhanced address selection to store coordinates
        function selectAddress(address, coords, inputId) {
            document.getElementById(inputId).value = address;
            document.getElementById(`${inputId}-suggestions`).style.display = 'none';
            
            // Store coordinates based on input ID
            if (inputId === 'post-from') {
                fromCoords = coords;
                fromCityName = address.split(',')[0];
            } else if (inputId === 'post-to') {
                toCoords = coords;
                toCityName = address.split(',')[0];
            } else if (inputId.includes('post-stop-')) {
                // Store coordinates for stops
                const stopId = parseInt(inputId.replace('post-stop-', ''));
                const stop = postStops.find(s => s.id === stopId);
                if (stop) {
                    stop.coords = coords;
                }
            }
            
            updateRouteAndPrice();
            updateStopArrivalTimes();
        }

        // Initialize autocomplete for individual stops
        function initializeStopAutocomplete(inputId, suggestionsId) {
            const inputElement = document.getElementById(inputId);
            const suggestionsElement = document.getElementById(suggestionsId);
            
            if (inputElement && suggestionsElement) {
                inputElement.addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        searchAddresses(e.target.value, suggestionsElement, inputId);
                    }, 300);
                });
                
                inputElement.addEventListener('blur', () => {
                    setTimeout(() => {
                        suggestionsElement.style.display = 'none';
                    }, 200);
                });
                
                inputElement.addEventListener('change', () => {
                    updateRouteAndPrice();
                });
            }
        }
        
        // Search addresses using Nominatim API
        async function searchAddresses(query, suggestionsElement, inputId) {
            if (query.length < 3) {
                suggestionsElement.style.display = 'none';
                return;
            }
            
            try {
                // Sanitize the query to remove special characters that might cause issues
                const sanitizedQuery = query.replace(/[^\w\s\-,]/g, '').trim();
                
                if (!sanitizedQuery) {
                    suggestionsElement.style.display = 'none';
                    return;
                }
                
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=ca&q=${encodeURIComponent(sanitizedQuery)}`,
                    {
                        headers: {
                            'User-Agent': 'OnGoPool-CarPool-App/1.0'
                        }
                    }
                );
                
                // Check if response is OK
                if (!response.ok) {
                    if (response.status === 503) {
                        console.warn('Nominatim service temporarily unavailable, retrying in 2 seconds...');
                        setTimeout(() => searchAddresses(query, suggestionsElement, inputId), 2000);
                        return;
                    }
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                // Get response text first to validate JSON
                const responseText = await response.text();
                
                // Handle empty responses
                if (!responseText || responseText.trim() === '') {
                    displaySuggestions([], suggestionsElement, inputId);
                    return;
                }
                
                try {
                    // Parse JSON manually
                    const results = JSON.parse(responseText);
                    
                    // Ensure results is an array
                    if (!Array.isArray(results)) {
                        console.warn('Nominatim API did not return an array:', results);
                        displaySuggestions([], suggestionsElement, inputId);
                        return;
                    }
                    
                    displaySuggestions(results, suggestionsElement, inputId);
                } catch (jsonError) {
                    console.error('Error parsing JSON response:', jsonError, 'Response text:', responseText);
                    displaySuggestions([], suggestionsElement, inputId);
                }
            } catch (error) {
                console.error('Error fetching addresses:', error);
                suggestionsElement.style.display = 'none';
            }
        }
        
        // Display address suggestions
        function displaySuggestions(results, suggestionsElement, inputId) {
            suggestionsElement.innerHTML = '';
            
            if (results.length === 0) {
                suggestionsElement.style.display = 'none';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                
                const main = document.createElement('div');
                main.className = 'suggestion-main';
                main.textContent = result.display_name.split(',')[0];
                
                const detail = document.createElement('div');
                detail.className = 'suggestion-detail';
                detail.textContent = result.display_name;
                
                item.appendChild(main);
                item.appendChild(detail);
                
                item.addEventListener('click', () => {
                    const coords = { lat: parseFloat(result.lat), lng: parseFloat(result.lon) };
                    selectAddress(result.display_name, coords, inputId);
                    suggestionsElement.style.display = 'none';
                });
                
                suggestionsElement.appendChild(item);
            });
            
            suggestionsElement.style.display = 'block';
        }
        
        // Extract city name from Nominatim address components
        function extractCityName(result) {
            const address = result.address || {};
            
            // Priority order for city identification
            return address.city || 
                   address.town || 
                   address.village || 
                   address.municipality || 
                   address.county || 
                   address.state_district ||
                   result.display_name.split(',')[0]; // Fallback to first part of display name
        }
        
        // Legacy function - keeping for compatibility, but using enhanced version above
        
        // Initialize maps when tabs are switched
        function initializeMap(mapId, containerId) {
            // Remove existing map if any
            if (mapId === 'post' && postMap) {
                postMap.remove();
                postMap = null;
            } else if (mapId === 'find' && findMap) {
                findMap.remove();
                findMap = null;
            }
            
            // Create new map
            const map = L.map(containerId).setView([40.7128, -74.0060], 13); // Default to New York
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Store map reference
            if (mapId === 'post') {
                postMap = map;
            } else if (mapId === 'find') {
                findMap = map;
            }
            
            return map;
        }
        
        // Update post ride map
        function updatePostMap() {
            if (!postMap) {
                postMap = initializeMap('post', 'post-map');
            }
            
            if (fromCoords && toCoords) {
                // Clear existing markers and routes
                postMap.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        postMap.removeLayer(layer);
                    }
                });
                
                // Add markers
                L.marker(fromCoords).addTo(postMap).bindPopup('From');
                L.marker(toCoords).addTo(postMap).bindPopup('To');
                
                // Fit map to show both points
                const group = new L.FeatureGroup([
                    L.marker(fromCoords),
                    L.marker(toCoords)
                ]);
                postMap.fitBounds(group.getBounds().pad(0.1));
                
                // Draw simple line (for visualization)
                L.polyline([fromCoords, toCoords], {color: '#6C63FF', weight: 3}).addTo(postMap);
            }
        }
        
        // Update find rides map
        function updateFindMap() {
            if (!findMap) {
                findMap = initializeMap('find', 'find-map');
            }
            
            if (fromCoords && toCoords) {
                // Clear existing markers and routes
                findMap.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        findMap.removeLayer(layer);
                    }
                });
                
                // Add markers
                L.marker(fromCoords).addTo(findMap).bindPopup('From');
                L.marker(toCoords).addTo(findMap).bindPopup('To');
                
                // Fit map to show both points
                const group = new L.FeatureGroup([
                    L.marker(fromCoords),
                    L.marker(toCoords)
                ]);
                findMap.fitBounds(group.getBounds().pad(0.1));
                
                // Draw simple line (for visualization)
                L.polyline([fromCoords, toCoords], {color: '#6C63FF', weight: 3}).addTo(findMap);
            }
        }
        
        // Geocode address to get coordinates
        async function geocodeAddress(address) {
            if (!address || typeof address !== 'string') {
                console.warn('Invalid address provided to geocodeAddress:', address);
                return null;
            }
            
            // Sanitize the address to remove special characters that might cause issues
            const sanitizedAddress = address.replace(/[^\w\s\-,]/g, '').trim();
            
            if (!sanitizedAddress) {
                console.warn('Address contains only special characters or is empty after sanitization');
                return null;
            }
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&countrycodes=ca&q=${encodeURIComponent(sanitizedAddress)}`,
                    {
                        headers: {
                            'User-Agent': 'OnGoPool-CarPool-App/1.0'
                        }
                    }
                );
                
                // Check if response is OK
                if (!response.ok) {
                    if (response.status === 503) {
                        console.warn('Nominatim service temporarily unavailable for geocoding');
                        return null;
                    }
                    throw new Error(`HTTP error: ${response.status}`);
                }
                
                // Get response text first to validate JSON
                const responseText = await response.text();
                
                // Handle empty responses
                if (!responseText || responseText.trim() === '') {
                    return null;
                }
                
                try {
                    // Parse JSON manually
                    const results = JSON.parse(responseText);
                    
                    // Ensure results is an array
                    if (!Array.isArray(results)) {
                        console.warn('Nominatim API did not return an array:', results);
                        return null;
                    }
                    
                    if (results.length > 0) {
                        const lat = parseFloat(results[0].lat);
                        const lon = parseFloat(results[0].lon);
                        
                        if (isNaN(lat) || isNaN(lon)) {
                            console.warn('Invalid coordinates returned from Nominatim API:', results[0]);
                            return null;
                        }
                        
                        return [lat, lon];
                    }
                    return null;
                } catch (jsonError) {
                    console.error('Error parsing JSON response:', jsonError, 'Response text:', responseText);
                    return null;
                }
            } catch (error) {
                console.error('Error geocoding address:', error);
                return null;
            }
        }
        
        // Alias for geocodeAddress function to maintain compatibility
        async function getCoordinates(address) {
            return await geocodeAddress(address);
        }
        
        // Calculate distance using Haversine formula with 25% road factor
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const straightDistance = R * c;
            
            // Add 25% for road distance
            return straightDistance * 1.25;
        }
        
        // Calculate route and update display with multi-stop support
        async function updateRouteAndPrice() {
            const fromValue = document.getElementById('post-from').value;
            const toValue = document.getElementById('post-to').value;
            
            if (!fromValue || !toValue) return;
            
            const fromCoords = await getCoordinates(fromValue);
            const toCoords = await getCoordinates(toValue);
            
            if (!fromCoords || !toCoords) return;
            
            // Get all stop coordinates
            const allStops = [];
            allStops.push(fromCoords); // Start point
            
            // Add intermediate stops
            for (const stop of postStops) {
                const stopValue = document.getElementById(stop.element).value;
                if (stopValue) {
                    const stopCoords = await getCoordinates(stopValue);
                    if (stopCoords) {
                        allStops.push(stopCoords);
                    }
                }
            }
            
            allStops.push(toCoords); // End point
            
            // Calculate total distance through all stops
            let totalDistance = 0;
            for (let i = 0; i < allStops.length - 1; i++) {
                totalDistance += calculateDistance(allStops[i][0], allStops[i][1], allStops[i+1][0], allStops[i+1][1]);
            }
            
            routeDistance = totalDistance;
            const estimatedTime = Math.round(totalDistance * 1.5); // Roughly 1.5 minutes per km
            
            // Calculate suggested price within allowed range (0.15-0.25 per km)
            const suggestedPrice = Math.max(totalDistance * MIN_PRICE_PER_KM, Math.min(totalDistance * MAX_PRICE_PER_KM, totalDistance * 0.20));
            
            // Update route info display
            document.getElementById('route-distance').textContent = totalDistance.toFixed(1);
            document.getElementById('route-time').textContent = estimatedTime;
            document.getElementById('suggested-price').textContent = suggestedPrice.toFixed(2);
            document.getElementById('route-info').style.display = 'block';
            
            // Update price slider to suggested price and set limits
            const priceSlider = document.getElementById('price-slider');
            if (priceSlider) {
                // Set dynamic min and max based on route distance
                const minAllowed = totalDistance * MIN_PRICE_PER_KM;
                const maxAllowed = totalDistance * MAX_PRICE_PER_KM;
                
                priceSlider.min = minAllowed.toFixed(2);
                priceSlider.max = maxAllowed.toFixed(2);
                priceSlider.value = suggestedPrice.toFixed(2);
                
                // Update slider range display
                const rangeDisplay = priceSlider.parentElement.querySelector('.slider-range-display');
                if (rangeDisplay) {
                    rangeDisplay.innerHTML = `<span>$${minAllowed.toFixed(2)}</span><span>$${maxAllowed.toFixed(2)}</span>`;
                }
                
                await updatePriceDisplay();
            }
            
            // Update map with all stops
            updateMapWithStops(allStops);
        }

        // Update map to show all stops
        function updateMapWithStops(allStops) {
            if (!postMap || allStops.length < 2) return;
            
            // Clear existing markers and lines
            postMap.eachLayer((layer) => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                    postMap.removeLayer(layer);
                }
            });
            
            // Calculate center point of all stops
            const centerLat = allStops.reduce((sum, coords) => sum + coords[0], 0) / allStops.length;
            const centerLng = allStops.reduce((sum, coords) => sum + coords[1], 0) / allStops.length;
            postMap.setView([centerLat, centerLng], 10);
            
            // Add markers for all stops
            const markers = [];
            allStops.forEach((coords, index) => {
                let popupText, iconColor;
                if (index === 0) {
                    popupText = 'Start: ' + document.getElementById('post-from').value;
                    iconColor = 'green';
                } else if (index === allStops.length - 1) {
                    popupText = 'End: ' + document.getElementById('post-to').value;
                    iconColor = 'red';
                } else {
                    const stopElement = document.getElementById(postStops[index - 1].element);
                    popupText = 'Stop ' + index + ': ' + (stopElement ? stopElement.value : 'Unknown');
                    iconColor = 'blue';
                }
                
                const marker = L.marker(coords).addTo(postMap).bindPopup(popupText);
                markers.push(marker);
            });
            
            // Add route line through all stops
            const routeLine = L.polyline(allStops, {color: 'blue', weight: 3}).addTo(postMap);
            markers.push(routeLine);
            
            // Fit map to show all markers
            const group = new L.featureGroup(markers);
            postMap.fitBounds(group.getBounds().pad(0.1));
        }

        // Legacy function for backward compatibility
        async function calculateRoute() {
            await updateRouteAndPrice();
        }
        
        // Update price display and breakdown
        async function updatePriceDisplay() {
            const priceSlider = document.getElementById('price-slider');
            const priceDisplay = document.getElementById('price-display');
            const basePriceElement = document.getElementById('base-price');
            const serviceFeeElement = document.getElementById('service-fee');
            const totalPriceElement = document.getElementById('total-price');
            const breakdownElement = document.getElementById('price-breakdown');
            const validationMessageElement = document.getElementById('price-validation-message');
            
            if (!priceSlider) return;
            
            const totalPrice = parseFloat(priceSlider.value);
            const serviceFee = totalPrice * 0.12; // 12% service fee included in total
            const driverPortion = totalPrice - serviceFee;
            
            // Validate price per km if route distance is available
            let isValidPrice = true;
            let validationMessage = '';
            
            if (routeDistance > 0) {
                const pricePerKm = totalPrice / routeDistance;
                const minAllowed = MIN_PRICE_PER_KM;
                const maxAllowed = MAX_PRICE_PER_KM;
                
                // Check if user has price constraint override
                // Made function async to properly handle admin override status
                let hasPriceOverride = false;
                if (currentUser) {
                    try {
                        hasPriceOverride = await checkPriceOverride(currentUser.id);
                    } catch (error) {
                        console.error('Error checking price override:', error);
                        hasPriceOverride = false;
                    }
                }
                
                if (hasPriceOverride) {
                    // Admin override is active, allow any price
                    isValidPrice = true;
                    validationMessage = `✅ Admin override active: No price constraints ($${pricePerKm.toFixed(2)}/km)`;
                } else {
                    // No override, enforce platform limits
                    if (pricePerKm < minAllowed) {
                        isValidPrice = false;
                        validationMessage = `⚠️ Price too low! Minimum: $${(routeDistance * minAllowed).toFixed(2)} ($${minAllowed.toFixed(2)}/km)`;
                        
                        // Force price to minimum allowed value
                        if (priceSlider.value < (routeDistance * minAllowed)) {
                            priceSlider.value = (routeDistance * minAllowed).toFixed(2);
                        }
                    } else if (pricePerKm > maxAllowed) {
                        isValidPrice = false;
                        validationMessage = `⚠️ Price too high! Maximum: $${(routeDistance * maxAllowed).toFixed(2)} ($${maxAllowed.toFixed(2)}/km)`;
                        
                        // Force price to maximum allowed value
                        if (priceSlider.value > (routeDistance * maxAllowed)) {
                            priceSlider.value = (routeDistance * maxAllowed).toFixed(2);
                        }
                    } else {
                        isValidPrice = true;
                        validationMessage = `✅ Valid price: $${pricePerKm.toFixed(2)} per km`;
                    }
                }
                
                // Show validation message
                if (validationMessageElement) {
                    validationMessageElement.textContent = validationMessage;
                    validationMessageElement.style.display = 'block';
                    validationMessageElement.style.color = isValidPrice ? 'var(--success-color)' : 'var(--error-color)';
                }
                
                // Style the slider based on validation
                priceSlider.style.accentColor = isValidPrice ? 'var(--primary-color)' : 'var(--error-color)';
            } else {
                // Hide validation message if no route is set
                if (validationMessageElement) {
                    validationMessageElement.style.display = 'none';
                }
                priceSlider.style.accentColor = 'var(--primary-color)';
            }
            
            // Update displays
            priceDisplay.textContent = totalPrice.toFixed(2);
            const driverPortionElement = document.getElementById('driver-portion');
            if (driverPortionElement) driverPortionElement.textContent = driverPortion.toFixed(2);
            if (serviceFeeElement) serviceFeeElement.textContent = serviceFee.toFixed(2);
            if (totalPriceElement) totalPriceElement.textContent = totalPrice.toFixed(2);
            
            // Show breakdown if price is greater than 0
            if (breakdownElement) {
                if (totalPrice > 0) {
                    breakdownElement.style.display = 'block';
                } else {
                    breakdownElement.style.display = 'none';
                }
            }
            
            // Store validation state for form submission
            priceSlider.dataset.isValid = isValidPrice.toString();
        }
        
        // Search for rides
        async function searchRides() {
            const fromValue = document.getElementById('find-from').value;
            const toValue = document.getElementById('find-to').value;
            const dateValue = document.getElementById('find-date').value;
            
            if (!fromValue || !toValue) {
                alert('Please enter both pickup and destination locations.');
                return;
            }
            
            try {
                // Show loading state
                const resultsDiv = document.getElementById('ride-results');
                const searchResultsDiv = document.getElementById('search-results');
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner" style="margin-bottom: 1rem;"></div>
                        <p>Searching for rides...</p>
                    </div>
                `;
                searchResultsDiv.style.display = 'block';

                // First get coordinates for the from and to locations
                const [fromCoords, toCoords] = await Promise.all([
                    geocodeAddress(fromValue),
                    geocodeAddress(toValue)
                ]);
                
                if (!fromCoords || !toCoords) {
                    resultsDiv.innerHTML = `
                        <div style="text-align: center; padding: 2rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #ffc107; margin-bottom: 1rem;"></i>
                            <h3>Location not found</h3>
                            <p>We couldn't find one or both of your locations. Please try entering more specific city names.</p>
                        </div>
                    `;
                    return;
                }
                
                // Extract the city names for filtering
                const fromCity = extractCityName(fromValue);
                const toCity = extractCityName(toValue);
                
                console.log(`Searching from ${fromCity} to ${toCity}`);
                console.log(`From coordinates: ${fromCoords[0]}, ${fromCoords[1]}`);
                console.log(`To coordinates: ${toCoords[0]}, ${toCoords[1]}`);
                
                // Search for rides in the database
                let query = supabase
                    .from('rides')
                    .select('*, users(full_name, driver_rating)')
                    .gt('available_seats', 0)
                    .gte('departure_time', new Date().toISOString()); // Only future rides
                
                if (dateValue) {
                    // Extract date part from departure_time for comparison
                    const startOfDay = new Date(dateValue + 'T00:00:00.000Z').toISOString();
                    const endOfDay = new Date(dateValue + 'T23:59:59.999Z').toISOString();
                    query = query.gte('departure_time', startOfDay).lte('departure_time', endOfDay);
                }
                
                const { data: allRides, error } = await query;
                
                if (error) {
                    console.error('Error searching rides:', error);
                    alert('Error searching for rides: ' + error.message);
                    return;
                }
                
                // Filter rides by city name and search radius
                const SEARCH_RADIUS_KM = 25; // 25km radius search
                
                // First get all rides with valid coordinates
                let filteredRides = allRides.filter(ride => {
                    // Check if the ride has departure and destination coordinates (using correct database field names)
                    if (!ride.departure_latitude || !ride.departure_longitude || !ride.destination_latitude || !ride.destination_longitude) {
                        console.log('Ride missing coordinates:', ride.id, {
                            departure_latitude: ride.departure_latitude,
                            departure_longitude: ride.departure_longitude,
                            destination_latitude: ride.destination_latitude,
                            destination_longitude: ride.destination_longitude
                        });
                        return false;
                    }
                    return true;
                });
                
                // Then fetch stops for all these rides
                try {
                    // Batch fetch stops for all rides
                    const rideIds = filteredRides.map(ride => ride.id);
                    console.log('Fetching stops for rides:', rideIds);
                    
                    if (rideIds.length > 0) {
                        const { data: allStops, error: stopsError } = await supabase
                            .from('ride_stops')
                            .select('*')
                            .in('ride_id', rideIds);
                            
                        if (stopsError) {
                            console.error('Error fetching ride stops:', stopsError);
                        } else if (allStops && allStops.length > 0) {
                            // Group stops by ride_id
                            const stopsByRide = {};
                            allStops.forEach(stop => {
                                if (!stopsByRide[stop.ride_id]) {
                                    stopsByRide[stop.ride_id] = [];
                                }
                                stopsByRide[stop.ride_id].push(stop);
                            });
                            
                            // Add stops to each ride
                            filteredRides.forEach(ride => {
                                if (stopsByRide[ride.id]) {
                                    ride.stops = stopsByRide[ride.id].sort((a, b) => a.stop_order - b.stop_order);
                                }
                            });
                            
                            console.log('Added stops to rides:', stopsByRide);
                        }
                    }
                } catch (error) {
                    console.error('Error processing ride stops:', error);
                }
                
                // Now filter rides based on search criteria
                filteredRides = filteredRides.filter(ride => {
                    // Check city name match - case insensitive partial match
                    const rideDepartureAddress = (ride.departure_address || '').toLowerCase();
                    const rideDestinationAddress = (ride.destination_address || '').toLowerCase();
                    
                    const fromCityMatch = fromCity ? rideDepartureAddress.includes(fromCity.toLowerCase()) : true;
                    const toCityMatch = toCity ? rideDestinationAddress.includes(toCity.toLowerCase()) : true;
                    
                    // If city names match, include the ride
                    if (fromCityMatch && toCityMatch) {
                        console.log('City match found:', ride.id, rideDepartureAddress, rideDestinationAddress);
                        return true;
                    }
                    
                    // Check for matches with stops
                    if (ride.stops && ride.stops.length > 0) {
                        for (const stop of ride.stops) {
                            if (!stop.latitude || !stop.longitude) continue;
                            
                            // Check if passenger pickup is near any stop
                            const stopToFromDistance = calculateDistance(
                                fromCoords[0], fromCoords[1], 
                                parseFloat(stop.latitude), parseFloat(stop.longitude)
                            );
                            
                            // Check if passenger destination is near any stop
                            const stopToToDistance = calculateDistance(
                                toCoords[0], toCoords[1], 
                                parseFloat(stop.latitude), parseFloat(stop.longitude)
                            );
                            
                            // If either the pickup or drop-off is near a stop, consider it a match
                            if (stopToFromDistance <= SEARCH_RADIUS_KM || stopToToDistance <= SEARCH_RADIUS_KM) {
                                console.log('Stop match found:', ride.id, `stop to from: ${stopToFromDistance}km, stop to to: ${stopToToDistance}km`);
                                return true;
                            }
                        }
                    }
                    
                    // Otherwise check main route distance within search radius
                    const fromDistance = calculateDistance(
                        fromCoords[0], fromCoords[1], 
                        parseFloat(ride.departure_latitude), parseFloat(ride.departure_longitude)
                    );
                    
                    const toDistance = calculateDistance(
                        toCoords[0], toCoords[1], 
                        parseFloat(ride.destination_latitude), parseFloat(ride.destination_longitude)
                    );
                    
                    // Consider a match if either the start or end points are within the search radius
                    const isWithinRadius = (fromDistance <= SEARCH_RADIUS_KM || toDistance <= SEARCH_RADIUS_KM);
                    if (isWithinRadius) {
                        console.log('Distance match found:', ride.id, `from: ${fromDistance}km, to: ${toDistance}km`);
                    }
                    return isWithinRadius;
                });
                
                console.log(`Found ${filteredRides.length} rides out of ${allRides.length} total rides`);
                
                // Enhance results with AI recommendations
                const searchParams = {
                    from: fromValue,
                    to: toValue,
                    fromCoords: fromCoords,
                    toCoords: toCoords,
                    departure_time: dateValue ? new Date(dateValue).toISOString() : new Date().toISOString()
                };
                
                const enhancedRides = await enhanceSearchWithAI(filteredRides, searchParams);
                displayRideResults(enhancedRides, fromValue, toValue);
            } catch (error) {
                console.error('Search error:', error);
                alert('Error searching for rides: ' + error.message);
                
                // Show error state
                const resultsDiv = document.getElementById('ride-results');
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: rgba(244, 67, 54, 0.1); border-radius: 8px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 2rem; color: #f44336; margin-bottom: 1rem;"></i>
                        <h3>Search Error</h3>
                        <p>${error.message || 'An error occurred while searching for rides'}</p>
                    </div>
                `;
            }
            
            // Initialize find map if not already done
            if (!findMap) {
                findMap = initializeMap('find', 'find-map');
            }
        }
        
        // Helper function to extract city name from address
        function extractCityName(address) {
            if (!address) return '';
            
            // Split by common delimiters and get the first part which is usually the city
            const parts = address.split(/,|;|-|\|/);
            return parts[0].trim();
        }
        
        function displayRideResults(rides, fromValue, toValue) {
            const resultsDiv = document.getElementById('ride-results');
            const searchResultsDiv = document.getElementById('search-results');
            
            if (rides.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 193, 7, 0.1); border-radius: 8px;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; color: #ffc107; margin-bottom: 1rem;"></i>
                        <h3>No rides found</h3>
                        <p>No rides available for your selected route and date. Try searching for a different date or check back later.</p>
                    </div>
                `;
                searchResultsDiv.style.display = 'block';
                return;
            }
            
            // Show AI recommendations banner if any rides are AI-recommended
            const aiRecommended = rides.filter(r => r.aiRecommended);
            let aiHeader = '';
            if (aiRecommended.length > 0) {
                aiHeader = `
                    <div style="background: linear-gradient(135deg, #6C63FF, #4FD1C5); color: white; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-brain"></i>
                        <div>
                            <div style="font-weight: 600; font-size: 0.9rem;">🧠 AI Recommendations</div>
                            <div style="font-size: 0.75rem; opacity: 0.9;">${aiRecommended.length} highly matched rides found based on your preferences</div>
                        </div>
                    </div>
                `;
            }
            
            let resultsHTML = '';
            rides.forEach((ride, index) => {
                const departureDateTime = new Date(ride.departure_time);
                const formattedTime = departureDateTime.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true 
                });
                
                // Check if driver is verified
                let verificationBadge = '';
                if (ride.users?.license_verified) {
                    verificationBadge = `<span class="verification-badge" title="Verified Driver" style="color: var(--success-color); margin-left: 0.25rem;"><i class="fas fa-check-circle"></i></span>`;
                }
                
                // Generate driver profile photo
                const driverName = ride.users?.full_name || 'Driver';
                const profilePhoto = `https://ui-avatars.com/api/?name=${encodeURIComponent(driverName)}&background=6c63ff&color=ffffff&size=40&rounded=true`;
                
                // Car info with icons
                const carInfo = ride.vehicle_details || 'Vehicle details not provided';
                const carIcons = `
                    <span style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.6rem; margin-right: 0.3rem;">M</span>
                    <i class="fas fa-snowflake" style="color: #2196F3; font-size: 0.8rem; margin-right: 0.3rem;"></i>
                    <span style="color: #666; font-size: 0.7rem;">+2 more</span>
                `;
                
                resultsHTML += `
                    <div style="background: white; border-radius: 16px; padding: 0; margin-bottom: 1rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; overflow: hidden;">
                        <!-- Header with time and seats -->
                        <div style="padding: 1rem 1.25rem 0.75rem 1.25rem;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="font-size: 1.1rem; font-weight: 600; color: #1a1a1a; margin-bottom: 0.25rem;">
                                        ${departureDateTime.toLocaleDateString()} at ${formattedTime}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">
                                        ${ride.available_seats} seats left
                                    </div>
                                    <div style="font-size: 1.3rem; font-weight: 700; color: #2196F3;">
                                        $${(() => {
                                            // Calculate total price if not available (for legacy rides)
                                            let price = ride.total_price_per_seat;
                                            if (!price || price === 0 || price === '0' || price === 'undefined') {
                                                const basePrice = parseFloat(ride.price_per_seat) || 0;
                                                price = (basePrice * 1.12).toFixed(2); // Add 12% service fee
                                            }
                                            
                                            if (!price || price === 'undefined') return '0.00';
                                            return typeof price === 'number' ? price.toFixed(2) : parseFloat(price).toFixed(2);
                                        })()}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Route with clean design -->
                            <div style="margin-bottom: 0.75rem;">
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="width: 4px; height: 12px; background: #2196F3; border-radius: 2px; margin-right: 0.75rem;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: #1a1a1a; font-size: 1rem;">
                                            ${(() => {
                                                const addr = ride.departure_address || ride.origin_address || 'Unknown Location';
                                                if (addr === 'undefined' || !addr) return 'Unknown Location';
                                                return addr.split(',')[0].trim() || addr;
                                            })()}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #666;">
                                            ${(() => {
                                                const addr = ride.departure_address || ride.origin_address || '';
                                                if (addr === 'undefined' || !addr) return '';
                                                return addr.includes(',') ? addr.split(',').slice(1).join(',').trim() : '';
                                            })()}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div style="width: 4px; height: 12px; background: #666; border-radius: 2px; margin-right: 0.75rem;"></div>
                                    <div>
                                        <div style="font-weight: 600; color: #1a1a1a; font-size: 1rem;">
                                            ${(() => {
                                                const addr = ride.destination_address || 'Unknown Destination';
                                                if (addr === 'undefined' || !addr) return 'Unknown Destination';
                                                return addr.split(',')[0].trim() || addr;
                                            })()}
                                        </div>
                                        <div style="font-size: 0.85rem; color: #666;">
                                            ${(() => {
                                                const addr = ride.destination_address || '';
                                                if (addr === 'undefined' || !addr) return '';
                                                return addr.includes(',') ? addr.split(',').slice(1).join(',').trim() : '';
                                            })()}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${ride.stops && ride.stops.length > 0 ? `
                            <!-- Intermediate Stops -->
                            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #28a745;">
                                <div style="font-size: 0.85rem; font-weight: 600; color: #28a745; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-route"></i> ${ride.stops.length} Intermediate Stop${ride.stops.length > 1 ? 's' : ''}
                                </div>
                                ${ride.stops.map((stop, index) => `
                                    <div style="display: flex; align-items: center; margin-bottom: 0.25rem;">
                                        <div style="width: 3px; height: 8px; background: #28a745; border-radius: 1px; margin-right: 0.5rem;"></div>
                                        <span style="font-size: 0.8rem; color: #666;">
                                            ${stop.address ? stop.address.split(',')[0].trim() : `Stop ${index + 1}`}
                                        </span>
                                    </div>
                                `).join('')}
                                <div style="font-size: 0.75rem; color: #28a745; margin-top: 0.25rem;">
                                    <i class="fas fa-info-circle"></i> Driver can pick up/drop off at these convenient stops
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Car info -->
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <span style="font-size: 0.9rem; color: #666; font-weight: 500;">${carInfo}</span>
                                ${carIcons}
                            </div>
                        </div>
                        
                        <!-- Driver info section -->
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.25rem; background: #fafafa; border-top: 1px solid #f0f0f0;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <img src="${profilePhoto}" 
                                     style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0;" 
                                     alt="${driverName}">
                                <div>
                                    <div style="font-weight: 600; color: #1a1a1a; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem;">
                                        ${driverName} ${verificationBadge}
                                        ${ride.aiRecommended ? '<span style="background: linear-gradient(45deg, #6C63FF, #4FD1C5); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.6rem; font-weight: 600;"><i class="fas fa-brain"></i> AI Match</span>' : ''}
                                        ${ride.aiScore ? `<span style="color: #666; font-size: 0.7rem;">${Math.round(ride.aiScore * 100)}% match</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Verification badge -->
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="background: #2196F3; color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem;">
                                    <i class="fas fa-shield-alt"></i>
                                    <span style="font-size: 0.7rem;">1 driven</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="padding: 0.75rem 1.25rem; border-top: 1px solid #f0f0f0; background: white;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="requestRide('${ride.id}', '${driverName}', '${(() => {
                                    // Get price with fallbacks
                                    let price = ride.total_price_per_seat || ride.total_price || ride.price_per_seat;
                                    
                                    // Calculate price if still not available
                                    if (!price || price === 0 || price === '0' || price === 'undefined') {
                                        // Get base price, default to 0 if not available
                                        const basePrice = parseFloat(ride.price_per_seat) || 0;
                                        // Calculate total price with 12% service fee
                                        price = basePrice * 1.12;
                                    }
                                    
                                    // Ensure price is a valid number
                                    if (!price || isNaN(price) || price === 'undefined') {
                                        return '0.00';
                                    }
                                    
                                    // Format price to 2 decimal places
                                    return typeof price === 'number' ? price.toFixed(2) : parseFloat(price).toFixed(2);
                                })()}')" style="background: #2196F3; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500; flex: 1;">
                                    Request Seat
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = aiHeader + resultsHTML;
            searchResultsDiv.style.display = 'block';
        }
        
        async function requestRide(rideId, driverName, price) {
            if (!currentUser) {
                alert('Please log in to request a ride');
                return;
            }
            
            // Open the booking modal to collect pickup/dropoff addresses
            openBookingModal(rideId, driverName, price);
        }
        
        // Open booking modal with ride details
        function openBookingModal(rideId, driverName, price) {
            document.getElementById('booking-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Save current booking data for reference
            currentBookingData = {
                id: rideId,
                driverName: driverName,
                price: price
            };
            
            // Populate modal with ride details
            document.getElementById('booking-driver-name').textContent = driverName;
            document.getElementById('booking-price').textContent = `$${price} per seat`;
            
            // Get ride details to show in modal
            getRideDetails(rideId);
        }
        
        // Get ride details for booking
        async function getRideDetails(rideId) {
            try {
                const { data: ride, error } = await supabase
                    .from('rides')
                    .select('*, users(full_name, driver_rating)')
                    .eq('id', rideId)
                    .single();
                
                if (error) {
                    console.error('Error fetching ride details:', error);
                    return;
                }
                
                // Get ride stops if any
                const { data: stops, error: stopsError } = await supabase
                    .from('ride_stops')
                    .select('*')
                    .eq('ride_id', rideId)
                    .order('stop_order', { ascending: true });
                
                if (stopsError) {
                    console.error('Error fetching ride stops:', stopsError);
                } else if (stops && stops.length > 0) {
                    ride.stops = stops;
                    displayBookingStops(stops);
                }
                
                // Update current booking data with details
                Object.assign(currentBookingData, {
                    fromCity: ride.origin_address || ride.departure_address,
                    toCity: ride.destination_address,
                    date: new Date(ride.departure_time).toLocaleDateString(),
                    time: new Date(ride.departure_time).toLocaleTimeString(),
                    available_seats: ride.available_seats,
                    origin_lat: ride.departure_latitude,
                    origin_lng: ride.departure_longitude,
                    destination_lat: ride.destination_latitude,
                    destination_lng: ride.destination_longitude
                });
                
                // Update UI
                const origin = ride.departure_address || 'Origin';
                const destination = ride.destination_address || 'Destination';
                
                document.getElementById('booking-route').textContent = `${origin} → ${destination}`;
                document.getElementById('booking-datetime').textContent = `${new Date(ride.departure_time).toLocaleDateString()} at ${new Date(ride.departure_time).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'})}`;
                document.getElementById('booking-driver-rating').textContent = `${ride.users?.driver_rating || '4.5'} ⭐`;
                
                // Set placeholder values for pickup/dropoff addresses to help users
                document.getElementById('booking-pickup').placeholder = `Enter exact pickup address near ${origin}`;
                document.getElementById('booking-dropoff').placeholder = `Enter exact dropoff address near ${destination}`;
                
                // Update route labels on the visual map
                const routeStartLabel = document.getElementById('route-start-label');
                if (routeStartLabel) {
                    routeStartLabel.textContent = origin.split(',')[0];
                }
                
                const routeDestinationLabel = document.getElementById('route-destination-label');
                if (routeDestinationLabel) {
                    routeDestinationLabel.textContent = destination.split(',')[0];
                }
                
                // Update booking summary
                const price = ride.total_price_per_seat || ride.price_per_seat || '0.00';
                const bookingSummaryPrice = document.getElementById('booking-summary-price');
                if (bookingSummaryPrice) {
                    bookingSummaryPrice.textContent = `$${typeof price === 'number' ? price.toFixed(2) : price}`;
                    updateBookingSummary();
                }
            } catch (error) {
                console.error('Error processing ride details:', error);
            }
        }
        
        // Display available stops for pickup/dropoff selection
        function displayBookingStops(stops) {
            if (!stops || stops.length === 0) return;
            
            const pickupStopsContainer = document.getElementById('booking-pickup-stops');
            const dropoffStopsContainer = document.getElementById('booking-dropoff-stops');
            const pickupStopsList = document.getElementById('booking-pickup-stops-list');
            const dropoffStopsList = document.getElementById('booking-dropoff-stops-list');
            
            if (pickupStopsContainer && dropoffStopsContainer) {
                pickupStopsContainer.style.display = 'block';
                dropoffStopsContainer.style.display = 'block';
                
                let pickupStopsHTML = '';
                let dropoffStopsHTML = '';
                
                stops.forEach((stop, index) => {
                    const stopAddress = stop.address || `Stop ${index + 1}`;
                    const shortAddress = stopAddress.split(',')[0];
                    
                    const stopHTML = `
                        <div style="padding: 0.5rem; border-bottom: 1px solid #e9ecef; cursor: pointer; transition: background-color 0.2s;"
                             onmouseover="this.style.backgroundColor='#e9ecef'"
                             onmouseout="this.style.backgroundColor='transparent'"
                             onclick="selectBookingStop('${stopAddress}', '${stop.stop_type}')">
                            <div style="font-weight: 500; color: #333; font-size: 0.9rem;">
                                <i class="fas fa-map-marker-alt" style="color: #28a745; margin-right: 0.5rem;"></i>
                                ${shortAddress}
                            </div>
                            <div style="font-size: 0.75rem; color: #666; margin-left: 1.2rem;">
                                ${stopAddress.includes(',') ? stopAddress.split(',').slice(1).join(',').trim() : ''}
                            </div>
                        </div>
                    `;
                    
                    pickupStopsHTML += stopHTML.replace("selectBookingStop('${stopAddress}', '${stop.stop_type}')", `selectBookingStop('${stopAddress}', 'pickup')`);
                    dropoffStopsHTML += stopHTML.replace("selectBookingStop('${stopAddress}', '${stop.stop_type}')", `selectBookingStop('${stopAddress}', 'dropoff')`);
                });
                
                pickupStopsList.innerHTML = pickupStopsHTML;
                dropoffStopsList.innerHTML = dropoffStopsHTML;
            }
        }
        
        // Select a stop for pickup or dropoff
        function selectBookingStop(address, type) {
            if (type === 'pickup') {
                document.getElementById('booking-pickup').value = address;
            } else {
                document.getElementById('booking-dropoff').value = address;
            }
        }
        
        // Rest of the existing getRideDetails function
        function finishGetRideDetails(ride) {
            try {
                console.error('Error in getRideDetails:', error);
            }
        }
        
        // Update booking summary
        function updateBookingSummary() {
            const priceElement = document.getElementById('booking-summary-price');
            const seatsElement = document.getElementById('booking-seats');
            const totalElement = document.getElementById('booking-summary-total');
            
            if (priceElement && seatsElement && totalElement) {
                const priceText = priceElement.textContent.replace('$', '');
                const price = parseFloat(priceText);
                const seats = parseInt(seatsElement.value);
                
                if (!isNaN(price) && !isNaN(seats)) {
                    const total = (price * seats).toFixed(2);
                    totalElement.textContent = `$${total}`;
                }
            }
        }
        
        // Initialize booking summary updates
        document.addEventListener('DOMContentLoaded', function() {
            const seatsSelect = document.getElementById('booking-seats');
            if (seatsSelect) {
                seatsSelect.addEventListener('change', updateBookingSummary);
            }
        });
        
        // Close booking modal
        function closeBookingModal() {
            document.getElementById('booking-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
            
            // Clear form fields
            document.getElementById('booking-pickup').value = '';
            document.getElementById('booking-dropoff').value = '';
            document.getElementById('booking-pickup-notes').value = '';
            document.getElementById('booking-dropoff-notes').value = '';
            document.getElementById('booking-seats').value = '1';
        }
        
        // Post a ride with stops support
        async function postRide() {
            if (!currentUser) {
                alert('Please log in to post a ride');
                return;
            }
            
            // Check license verification status for drivers first
            try {
                // Get user type
                const userType = document.getElementById('user-type').value;
                
                // For drivers and both, verify license status
                if (userType === 'driver' || userType === 'both') {
                    // Get latest license verification status from the database
                    const { data, error } = await supabase
                        .from('users')
                        .select('license_verified')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error) {
                        console.error('Error checking license verification status:', error);
                        // Don't block the user from proceeding if there's an error checking status
                    } else if (data && !data.license_verified) {
                        // If license is not verified
                        alert('You must verify your driver\'s license before posting rides. Please go to your profile to complete the verification process.');
                        switchTab('profile'); // Redirect to profile page
                        return;
                    }
                }
            } catch (error) {
                console.error('Error verifying license status:', error);
                // Continue posting ride even if verification check fails
            }
            
            const fromValue = document.getElementById('post-from').value;
            const toValue = document.getElementById('post-to').value;
            
            // Collect all stops
            const stops = [];
            postStops.forEach(stop => {
                const stopValue = document.getElementById(stop.element).value;
                if (stopValue) {
                    stops.push(stopValue);
                }
            });
            const dateValue = document.getElementById('post-date').value;
            const timeValue = document.getElementById('post-time').value;
            const seatsValue = document.getElementById('post-seats').value;
            const priceSlider = document.getElementById('price-slider');
            const priceValue = priceSlider.value;
            const notesValue = document.getElementById('post-notes').value;
            
            if (!fromValue || !toValue || !dateValue || !timeValue) {
                alert('Please fill in all required fields (from, to, date, time).');
                return;
            }
            
            if (!fromCoords || !toCoords) {
                alert('Please select valid addresses from the suggestions.');
                return;
            }

            // Check daily ride limits for current user
            try {
                const rideValidation = await validateRidePosting(dateValue, timeValue);
                if (!rideValidation.allowed) {
                    alert(rideValidation.message);
                    return;
                }
            } catch (error) {
                console.error('Error validating ride posting:', error);
                alert('Error checking ride limits. Please try again.');
                return;
            }
            
            // Validate price constraints
            const totalPrice = parseFloat(priceValue);
            const pricePerKm = totalPrice / routeDistance;
            
            // Check if user has price constraint override
            const hasPriceOverride = await checkPriceOverride(currentUser?.id);
            
            if (!hasPriceOverride && (pricePerKm < MIN_PRICE_PER_KM || pricePerKm > MAX_PRICE_PER_KM)) {
                alert(`Invalid price! Price per seat must be between $${MIN_PRICE_PER_KM.toFixed(2)} and $${MAX_PRICE_PER_KM.toFixed(2)} per kilometer.\n\nFor this ${routeDistance.toFixed(1)} km route:\nMinimum: $${(routeDistance * MIN_PRICE_PER_KM).toFixed(2)}\nMaximum: $${(routeDistance * MAX_PRICE_PER_KM).toFixed(2)}\nCurrent: $${totalPrice.toFixed(2)} ($${pricePerKm.toFixed(2)}/km)`);
                return;
            }
            
            const serviceFee = totalPrice * 0.12;
            const basePrice = totalPrice - serviceFee;
            const driverPortion = totalPrice - serviceFee;
            
            const routeText = stops.length > 0 ? 
                `${fromValue} → ${stops.join(' → ')} → ${toValue}` : 
                `${fromValue} → ${toValue}`;
                
            // Create ride segments for dynamic seat management
            const segments = createRideSegments(fromValue, stops, toValue, fromCoords, toCoords, seatsValue);
            
            // Check if user has override status for success message (hidden from user)
            const hasOverride = await checkAdminOverride(currentUser?.id);
            const successMessage = `Ride posted successfully with ${segments.length} segment(s)!
            
Route: ${routeText}
Date & Time: ${dateValue} ${timeValue}
Available Seats: ${seatsValue} (tracked per segment)
Total Distance: ${routeDistance.toFixed(1)} km${stops.length > 0 ? ' (with ' + stops.length + ' stops)' : ''}
Price per seat: $${basePrice.toFixed(2)} ($${pricePerKm.toFixed(2)}/km)
Service Fee: $${serviceFee.toFixed(2)}
Total per seat: $${totalPrice.toFixed(2)}

📍 Segment-based seat tracking enabled:
${segments.map((seg, i) => `Segment ${i+1}: ${seg.from} → ${seg.to} (${seg.seats} seats)`).join('\n')}
            
✅ Price complies with platform limits ($${MIN_PRICE_PER_KM.toFixed(2)}-$${MAX_PRICE_PER_KM.toFixed(2)} per km)

In a real app, this would be saved to the database with segment tracking.`;

            // Save ride to database
            try {
                const { data, error } = await supabase
                    .from('rides')
                    .insert([
                        {
                            driver_id: currentUser.id,
                            departure_address: fromValue,
                            destination_address: toValue,
                            departure_latitude: fromCoords.lat,
                            departure_longitude: fromCoords.lng,
                            destination_latitude: toCoords.lat,
                            destination_longitude: toCoords.lng,
                            departure_time: new Date(`${dateValue}T${timeValue}`).toISOString(),
                            available_seats: seatsValue,
                            price_per_seat: pricePerKm,
                            service_fee_percent: 12,
                            service_fee_amount: serviceFee,
                            total_price_per_seat: totalPrice,
                            distance_km: routeDistance,
                            road_distance_km: routeDistance,
                            additional_notes: notesValue
                        }
                    ])
                    .select();
                
                if (error) {
                    console.error('Database error:', error);
                    alert('Error saving ride: ' + error.message);
                    return;
                }
                
                alert('Ride posted successfully and saved to database!');
                console.log('Ride saved:', data);
                
                // Reset form
                document.getElementById('post-from').value = '';
                document.getElementById('post-to').value = '';
            } catch (error) {
                console.error('Error saving ride:', error);
                alert('Error saving ride: ' + error.message);
            }
            
            // Clear all stops
            postStops.forEach(stop => {
                document.getElementById(`stop-group-${stop.id}`).remove();
            });
            postStops = [];
            document.getElementById('post-date').value = '';
            document.getElementById('post-time').value = '';
            document.getElementById('post-notes').value = '';
            document.getElementById('price-slider').value = '5';
            document.getElementById('price-slider').min = '0';
            document.getElementById('price-slider').max = '50';
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('price-breakdown').style.display = 'none';
            document.getElementById('price-validation-message').style.display = 'none';
            
            fromCoords = null;
            toCoords = null;
            fromCityName = '';
            toCityName = '';
            routeDistance = 0;
            
            if (postMap) {
                postMap.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        postMap.removeLayer(layer);
                    }
                });
            }
            
            await updatePriceDisplay();
        }
        
        // Initialize booking modal autocomplete
        function initializeBookingAutocomplete() {
            const bookingInputs = [
                { input: 'booking-pickup', suggestions: 'booking-pickup-suggestions' },
                { input: 'booking-dropoff', suggestions: 'booking-dropoff-suggestions' }
            ];
            
            bookingInputs.forEach(({input, suggestions}) => {
                const inputElement = document.getElementById(input);
                const suggestionsElement = document.getElementById(suggestions);
                
                if (inputElement && suggestionsElement) {
                    inputElement.addEventListener('input', (e) => {
                        clearTimeout(bookingDebounceTimer);
                        bookingDebounceTimer = setTimeout(() => {
                            searchBookingAddresses(e.target.value, suggestionsElement, input);
                        }, 300);
                    });
                    
                    inputElement.addEventListener('blur', () => {
                        setTimeout(() => {
                            suggestionsElement.style.display = 'none';
                        }, 200);
                    });
                }
            });
            
            // Initialize booking seats change handler
            const seatsSelect = document.getElementById('booking-seats');
            if (seatsSelect) {
                seatsSelect.addEventListener('change', updateBookingSummary);
            }
        }
        
        // Search addresses for booking modal
        async function searchBookingAddresses(query, suggestionsElement, inputId) {
            if (query.length < 3) {
                suggestionsElement.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=ca&q=${encodeURIComponent(query)}`
                );
                const results = await response.json();
                
                displayBookingSuggestions(results, suggestionsElement, inputId);
            } catch (error) {
                console.error('Error fetching booking addresses:', error);
            }
        }
        
        // Display booking address suggestions
        function displayBookingSuggestions(results, suggestionsElement, inputId) {
            suggestionsElement.innerHTML = '';
            
            if (results.length === 0) {
                suggestionsElement.style.display = 'none';
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                
                const main = document.createElement('div');
                main.className = 'suggestion-main';
                main.textContent = result.display_name.split(',')[0];
                
                const detail = document.createElement('div');
                detail.className = 'suggestion-detail';
                detail.textContent = result.display_name;
                
                item.appendChild(main);
                item.appendChild(detail);
                
                item.addEventListener('click', () => {
                    selectBookingAddress(result, inputId);
                    suggestionsElement.style.display = 'none';
                });
                
                suggestionsElement.appendChild(item);
            });
            
            suggestionsElement.style.display = 'block';
        }
        
        // Select booking address
        function selectBookingAddress(result, inputId) {
            const inputElement = document.getElementById(inputId);
            inputElement.value = result.display_name;
        }
        
        // Open booking modal
        function openBookingModal(rideId, driverName, rating, fromCity, toCity, date, price) {
            currentBookingData = {
                rideId,
                driverName,
                rating,
                fromCity,
                toCity,
                date,
                price: parseFloat(price)
            };
            
            // Update modal content
            document.getElementById('booking-driver-name').textContent = driverName;
            document.getElementById('booking-driver-rating').textContent = `${rating} ⭐`;
            document.getElementById('booking-route').textContent = `${fromCity} → ${toCity}`;
            document.getElementById('booking-datetime').textContent = date;
            document.getElementById('booking-price').textContent = `$${price} per seat`;
            document.getElementById('booking-summary-price').textContent = `$${price}`;
            
            // Reset form
            document.getElementById('booking-pickup').value = '';
            document.getElementById('booking-dropoff').value = '';
            document.getElementById('booking-pickup-notes').value = '';
            document.getElementById('booking-dropoff-notes').value = '';
            document.getElementById('booking-seats').value = '1';
            document.getElementById('booking-requests').value = '';
            
            // Update summary
            updateBookingSummary();
            
            // Show modal
            document.getElementById('booking-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Handle ride request (accept/decline)
        function handleRideRequest(requestId, action) {
            if (action === 'accept') {
                const confirmAccept = confirm(`✅ Accept this ride request?\n\nThis will:\n• Confirm the passenger's seat(s)\n• Process payment\n• Send confirmation to passenger\n• Update your ride capacity\n\nProceed with acceptance?`);
                
                if (confirmAccept) {
                    alert(`✅ Request Accepted!\n\nThe passenger has been notified and their payment will be processed.\nTheir contact details are now available in your ride details.\n\nNext steps:\n• Review pickup/drop-off details\n• Contact passenger if needed\n• Prepare for the trip`);
                    // Remove the request from the UI
                    document.querySelector(`[onclick*="${requestId}"]`).closest('div[style*="border-left"]').remove();
                }
            } else if (action === 'decline') {
                const reason = prompt(`❌ Decline this ride request?\n\nOptional: Provide a reason for the passenger:\n(e.g., "Route changed", "Ride is full", etc.)`);
                
                if (reason !== null) { // null means cancelled, empty string is OK
                    alert(`❌ Request Declined\n\nThe passenger has been notified${reason ? ` with reason: "${reason}"` : ''}.\n\nThey may request other rides or join the waitlist.`);
                    // Remove the request from the UI
                    document.querySelector(`[onclick*="${requestId}"]`).closest('div[style*="border-left"]').remove();
                }
            }
        }
        
        // Global variable to store all rides data
        let allRidesData = {
            offeredRides: [],
            rideRequests: [],
            myRequests: []
        };

        // Load dashboard data
        async function loadDashboardData() {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }
            
            try {
                // Load recent ride requests for driver
                const dashboardRideRequests = document.getElementById('dashboard-ride-requests');
                if (dashboardRideRequests) {
                    const { data: recentRequests, error } = await supabase
                        .from('ride_bookings')
                        .select(`
                            *,
                            rides(*),
                            users(full_name, email)
                        `)
                        .eq('rides.driver_id', currentUser.id)
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false })
                        .limit(3);
                    
                    if (error) {
                        console.error('Error loading dashboard ride requests:', error);
                        dashboardRideRequests.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No pending requests</div>';
                    } else if (recentRequests && recentRequests.length > 0) {
                        const request = recentRequests[0];
                        dashboardRideRequests.innerHTML = `
                            <div style="font-weight: 600; font-size: 0.9rem;">${request.users?.full_name || 'User'} requests ride</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${request.seats_requested} seats • ${new Date(request.created_at).toLocaleString()}</div>
                            <div style="font-size: 0.75rem; color: var(--primary-color); font-weight: 600;">Total: $${request.total_amount || '0.00'}</div>
                        `;
                    } else {
                        dashboardRideRequests.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No pending requests</div>';
                    }
                }
                
                // Load recent earnings
                const dashboardEarnings = document.getElementById('dashboard-recent-earnings');
                if (dashboardEarnings) {
                    const { data: recentBookings, error } = await supabase
                        .from('ride_bookings')
                        .select(`
                            *,
                            rides(*),
                            users(full_name)
                        `)
                        .eq('rides.driver_id', currentUser.id)
                        .eq('status', 'confirmed')
                        .order('created_at', { ascending: false })
                        .limit(3);
                    
                    if (error) {
                        console.error('Error loading dashboard earnings:', error);
                        dashboardEarnings.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No recent earnings</div>';
                    } else if (recentBookings && recentBookings.length > 0) {
                        const booking = recentBookings[0];
                        const amount = booking.total_amount || '0.00';
                        dashboardEarnings.innerHTML = `
                            <div class="earnings-item-route">${booking.rides?.departure_address?.split(',')[0] || 'Unknown'} → ${booking.rides?.destination_address?.split(',')[0] || 'Unknown'}</div>
                            <div class="earnings-item-date">${new Date(booking.created_at).toLocaleDateString()} • ${booking.users?.full_name || 'User'}</div>
                            <div class="earnings-item-amount">+$${amount}</div>
                        `;
                    } else {
                        dashboardEarnings.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No recent earnings</div>';
                    }
                }
                
                // Load recent passengers
                const dashboardPassengers = document.getElementById('dashboard-recent-passengers');
                if (dashboardPassengers) {
                    const { data: recentPassengers, error } = await supabase
                        .from('ride_bookings')
                        .select(`
                            *,
                            users(full_name, driver_rating)
                        `)
                        .eq('rides.driver_id', currentUser.id)
                        .eq('status', 'confirmed')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error('Error loading dashboard passengers:', error);
                        dashboardPassengers.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No recent passengers</div>';
                    } else if (recentPassengers && recentPassengers.length > 0) {
                        const passenger = recentPassengers[0];
                        dashboardPassengers.innerHTML = `
                            <div class="passenger-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="passenger-info">
                                <div class="passenger-name">${passenger.users?.full_name || 'User'}</div>
                                <div class="passenger-rating">${passenger.users?.driver_rating || '4.0'} ⭐</div>
                            </div>
                        `;
                    } else {
                        dashboardPassengers.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No recent passengers</div>';
                    }
                }
                
                // Load confirmed rides for passenger view
                const dashboardConfirmedRides = document.getElementById('dashboard-confirmed-rides');
                if (dashboardConfirmedRides) {
                    const { data: confirmedRides, error } = await supabase
                        .from('ride_bookings')
                        .select(`
                            *,
                            rides(*),
                            users(full_name, driver_rating)
                        `)
                        .eq('passenger_id', currentUser.id)
                        .eq('status', 'confirmed')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error('Error loading dashboard confirmed rides:', error);
                        dashboardConfirmedRides.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No confirmed rides</div>';
                    } else if (confirmedRides && confirmedRides.length > 0) {
                        const ride = confirmedRides[0];
                        dashboardConfirmedRides.innerHTML = `
                            <div style="font-weight: 600; font-size: 0.9rem;">${ride.users?.full_name || 'Driver'} - ${ride.rides?.departure_address?.split(',')[0] || 'Unknown'} → ${ride.rides?.destination_address?.split(',')[0] || 'Unknown'}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${new Date(ride.rides?.departure_time).toLocaleDateString()} • Confirmed</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">$${ride.total_amount || '0.00'}</div>
                        `;
                    } else {
                        dashboardConfirmedRides.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No confirmed rides</div>';
                    }
                }
                
                // Load my requests for passenger view
                const dashboardMyRequests = document.getElementById('dashboard-my-requests');
                if (dashboardMyRequests) {
                    const { data: myRequests, error } = await supabase
                        .from('ride_bookings')
                        .select(`
                            *,
                            rides(*),
                            users(full_name)
                        `)
                        .eq('passenger_id', currentUser.id)
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error('Error loading dashboard my requests:', error);
                        dashboardMyRequests.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No pending requests</div>';
                    } else if (myRequests && myRequests.length > 0) {
                        const request = myRequests[0];
                        dashboardMyRequests.innerHTML = `
                            <div style="font-weight: 600; font-size: 0.9rem;">Request to ${request.users?.full_name || 'Driver'} - ${request.rides?.departure_address?.split(',')[0] || 'Unknown'} → ${request.rides?.destination_address?.split(',')[0] || 'Unknown'}</div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">${new Date(request.rides?.departure_time).toLocaleDateString()} • ${request.seats_requested} seats • $${request.total_amount || '0.00'}</div>
                            <div style="font-size: 0.75rem; color: var(--warning-color); font-weight: 600;">
                                <i class="fas fa-hourglass-half"></i> Pending Approval
                            </div>
                        `;
                    } else {
                        dashboardMyRequests.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">No pending requests</div>';
                    }
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // This is a reference to the main loadMyRidesFromDatabase implementation at line ~5172
        // Do not remove this comment - it helps maintain code clarity
        
        // Update ride count badges
        function updateRideCounters(data) {
            // Driver ride requests counter - show both pending and confirmed
            const pendingRequestsCount = data.rideRequests.filter(req => req.status === 'pending').length;
            const confirmedRequestsCount = data.rideRequests.filter(req => req.status === 'confirmed').length;
            const pendingCountEl = document.getElementById('pending-request-count');
            if (pendingCountEl) {
                if (pendingRequestsCount > 0 && confirmedRequestsCount > 0) {
                    pendingCountEl.textContent = `${pendingRequestsCount} pending, ${confirmedRequestsCount} confirmed`;
                } else if (pendingRequestsCount > 0) {
                    pendingCountEl.textContent = `${pendingRequestsCount} pending`;
                } else if (confirmedRequestsCount > 0) {
                    pendingCountEl.textContent = `${confirmedRequestsCount} confirmed`;
                } else {
                    pendingCountEl.textContent = '0 requests';
                }
                pendingCountEl.style.display = (pendingRequestsCount > 0 || confirmedRequestsCount > 0) ? 'inline-flex' : 'none';
            }
            
            // Passenger ride requests counter
            const myPendingRequestsCount = data.myRequests.filter(req => req.status === 'pending').length;
            const myRequestCountEl = document.getElementById('my-request-count');
            if (myRequestCountEl) {
                myRequestCountEl.textContent = myPendingRequestsCount + ' pending';
                myRequestCountEl.style.display = myPendingRequestsCount > 0 ? 'inline-flex' : 'none';
            }
            
            // Offered rides counter
            const activeOfferedRidesCount = data.offeredRides.filter(ride => 
                new Date(ride.departure_time) > new Date() && !ride.is_cancelled
            ).length;
            const offeredRidesCountEl = document.getElementById('offered-rides-count');
            if (offeredRidesCountEl) {
                offeredRidesCountEl.textContent = activeOfferedRidesCount + ' active';
                offeredRidesCountEl.style.display = activeOfferedRidesCount > 0 ? 'inline-flex' : 'none';
            }
            
            // Booked rides counter - show both confirmed and pending
            const confirmedBookingsCount = data.myRequests.filter(req => req.status === 'confirmed').length;
            const pendingBookingsCount = data.myRequests.filter(req => req.status === 'pending').length;
            const bookedRidesCountEl = document.getElementById('booked-rides-count');
            if (bookedRidesCountEl) {
                if (confirmedBookingsCount > 0 && pendingBookingsCount > 0) {
                    bookedRidesCountEl.textContent = `${confirmedBookingsCount} confirmed, ${pendingBookingsCount} pending`;
                } else if (confirmedBookingsCount > 0) {
                    bookedRidesCountEl.textContent = `${confirmedBookingsCount} confirmed`;
                } else if (pendingBookingsCount > 0) {
                    bookedRidesCountEl.textContent = `${pendingBookingsCount} pending`;
                } else {
                    bookedRidesCountEl.textContent = '0 rides';
                }
                bookedRidesCountEl.style.display = (confirmedBookingsCount > 0 || pendingBookingsCount > 0) ? 'inline-flex' : 'none';
            }
        }
        
        // Show/hide appropriate sections based on data
        function toggleRideSections(data) {
            // Toggle driver requests section
            const hasDriverRequests = data.rideRequests.length > 0;
            const driverRequestsContainer = document.getElementById('driver-requests-container');
            const noDriverRequests = document.getElementById('no-driver-requests');
            
            if (driverRequestsContainer) {
                driverRequestsContainer.style.display = hasDriverRequests ? 'block' : 'none';
            }
            if (noDriverRequests) {
                noDriverRequests.style.display = hasDriverRequests ? 'none' : 'block';
            }
            
            // Toggle passenger requests section
            const hasPassengerRequests = data.myRequests.filter(req => req.status === 'pending').length > 0;
            const passengerRequestsContainer = document.getElementById('passenger-requests-container');
            const noPassengerRequests = document.getElementById('no-passenger-requests');
            
            if (passengerRequestsContainer) {
                passengerRequestsContainer.style.display = hasPassengerRequests ? 'block' : 'none';
            }
            if (noPassengerRequests) {
                noPassengerRequests.style.display = hasPassengerRequests ? 'none' : 'block';
            }
            
            // Toggle offered rides section
            const hasOfferedRides = data.offeredRides.length > 0;
            const driverRidesContainer = document.getElementById('driver-rides-container');
            const noOfferedRides = document.getElementById('no-offered-rides');
            
            if (driverRidesContainer) {
                driverRidesContainer.style.display = hasOfferedRides ? 'block' : 'none';
            }
            if (noOfferedRides) {
                noOfferedRides.style.display = hasOfferedRides ? 'none' : 'block';
            }
            
            // Toggle booked rides section - show both confirmed and pending rides
            const hasBookedRides = data.myRequests.length > 0;
            const passengerRidesContainer = document.getElementById('passenger-rides-container');
            const noBookedRides = document.getElementById('no-booked-rides');
            
            if (passengerRidesContainer) {
                passengerRidesContainer.style.display = hasBookedRides ? 'block' : 'none';
            }
            if (noBookedRides) {
                noBookedRides.style.display = hasBookedRides ? 'none' : 'block';
            }
        }
        
        // Display offered rides
        function displayOfferedRides(rides) {
            const offeredRidesSection = document.getElementById('offered-rides-section');
            if (!offeredRidesSection) return;
            
            if (rides.length === 0) {
                offeredRidesSection.innerHTML = `
                    <h3 style="margin-bottom: 1rem;">Offered Rides</h3>
                    <div style="background: rgba(240, 240, 245, 0.5); padding: 2rem; border-radius: 8px; text-align: center; color: #666;">
                        <i class="fas fa-car" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No offered rides</p>
                        <button onclick="switchTab('post-ride')" style="background: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">
                            <i class="fas fa-plus"></i> Post a Ride
                        </button>
                    </div>
                `;
                return;
            }
            
            let ridesHtml = '<h3 style="margin-bottom: 1rem;">Offered Rides</h3>';
            
            rides.forEach(ride => {
                const departureTime = new Date(ride.departure_time);
                const date = departureTime.toLocaleDateString();
                const time = departureTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Get departure and destination addresses, handle undefined values
                const from = (ride.departure_address && ride.departure_address !== 'undefined') 
                    ? ride.departure_address 
                    : 'Unknown Location';
                    
                const to = (ride.destination_address && ride.destination_address !== 'undefined') 
                    ? ride.destination_address 
                    : 'Unknown Destination';
                
                // Extract city from address with proper null checks
                const fromCity = from && from.includes(',') ? from.split(',')[0].trim() : from;
                const toCity = to && to.includes(',') ? to.split(',')[0].trim() : to;
                
                // Calculate total price if not available (for legacy rides)
                let price = ride.total_price_per_seat;
                if (!price || price === 0 || price === '0' || price === 'undefined') {
                    // Get base price, default to 0 if not available
                    const basePrice = parseFloat(ride.price_per_seat) || 0;
                    // Calculate total price with 12% service fee
                    price = basePrice * 1.12;
                }
                
                // Ensure price is a valid number
                if (!price || isNaN(price) || price === 'undefined') {
                    price = 0;
                }
                
                // Format price to 2 decimal places
                const formattedPrice = typeof price === 'number' ? price.toFixed(2) : parseFloat(price).toFixed(2);
                
                // Calculate booked and available seats
                const bookedSeats = ride.booked_seats || 0;
                const totalSeats = ride.available_seats || 3; // Default to 3 if not specified
                const seatsBooked = `${bookedSeats}/${totalSeats} seats booked`;
                
                ridesHtml += `
                    <div style="background: #f8f9ff; padding: 1rem; border-radius: 16px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem;">
                                    ${fromCity} → ${toCity}
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    ${date}, ${time} • ${seatsBooked}
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="openChat('${ride.id}')" style="background: var(--primary-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-comments"></i>
                                </button>
                                <button onclick="cancelRide('${ride.id}')" style="background: var(--error-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                            <div style="background-color: var(--warning-color); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center;">
                                <i class="far fa-clock" style="margin-right: 0.25rem;"></i> 3 on waitlist
                            </div>
                            <div style="color: var(--text-color); font-weight: 600; font-size: 1rem;">
                                $${formattedPrice} per seat
                            </div>
                        </div>
                        <div style="margin-top: 0.75rem; border-top: 1px solid #e5e7f2; padding-top: 0.75rem;">
                            <button onclick="viewRideDetails('${ride.id}')" style="background: none; border: none; color: var(--primary-color); font-weight: 600; display: flex; align-items: center; width: 100%; justify-content: center; cursor: pointer;">
                                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i> Ride Details & Route
                            </button>
                        </div>
                    </div>
                `;
            });
            
            offeredRidesSection.innerHTML = ridesHtml;
        }
        
        // Display ride requests
        function displayRideRequests(requests) {
            const rideRequestsSection = document.getElementById('ride-requests-section');
            if (!rideRequestsSection) return;
            
            if (requests.length === 0) {
                rideRequestsSection.innerHTML = `
                    <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-inbox"></i> Ride Requests 
                        <span style="background: var(--primary-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">0 pending</span>
                    </h3>
                    <div style="background: rgba(240, 240, 245, 0.5); padding: 2rem; border-radius: 8px; text-align: center; color: #666;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No pending ride requests</p>
                    </div>
                `;
                return;
            }
            
            let requestsHtml = `
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-inbox"></i> Ride Requests 
                    <span style="background: var(--primary-color); color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">${requests.length} pending</span>
                </h3>
            `;
            
            requests.forEach(request => {
                // Calculate price with proper error handling
                let price = request.rides.total_price_per_seat;
                if (!price || price === 0 || price === '0' || price === 'undefined') {
                    const basePrice = parseFloat(request.rides.price_per_seat) || 0;
                    price = basePrice * 1.12;
                }
                
                if (!price || isNaN(price) || price === 'undefined') {
                    price = 0;
                }
                
                const totalPrice = (request.seats_requested * price).toFixed(2);
                const timeSince = new Date(Date.now() - new Date(request.created_at).getTime()).getMinutes();
                
                // Get departure and destination addresses, handle undefined values
                const from = (request.rides.departure_address && request.rides.departure_address !== 'undefined') 
                    ? request.rides.departure_address 
                    : 'Unknown Location';
                    
                const to = (request.rides.destination_address && request.rides.destination_address !== 'undefined') 
                    ? request.rides.destination_address 
                    : 'Unknown Destination';
                
                // Extract city from address with proper null checks
                const fromCity = from && from.includes(',') ? from.split(',')[0].trim() : from;
                const toCity = to && to.includes(',') ? to.split(',')[0].trim() : to;
                
                // Get pickup and dropoff locations from the request
                const pickupLocation = request.pickup_location || 'Main pickup';
                const dropoffLocation = request.dropoff_location || 'Main destination';
                
                requestsHtml += `
                    <div style="background: #f8f9ff; padding: 1rem; border-radius: 16px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="background: var(--primary-color); color: white; width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 1rem;">${request.users.full_name || 'Anonymous'}</div>
                                    <div style="font-size: 0.8rem; color: #666;">Requested ${timeSince} min ago</div>
                                </div>
                            </div>
                            <div>
                                <button onclick="openChat('${request.ride_id}')" style="background: var(--primary-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-comments"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div style="background: rgba(240, 240, 245, 0.3); padding: 0.75rem; border-radius: 12px; margin-bottom: 0.75rem;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem; font-size: 0.9rem;">${fromCity} → ${toCity}</div>
                            <div style="font-size: 0.85rem; display: flex; justify-content: space-between;">
                                <span>${new Date(request.rides.departure_time).toLocaleDateString()}, ${new Date(request.rides.departure_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                <span><i class="fas fa-chair"></i> ${request.seats_requested || 1} seat(s)</span>
                            </div>
                            <div style="font-size: 0.85rem; margin-top: 0.25rem; color: var(--primary-color); font-weight: 600; text-align: right;">
                                Total: $${totalPrice}
                            </div>
                        </div>
                        
                        <!-- Detailed Request Information -->
                        <div style="background: rgba(240, 240, 245, 0.15); padding: 0.75rem; border-radius: 12px; margin-bottom: 0.75rem; border: 1px dashed var(--border-color);">
                            <h4 style="margin: 0 0 0.5rem 0; color: var(--text-color); font-size: 0.85rem;"><i class="fas fa-info-circle"></i> Request Details:</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.8rem;">
                                <div>
                                    <p style="margin: 0; font-weight: 600;">Pickup Location:</p>
                                    <p style="margin: 0; color: #666;">${pickupLocation}</p>
                                </div>
                                <div>
                                    <p style="margin: 0; font-weight: 600;">Drop-off Location:</p>
                                    <p style="margin: 0; color: #666;">${dropoffLocation}</p>
                                </div>
                            </div>
                            ${request.special_instructions ? `
                                <div style="margin-top: 0.5rem;">
                                    <p style="margin: 0; font-weight: 600;">Special Instructions:</p>
                                    <p style="margin: 0; color: #666;">${request.special_instructions}</p>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Show booking status for driver reference -->
                        <div style="background: rgba(var(--success-color-rgb), 0.1); padding: 0.5rem; border-radius: 8px; margin-bottom: 0.75rem; border-left: 4px solid var(--success-color);">
                            <div style="font-size: 0.8rem; font-weight: 600; color: var(--success-color);">
                                <i class="fas fa-check-circle"></i> Status: ${request.status === 'confirmed' ? 'CONFIRMED RIDE' : 'PENDING APPROVAL'}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; gap: 0.5rem;">
                            <button onclick="handleRideRequestFromDB('${request.id}', 'decline')" style="flex: 1; background: var(--error-color); color: white; border: none; border-radius: 12px; padding: 0.75rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-times"></i> Decline
                            </button>
                            <button onclick="handleRideRequestFromDB('${request.id}', 'accept')" style="flex: 1; background: var(--success-color); color: white; border: none; border-radius: 12px; padding: 0.75rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-check"></i> Accept
                            </button>
                        </div>
                    </div>
                `;
            });
            
            rideRequestsSection.innerHTML = requestsHtml;
        }
        
        // Display user's ride requests
        function displayMyRideRequests(requests) {
            const rideRequestsReceivedSection = document.getElementById('ride-requests-received-section');
            if (!rideRequestsReceivedSection) return;
            
            if (requests.length === 0) {
                rideRequestsReceivedSection.innerHTML = `
                    <h3 style="margin-bottom: 1rem;">My Ride Requests</h3>
                    <div style="background: rgba(240, 240, 245, 0.5); padding: 2rem; border-radius: 8px; text-align: center; color: #666;">
                        <i class="fas fa-ticket-alt" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No requested rides</p>
                        <button onclick="switchTab('find-rides')" style="background: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; margin-top: 1rem;">
                            <i class="fas fa-search"></i> Find Rides
                        </button>
                    </div>
                `;
                return;
            }
            
            let requestsHtml = '<h3 style="margin-bottom: 1rem;">My Ride Requests</h3>';
            
            requests.forEach(request => {
                // Calculate price with proper error handling
                let price = request.rides.total_price_per_seat;
                if (!price || price === 0 || price === '0' || price === 'undefined') {
                    const basePrice = parseFloat(request.rides.price_per_seat) || 0;
                    price = basePrice * 1.12;
                }
                
                if (!price || isNaN(price) || price === 'undefined') {
                    price = 0;
                }
                
                const totalPrice = (request.seats_requested * price).toFixed(2);
                
                // Get departure and destination addresses, handle undefined values
                const from = (request.rides.departure_address && request.rides.departure_address !== 'undefined') 
                    ? request.rides.departure_address 
                    : 'Unknown Location';
                    
                const to = (request.rides.destination_address && request.rides.destination_address !== 'undefined') 
                    ? request.rides.destination_address 
                    : 'Unknown Destination';
                
                // Extract city from address with proper null checks
                const fromCity = from && from.includes(',') ? from.split(',')[0].trim() : from;
                const toCity = to && to.includes(',') ? to.split(',')[0].trim() : to;
                
                // Status info
                const statusColor = request.status === 'pending' ? 'var(--warning-color)' : 
                                  request.status === 'confirmed' ? 'var(--success-color)' : 'var(--error-color)';
                const statusIcon = request.status === 'pending' ? 'fas fa-clock' : 
                                 request.status === 'confirmed' ? 'fas fa-check' : 'fas fa-times';
                const statusText = request.status === 'pending' ? 'Pending Approval' : 
                                 request.status === 'confirmed' ? 'Confirmed' : 'Declined';
                
                // Get driver info if available
                const driverName = request.rides.driver_name || 'Driver';
                const driverRating = request.rides.driver_rating || '4.5';
                
                // Vehicle info if available  
                const vehicleInfo = request.rides.vehicle_info || 'Vehicle info not available';
                                 
                requestsHtml += `
                    <div style="background: #f8f9ff; padding: 1rem; border-radius: 16px; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 1.1rem;">
                                    ${fromCity} → ${toCity}
                                </div>
                                <div style="font-size: 0.9rem; color: #666;">
                                    ${new Date(request.rides.departure_time).toLocaleDateString()}, ${new Date(request.rides.departure_time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} • ${request.seats_requested || 1} seat(s)
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${request.status === 'confirmed' ? `
                                    <button onclick="openChat('${request.ride_id}')" style="background: var(--primary-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-comments"></i>
                                    </button>
                                    <button onclick="trackRide('${request.ride_id}')" style="background: var(--warning-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-map-marked-alt"></i>
                                    </button>
                                ` : ''}
                                ${request.status === 'pending' ? `
                                    <button onclick="cancelRideRequestFromDB('${request.id}')" style="background: var(--error-color); color: white; border: none; border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; display: flex; align-items: center; justify-content: space-between;">
                            <div style="background-color: ${statusColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center;">
                                <i class="${statusIcon}" style="margin-right: 0.25rem;"></i> ${statusText}
                            </div>
                            <div style="color: var(--text-color); font-weight: 600; font-size: 1rem;">
                                $${totalPrice} total
                            </div>
                        </div>
                        
                        ${request.status === 'confirmed' ? `
                            <!-- Driver and Vehicle Info (shown only for confirmed rides) -->
                            <div style="margin-top: 0.75rem; background: rgba(240, 240, 245, 0.3); padding: 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                    <div><i class="fas fa-user" style="color: var(--primary-color);"></i> Driver: ${driverName}</div>
                                    <div>⭐ ${driverRating}</div>
                                </div>
                                <div><i class="fas fa-car" style="color: var(--primary-color);"></i> ${vehicleInfo}</div>
                            </div>
                        ` : ''}
                        
                        <!-- Pickup and Dropoff Details -->
                        <div style="margin-top: 0.75rem; background: rgba(240, 240, 245, 0.15); padding: 0.75rem; border-radius: 12px; font-size: 0.85rem; border: 1px dashed var(--border-color);">
                            <div><i class="fas fa-map-marker-alt" style="color: var(--primary-color);"></i> <strong>Pickup:</strong> ${request.pickup_location || 'Main pickup point'}</div>
                            <div><i class="fas fa-map-marker-alt" style="color: var(--error-color);"></i> <strong>Drop-off:</strong> ${request.dropoff_location || 'Main destination'}</div>
                        </div>
                        
                        <div style="margin-top: 0.75rem; border-top: 1px solid #e5e7f2; padding-top: 0.75rem;">
                            <button onclick="viewRideDetails('${request.ride_id}')" style="background: none; border: none; color: var(--primary-color); font-weight: 600; display: flex; align-items: center; width: 100%; justify-content: center; cursor: pointer;">
                                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i> Ride Details & Route
                            </button>
                        </div>
                    </div>
                `;
            });
            
            rideRequestsReceivedSection.innerHTML = requestsHtml;
        }
        
        // Handle ride request response (from database)
        async function handleRideRequestFromDB(requestId, action) {
            try {
                let reason = null;
                if (action === 'decline') {
                    reason = prompt('Optional: Provide a reason for declining (or leave empty):');
                    if (reason === null) return; // User cancelled
                }
                
                const newStatus = action === 'accept' ? 'confirmed' : 'declined';
                
                const { error } = await supabase
                    .from('ride_bookings')
                    .update({ 
                        status: newStatus,
                        decline_reason: action === 'decline' ? reason : null
                    })
                    .eq('id', requestId);
                
                if (error) {
                    console.error('Error updating ride request:', error);
                    alert('Error updating ride request. Please try again.');
                    return;
                }
                
                // Show success message
                const message = action === 'accept' ? 
                    '✅ Request Accepted!\n\nThe passenger has been notified and can now see your contact details.' :
                    `❌ Request Declined\n\nThe passenger has been notified${reason ? ` with reason: "${reason}"` : ''}.`;
                
                alert(message);
                
                // Reload the My Rides data
                loadMyRidesFromDatabase();
                
            } catch (error) {
                console.error('Error handling ride request:', error);
                alert('Error processing request. Please try again.');
            }
        }
        
        // Cancel ride request (from database)
        async function cancelRideRequestFromDB(requestId) {
            if (!confirm('Are you sure you want to cancel this ride request?')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('ride_bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', requestId);
                
                if (error) {
                    console.error('Error cancelling ride request:', error);
                    alert('Error cancelling request. Please try again.');
                    return;
                }
                
                alert('✅ Ride request cancelled successfully.');
                loadMyRidesFromDatabase();
                
            } catch (error) {
                console.error('Error cancelling ride request:', error);
                alert('Error cancelling request. Please try again.');
            }
        }
        
        // Cancel offered ride (from database)
        async function cancelRide(rideId) {
            if (!confirm('Are you sure you want to cancel this ride? All passengers will be notified.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('rides')
                    .update({ status: 'cancelled' })
                    .eq('id', rideId);
                
                if (error) {
                    console.error('Error cancelling ride:', error);
                    alert('Error cancelling ride. Please try again.');
                    return;
                }
                
                alert('✅ Ride cancelled successfully. All passengers have been notified.');
                loadMyRidesFromDatabase();
                
            } catch (error) {
                console.error('Error cancelling ride:', error);
                alert('Error cancelling ride. Please try again.');
            }
        }
        
        // Removed clearDemoRides function - now using real-time database only

        // Filter functions
        function clearAllFilters() {
            document.getElementById('filter-user-type').value = 'all';
            document.getElementById('filter-status').value = 'all';
            document.getElementById('filter-date-range').value = 'all';
            applyFilters();
        }

        function applyFilters() {
            const userTypeFilter = document.getElementById('filter-user-type').value;
            const statusFilter = document.getElementById('filter-status').value;
            const dateRangeFilter = document.getElementById('filter-date-range').value;
            
            // Combine all rides into a single array with type identification
            let allRides = [];
            
            // Add offered rides (user as driver)
            allRidesData.offeredRides.forEach(ride => {
                allRides.push({
                    ...ride,
                    userType: 'driver',
                    rideType: 'offered',
                    bookingStatus: null,
                    isMainRide: true
                });
            });
            
            // Add ride requests received by user (user as driver, others as passengers)
            allRidesData.rideRequests.forEach(request => {
                allRides.push({
                    ...request.rides,
                    userType: 'driver',
                    rideType: 'request-received',
                    bookingStatus: request.status,
                    bookingId: request.id,
                    passengerName: request.users?.full_name,
                    passengerEmail: request.users?.email,
                    requestedSeats: request.seats_requested,
                    isMainRide: false
                });
            });
            
            // Add user's own requests (user as passenger)
            allRidesData.myRequests.forEach(request => {
                allRides.push({
                    ...request.rides,
                    userType: 'passenger',
                    rideType: 'my-request',
                    bookingStatus: request.status,
                    bookingId: request.id,
                    driverName: request.users?.full_name,
                    requestedSeats: request.seats_requested,
                    isMainRide: false
                });
            });
            
            // Apply filters
            let filteredRides = allRides.filter(ride => {
                // User type filter
                if (userTypeFilter !== 'all' && ride.userType !== userTypeFilter) {
                    return false;
                }
                
                // Status filter
                if (statusFilter !== 'all') {
                    const rideDate = new Date(ride.departure_time);
                    const now = new Date();
                    
                    switch (statusFilter) {
                        case 'upcoming':
                            if (rideDate <= now || (ride.bookingStatus && ride.bookingStatus === 'cancelled')) {
                                return false;
                            }
                            break;
                        case 'completed':
                            if (rideDate > now) {
                                return false;
                            }
                            break;
                        case 'cancelled':
                            if (!ride.bookingStatus || ride.bookingStatus !== 'cancelled') {
                                return false;
                            }
                            break;
                        case 'pending':
                            if (!ride.bookingStatus || ride.bookingStatus !== 'pending') {
                                return false;
                            }
                            break;
                        case 'confirmed':
                            if (!ride.bookingStatus || ride.bookingStatus !== 'confirmed') {
                                return false;
                            }
                            break;
                    }
                }
                
                // Date range filter
                if (dateRangeFilter !== 'all') {
                    const rideDate = new Date(ride.departure_time);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    switch (dateRangeFilter) {
                        case 'today':
                            if (rideDate.toDateString() !== today.toDateString()) {
                                return false;
                            }
                            break;
                        case 'week':
                            if (rideDate < weekStart || rideDate >= new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000)) {
                                return false;
                            }
                            break;
                        case 'month':
                            if (rideDate < monthStart || rideDate >= new Date(now.getFullYear(), now.getMonth() + 1, 1)) {
                                return false;
                            }
                            break;
                        case 'past':
                            if (rideDate >= now) {
                                return false;
                            }
                            break;
                        case 'future':
                            if (rideDate < now) {
                                return false;
                            }
                            break;
                    }
                }
                
                return true;
            });
            
            // Sort rides by departure time
            filteredRides.sort((a, b) => new Date(b.departure_time) - new Date(a.departure_time));
            
            // Display filtered rides
            displayFilteredRides(filteredRides);
            
            // Update active filters display
            updateActiveFiltersDisplay();
        }

        function displayFilteredRides(rides) {
            const container = document.getElementById('all-rides-container');
            if (!container) return;
            
            if (rides.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(240, 240, 245, 0.5); padding: 2rem; border-radius: 8px; text-align: center; color: #666;">
                        <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>No rides found matching your filters</p>
                        <button onclick="clearAllFilters()" style="background: var(--primary-color); color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem;">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '';
            let currentSection = '';
            
            rides.forEach(ride => {
                // Group by user type and ride type
                let sectionTitle = '';
                if (ride.userType === 'driver') {
                    if (ride.rideType === 'offered') {
                        sectionTitle = 'My Offered Rides';
                    } else {
                        sectionTitle = 'Ride Requests Received';
                    }
                } else {
                    sectionTitle = 'My Ride Requests';
                }
                
                if (currentSection !== sectionTitle) {
                    if (currentSection !== '') {
                        html += '</div>';
                    }
                    html += `
                        <div style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem;">
                                <i class="fas ${ride.userType === 'driver' ? (ride.rideType === 'offered' ? 'fa-car' : 'fa-user-friends') : 'fa-hand-paper'}"></i> 
                                ${sectionTitle}
                            </h3>
                    `;
                    currentSection = sectionTitle;
                }
                
                html += generateRideCard(ride);
            });
            
            if (currentSection !== '') {
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function generateRideCard(ride) {
            const departureDate = new Date(ride.departure_time);
            const isUpcoming = departureDate > new Date();
            const formattedDate = departureDate.toLocaleDateString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const formattedTime = departureDate.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Generate driver/passenger info with profile photo
            let profileInfo = '';
            let driverName = '';
            let profilePhoto = '';
            
            if (ride.userType === 'passenger' && ride.driverName) {
                driverName = ride.driverName;
                profilePhoto = `https://ui-avatars.com/api/?name=${encodeURIComponent(driverName)}&background=6c63ff&color=ffffff&size=40&rounded=true`;
            } else if (ride.userType === 'driver' && ride.rideType === 'request-received' && ride.passengerName) {
                driverName = ride.passengerName;
                profilePhoto = `https://ui-avatars.com/api/?name=${encodeURIComponent(driverName)}&background=6c63ff&color=ffffff&size=40&rounded=true`;
            } else {
                driverName = currentUser?.full_name || 'Driver';
                profilePhoto = `https://ui-avatars.com/api/?name=${encodeURIComponent(driverName)}&background=6c63ff&color=ffffff&size=40&rounded=true`;
            }
            
            // Status badge
            let statusBadge = '';
            if (ride.bookingStatus) {
                const statusColors = {
                    'pending': '#ff9800',
                    'confirmed': '#4caf50',
                    'cancelled': '#f44336'
                };
                const statusColor = statusColors[ride.bookingStatus] || '#666';
                statusBadge = `
                    <span style="background: ${statusColor}; color: white; padding: 0.2rem 0.5rem; border-radius: 8px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase;">
                        ${ride.bookingStatus}
                    </span>
                `;
            }
            
            // Car info based on reference image style
            let carInfo = ride.vehicle_details || 'Vehicle details not provided';
            let carIcons = '';
            
            // Add car feature icons (manual transmission, AC, etc.)
            carIcons = `
                <span style="background: #f0f0f0; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.6rem; margin-right: 0.3rem;">M</span>
                <i class="fas fa-snowflake" style="color: #2196F3; font-size: 0.8rem; margin-right: 0.3rem;"></i>
                <span style="color: #666; font-size: 0.7rem;">+2 more</span>
            `;
            
            return `
                <div style="background: white; border-radius: 16px; padding: 0; margin-bottom: 1rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; overflow: hidden;">
                    <!-- Header with time and seats -->
                    <div style="padding: 1rem 1.25rem 0.75rem 1.25rem;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-size: 1.1rem; font-weight: 600; color: #1a1a1a; margin-bottom: 0.25rem;">
                                    ${isUpcoming ? 'Tomorrow' : formattedDate} at ${formattedTime}
                                </div>
                                ${statusBadge}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.2rem;">
                                    ${ride.available_seats || ride.requestedSeats || 3} seats left
                                </div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #2196F3;">
                                    $${ride.total_price || ride.price}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Route with clean design -->
                        <div style="margin-bottom: 0.75rem;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <div style="width: 4px; height: 12px; background: #2196F3; border-radius: 2px; margin-right: 0.75rem;"></div>
                                <div>
                                    <div style="font-weight: 600; color: #1a1a1a; font-size: 1rem;">
                                        ${ride.origin_address?.split(',')[0] || ride.origin_address}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #666;">
                                        ${ride.origin_address?.includes(',') ? ride.origin_address.split(',').slice(1).join(',').trim() : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <div style="width: 4px; height: 12px; background: #666; border-radius: 2px; margin-right: 0.75rem;"></div>
                                <div>
                                    <div style="font-weight: 600; color: #1a1a1a; font-size: 1rem;">
                                        ${ride.destination_address?.split(',')[0] || ride.destination_address}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #666;">
                                        ${ride.destination_address?.includes(',') ? ride.destination_address.split(',').slice(1).join(',').trim() : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Car info -->
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <span style="font-size: 0.9rem; color: #666; font-weight: 500;">${carInfo}</span>
                            ${carIcons}
                        </div>
                    </div>
                    
                    <!-- Driver info section -->
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1.25rem; background: #fafafa; border-top: 1px solid #f0f0f0;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <img src="${profilePhoto}" 
                                 style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0;" 
                                 alt="${driverName}">
                            <div>
                                <div style="font-weight: 600; color: #1a1a1a; font-size: 0.95rem;">
                                    ${driverName}
                                </div>
                                ${ride.userType === 'driver' && ride.rideType === 'request-received' ? `
                                    <div style="font-size: 0.8rem; color: #666;">Requested ${ride.requestedSeats} seat(s)</div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Verification badge -->
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            ${ride.userType === 'passenger' || (ride.userType === 'driver' && ride.rideType !== 'offered') ? `
                                <div style="background: #2196F3; color: white; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem; display: flex; align-items: center; gap: 0.2rem;">
                                    <i class="fas fa-shield-alt"></i>
                                    <span style="font-size: 0.7rem;">1 driven</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Action buttons (only show for pending requests) -->
                    ${(ride.userType === 'driver' && ride.rideType === 'request-received' && ride.bookingStatus === 'pending') || 
                      (ride.userType === 'passenger' && ride.bookingStatus === 'pending') || 
                      (ride.userType === 'driver' && ride.rideType === 'offered' && isUpcoming) ? `
                        <div style="padding: 0.75rem 1.25rem; border-top: 1px solid #f0f0f0; background: white;">
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                ${ride.userType === 'driver' && ride.rideType === 'offered' && isUpcoming ? `
                                    <button onclick="cancelRide('${ride.id}')" style="background: #f44336; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                        Cancel Ride
                                    </button>
                                ` : ''}
                                
                                ${ride.userType === 'passenger' && ride.bookingStatus === 'pending' ? `
                                    <button onclick="cancelRideRequest('${ride.bookingId}')" style="background: #f44336; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                        Cancel Request
                                    </button>
                                ` : ''}
                                
                                ${ride.userType === 'driver' && ride.rideType === 'request-received' && ride.bookingStatus === 'pending' ? `
                                    <button onclick="approveRequest('${ride.bookingId}')" style="background: #4caf50; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                        Approve
                                    </button>
                                    <button onclick="rejectRequest('${ride.bookingId}')" style="background: #f44336; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                        Reject
                                    </button>
                                ` : ''}
                                
                                <button onclick="openChatModal('${ride.id}')" style="background: #2196F3; color: white; border: none; padding: 0.6rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 500;">
                                    Message
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('active-filters');
            if (!activeFiltersContainer) return;
            
            const userType = document.getElementById('filter-user-type').value;
            const status = document.getElementById('filter-status').value;
            const dateRange = document.getElementById('filter-date-range').value;
            
            let activeFilters = [];
            
            if (userType !== 'all') {
                activeFilters.push({
                    label: `Type: ${userType === 'driver' ? 'As Driver' : 'As Passenger'}`,
                    value: userType,
                    filter: 'user-type'
                });
            }
            
            if (status !== 'all') {
                activeFilters.push({
                    label: `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}`,
                    value: status,
                    filter: 'status'
                });
            }
            
            if (dateRange !== 'all') {
                const dateLabels = {
                    'today': 'Today',
                    'week': 'This Week',
                    'month': 'This Month',
                    'past': 'Past Rides',
                    'future': 'Future Rides'
                };
                activeFilters.push({
                    label: `Date: ${dateLabels[dateRange]}`,
                    value: dateRange,
                    filter: 'date-range'
                });
            }
            
            if (activeFilters.length === 0) {
                activeFiltersContainer.innerHTML = '';
                return;
            }
            
            let html = '<div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Active Filters:</div>';
            
            activeFilters.forEach(filter => {
                html += `
                    <span style="background: var(--primary-color); color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.25rem;">
                        ${filter.label}
                        <button onclick="clearSingleFilter('${filter.filter}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; margin: 0; font-size: 0.7rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `;
            });
            
            activeFiltersContainer.innerHTML = html;
        }

        function clearSingleFilter(filterType) {
            switch (filterType) {
                case 'user-type':
                    document.getElementById('filter-user-type').value = 'all';
                    break;
                case 'status':
                    document.getElementById('filter-status').value = 'all';
                    break;
                case 'date-range':
                    document.getElementById('filter-date-range').value = 'all';
                    break;
            }
            applyFilters();
        }

        // Additional ride management functions for the filtered view
        async function approveRequest(bookingId) {
            if (!confirm('Approve this ride request?')) return;
            
            try {
                const { error } = await supabase
                    .from('ride_bookings')
                    .update({ status: 'confirmed' })
                    .eq('id', bookingId);
                
                if (error) {
                    console.error('Error approving request:', error);
                    alert('Error approving request. Please try again.');
                } else {
                    alert('✅ Request approved successfully!');
                    loadMyRidesFromDatabase();
                }
            } catch (error) {
                console.error('Error approving request:', error);
                alert('Error approving request. Please try again.');
            }
        }

        async function rejectRequest(bookingId) {
            if (!confirm('Reject this ride request?')) return;
            
            try {
                const { error } = await supabase
                    .from('ride_bookings')
                    .update({ status: 'cancelled' })
                    .eq('id', bookingId);
                
                if (error) {
                    console.error('Error rejecting request:', error);
                    alert('Error rejecting request. Please try again.');
                } else {
                    alert('❌ Request rejected.');
                    loadMyRidesFromDatabase();
                }
            } catch (error) {
                console.error('Error rejecting request:', error);
                alert('Error rejecting request. Please try again.');
            }
        }
        
        // Cancel ride request (passenger side)
        function cancelRideRequest(requestId) {
            const confirmCancel = confirm(`🕒 Cancel this ride request?\n\nThis will:\n• Remove your request from the driver's queue\n• Free up the requested seats for others\n• You can submit a new request anytime\n\nCancel the request?`);
            
            if (confirmCancel) {
                // In a real implementation, we would call the API to cancel the request
                try {
                    // Remove the cancelled request from UI
                    const requestElement = document.querySelector(`[onclick*="${requestId}"]`).closest('div[style*="border-left"]');
                    
                    // Add a fade-out animation
                    requestElement.style.transition = 'all 0.3s ease';
                    requestElement.style.opacity = '0';
                    requestElement.style.transform = 'translateX(10px)';
                    
                    // After animation completes, remove the element
                    setTimeout(() => {
                        requestElement.remove();
                        
                        // Update the request count badge
                        const myRequestCountEl = document.getElementById('my-request-count');
                        if (myRequestCountEl) {
                            const currentCount = parseInt(myRequestCountEl.textContent.split(' ')[0]) - 1;
                            myRequestCountEl.textContent = currentCount + ' pending';
                            
                            // Hide badge if no more requests
                            if (currentCount <= 0) {
                                myRequestCountEl.style.display = 'none';
                                
                                // Show empty state
                                const noPassengerRequests = document.getElementById('no-passenger-requests');
                                const passengerRequestsContainer = document.getElementById('passenger-requests-container');
                                
                                if (noPassengerRequests) {
                                    noPassengerRequests.style.display = 'block';
                                }
                                
                                if (passengerRequestsContainer) {
                                    passengerRequestsContainer.style.display = 'none';
                                }
                            }
                        }
                    }, 300);
                    
                    // Show success message
                    alert(`❌ Request Cancelled\n\nYour ride request has been cancelled and the driver has been notified.\n\nYou can search for other rides or submit a new request anytime.`);
                    
                    // In a real implementation, we would reload the rides data
                    // loadMyRidesFromDatabase();
                } catch (error) {
                    console.error('Error cancelling ride request:', error);
                    alert('❌ Error cancelling ride request. Please try again.');
                }
            }
        }

        // Close booking modal
        function closeBookingModal() {
            document.getElementById('booking-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Removed demo function - now using real database data only

        // Removed demo override function - now using real database only
        
        // Update booking summary
        function updateBookingSummary() {
            const seats = parseInt(document.getElementById('booking-seats').value) || 1;
            const pricePerSeat = currentBookingData.price || 0;
            const totalAmount = seats * pricePerSeat;
            
            document.getElementById('booking-summary-seats').textContent = seats;
            document.getElementById('booking-summary-total').textContent = `$${totalAmount.toFixed(2)}`;
        }
        
        // Send ride request instead of direct booking
        async function confirmBooking() {
            const pickupAddress = document.getElementById('booking-pickup').value;
            const dropoffAddress = document.getElementById('booking-dropoff').value;
            const pickupNotes = document.getElementById('booking-pickup-notes').value;
            const dropoffNotes = document.getElementById('booking-dropoff-notes').value;
            const seats = document.getElementById('booking-seats').value;
            const specialRequests = document.getElementById('booking-requests').value || '';
            
            if (!pickupAddress || !dropoffAddress) {
                alert('Please fill in all required fields:\n- Pickup address\n- Drop-off address');
                return;
            }
            
            // Show loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p>Processing your booking...</p>
                </div>
            `;
            document.body.appendChild(loadingOverlay);
            
            try {
                // Check actual seat availability from the ride data
                const availableSeats = currentBookingData.available_seats || 0;
                const requestedSeats = parseInt(seats);
                
                if (availableSeats < requestedSeats) {
                    alert(`❌ Not enough seats available!\n\nRequested: ${requestedSeats} seat(s)\nAvailable: ${availableSeats} seat(s)`);
                    document.body.removeChild(loadingOverlay);
                    return;
                }
                
                // Calculate actual distance and price at 0.22 cents per seat per km
                let actualDistance = 0;
                let calculatedPrice = 0;
                let pickupCoords = null;
                let dropoffCoords = null;
                
                // Get coordinates for pickup and dropoff addresses using geocoding
                try {
                    [pickupCoords, dropoffCoords] = await Promise.all([
                        geocodeAddress(pickupAddress),
                        geocodeAddress(dropoffAddress)
                    ]);
                    
                    if (pickupCoords && dropoffCoords) {
                        actualDistance = calculateDistance(
                            pickupCoords[0], pickupCoords[1], 
                            dropoffCoords[0], dropoffCoords[1]
                        );
                        calculatedPrice = (actualDistance * 0.22 * parseInt(seats)).toFixed(2);
                    } else {
                        // Fallback if geocoding fails
                        calculatedPrice = (parseInt(seats) * currentBookingData.price).toFixed(2);
                    }
                } catch (geocodeError) {
                    console.error('Geocoding error:', geocodeError);
                    calculatedPrice = (parseInt(seats) * currentBookingData.price).toFixed(2);
                }
                
                const distanceText = actualDistance > 0 ? `${actualDistance.toFixed(1)} km` : 'Distance calculated on route';
                
                // Insert booking into the database
                const { data, error } = await supabase
                    .from('ride_bookings')
                    .insert([
                        {
                            ride_id: currentBookingData.id,
                            passenger_id: currentUser.id,
                            status: 'pending',
                            pickup_address: pickupAddress,
                            dropoff_address: dropoffAddress,
                            pickup_notes: pickupNotes,
                            dropoff_notes: dropoffNotes,
                            seats: parseInt(seats),
                            total_price: parseFloat(calculatedPrice),
                            special_requests: specialRequests,
                            pickup_lat: pickupCoords ? pickupCoords[0] : null,
                            pickup_lng: pickupCoords ? pickupCoords[1] : null,
                            dropoff_lat: dropoffCoords ? dropoffCoords[0] : null,
                            dropoff_lng: dropoffCoords ? dropoffCoords[1] : null
                        }
                    ]);
                
                if (error) {
                    console.error('Booking error:', error);
                    alert('Error booking ride: ' + error.message);
                    document.body.removeChild(loadingOverlay);
                    return;
                }
                
                // Show success message
                document.body.removeChild(loadingOverlay);
                
                alert(`🕒 Ride Request Sent!
            
Your request has been sent to ${currentBookingData.driverName} and is now pending approval.

Request Details:
Route: ${currentBookingData.fromCity || 'Origin'} → ${currentBookingData.toCity || 'Destination'}
Date: ${currentBookingData.date || 'Scheduled date'}
Pickup: ${pickupAddress}
Drop-off: ${dropoffAddress}
Seats: ${seats}
Distance: ${distanceText}
Total Price: $${calculatedPrice} (0.22¢ per seat per km)

✅ Status: Pending Driver Approval
⏰ You'll be notified when the driver responds
📱 Check "My Rides" > "Ride Requests" for status updates

The driver can accept or decline your request.`);
                
                // Refresh My Rides data
                if (typeof loadMyRidesFromDatabase === 'function') {
                    setTimeout(loadMyRidesFromDatabase, 1000);
                }
                
                closeBookingModal();
            } catch (error) {
                document.body.removeChild(loadingOverlay);
                console.error('Request error:', error);
                
                // Fallback for any error
                const fallbackPrice = (parseInt(seats) * (currentBookingData.price || 0)).toFixed(2);
                alert(`An error occurred during booking: ${error.message || 'Unknown error'}`);
            }
        }
        
        // Select user type with visual buttons
        function selectUserType(type) {
            // Update hidden input
            document.getElementById('user-type').value = type;
            
            // Update button states
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Update description
            const descriptions = {
                'passenger': 'Find and book rides from other users',
                'driver': 'Offer rides and earn money from passengers', 
                'both': 'Switch between finding rides and offering rides'
            };
            document.getElementById('user-type-description').textContent = descriptions[type];
            
            // Handle user type change
            handleUserTypeChange();
        }
        
        // Initialize Stripe
        function initializeStripe() {
            if (typeof Stripe !== 'undefined') {
                stripe = Stripe(STRIPE_PUBLIC_KEY);
                elements = stripe.elements();
                
                // Create bank account element for payouts
                bankAccountElement = elements.create('iban', {
                    supportedCountries: ['US'],
                    placeholderCountry: 'US',
                });
            }
        }
        
        // Toggle payment method mode
        function togglePaymentMode(mode) {
            document.querySelectorAll('.payment-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            const manualForm = document.getElementById('manual-payment-form');
            const stripeForm = document.getElementById('stripe-payment-form');
            
            if (mode === 'manual') {
                manualForm.style.display = 'block';
                stripeForm.style.display = 'none';
            } else {
                manualForm.style.display = 'none';
                stripeForm.style.display = 'block';
                
                // Mount Stripe element if not already mounted
                if (bankAccountElement && !bankAccountElement._mounted) {
                    bankAccountElement.mount('#stripe-bank-element');
                }
            }
        }
        
        // Save payment method
        function savePaymentMethod() {
            const activeMode = document.querySelector('.payment-mode-btn.active').dataset.mode;
            
            if (activeMode === 'manual') {
                const accountNumber = document.getElementById('account-number').value;
                const routingNumber = document.getElementById('routing-number').value;
                const accountHolder = document.getElementById('account-holder').value;
                
                if (!accountNumber || !routingNumber || !accountHolder) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Simulate saving payment method
                currentPaymentMethod = {
                    type: 'manual',
                    accountNumber: '••••' + accountNumber.slice(-4),
                    routingNumber: routingNumber,
                    accountHolder: accountHolder
                };
            } else {
                // Stripe integration for secure payment method
                if (!bankAccountElement) {
                    alert('Stripe payment form not loaded properly');
                    return;
                }
                
                // Simulate Stripe bank account setup
                currentPaymentMethod = {
                    type: 'stripe',
                    accountNumber: '•••• •••• •••• 4242',
                    provider: 'Stripe'
                };
            }
            
            // Update UI to show saved payment method
            updatePaymentMethodDisplay();
            enablePayoutIfEligible();
            alert('Payment method saved successfully!');
        }
        
        // Update payment method display
        function updatePaymentMethodDisplay() {
            if (currentPaymentMethod) {
                document.getElementById('payment-method-setup').style.display = 'none';
                document.getElementById('payment-method-display').style.display = 'block';
                document.getElementById('card-display').textContent = currentPaymentMethod.accountNumber;
            }
        }
        
        // Update payment method
        function updatePaymentMethod() {
            document.getElementById('payment-method-setup').style.display = 'block';
            document.getElementById('payment-method-display').style.display = 'none';
        }
        
        // Check if payout is available (Mondays only)
        function enablePayoutIfEligible() {
            const today = new Date();
            const isMonday = today.getDay() === 1;
            const payoutBtn = document.getElementById('payout-btn');
            
            if (isMonday && currentPaymentMethod) {
                payoutBtn.disabled = false;
                payoutBtn.innerHTML = '<i class="fas fa-arrow-circle-down"></i> Request Payout';
            } else if (!isMonday) {
                payoutBtn.disabled = true;
                payoutBtn.innerHTML = '<i class="fas fa-clock"></i> Available on Monday';
            } else {
                payoutBtn.disabled = true;
                payoutBtn.innerHTML = '<i class="fas fa-credit-card"></i> Add Payment Method';
            }
        }
        
        // Initiate payout
        function initiatePayout() {
            if (!currentPaymentMethod) {
                alert('Please set up a payment method first');
                return;
            }
            
            const today = new Date();
            if (today.getDay() !== 1) {
                alert('Payouts are only available on Mondays');
                return;
            }
            
            // Simulate payout process
            const amount = '$247.50';
            if (confirm(`Request payout of ${amount} to your bank account?`)) {
                // Simulate Stripe payout
                setTimeout(() => {
                    alert('Payout requested successfully! Funds will be transferred within 2-3 business days.');
                    
                    // Update UI to reflect payout
                    const payoutBtn = document.getElementById('payout-btn');
                    payoutBtn.disabled = true;
                    payoutBtn.innerHTML = '<i class="fas fa-check"></i> Payout Requested';
                    
                    // Add to payout history (in real app, this would be saved to database)
                    addPayoutToHistory(amount);
                }, 1000);
            }
        }
        
        // Add payout to history
        function addPayoutToHistory(amount) {
            const today = new Date();
            const payoutList = document.querySelector('.payout-list');
            
            const payoutItem = document.createElement('div');
            payoutItem.className = 'payout-history-item';
            payoutItem.innerHTML = `
                <div class="payout-details">
                    <strong>Week of ${today.toLocaleDateString()}</strong>
                    <div class="payout-date">Requested on ${today.toLocaleDateString()}</div>
                </div>
                <div class="payout-amount">${amount}</div>
                <div class="payout-status pending">
                    <i class="fas fa-clock"></i> Processing
                </div>
            `;
            
            payoutList.insertBefore(payoutItem, payoutList.firstChild);
        }
        
        // Filter earnings by period
        function filterEarnings() {
            const period = document.getElementById('earnings-period').value;
            // In a real app, this would filter the earnings data
            console.log('Filtering earnings for period:', period);
        }
        
        // Handle user type change
        function handleUserTypeChange() {
            const userType = document.getElementById('user-type').value;
            const driverFields = document.getElementById('driver-fields');
            const passengerDashboard = document.getElementById('passenger-dashboard');
            const driverDashboard = document.getElementById('driver-dashboard');
            
            // New rating cards
            const passengerRatingCard = document.getElementById('passenger-rating-card');
            const driverRatingCard = document.getElementById('driver-rating-card');
            
            // Legacy rating elements (keep for compatibility)
            const passengerRating = document.getElementById('passenger-rating');
            const driverRating = document.getElementById('driver-rating');
            
            const licenseStatus = document.getElementById('license-status');
            
            if (userType === 'driver' || userType === 'both') {
                driverFields.style.display = 'block';
                licenseStatus.style.display = 'block';
                
                // Show appropriate ratings
                if (userType === 'driver') {
                    // New rating cards
                    passengerRatingCard.style.display = 'none';
                    driverRatingCard.style.display = 'block';
                    
                    // Legacy rating display
                    passengerRating.style.display = 'none';
                    driverRating.style.display = 'block';
                    
                    // Switch to driver dashboard view
                    passengerDashboard.style.display = 'none';
                    driverDashboard.style.display = 'block';
                } else {
                    // Both - show both ratings
                    // New rating cards
                    passengerRatingCard.style.display = 'block';
                    driverRatingCard.style.display = 'block';
                    
                    // Legacy rating display
                    passengerRating.style.display = 'block';
                    driverRating.style.display = 'block';
                    
                    // Both - show passenger by default, but make driver accessible
                    passengerDashboard.style.display = 'block';
                    driverDashboard.style.display = 'none';
                }
                
                // Show earnings navigation for drivers
                document.getElementById('earnings-nav').style.display = 'block';
            } else {
                // Passenger only
                driverFields.style.display = 'none';
                
                // New rating cards
                passengerRatingCard.style.display = 'block';
                driverRatingCard.style.display = 'none';
                
                // Legacy rating display
                passengerRating.style.display = 'block';
                driverRating.style.display = 'none';
                licenseStatus.style.display = 'none';
                
                passengerDashboard.style.display = 'block';
                driverDashboard.style.display = 'none';
                
                // Hide earnings navigation for passengers
                document.getElementById('earnings-nav').style.display = 'none';
            }
            
            // Update navigation based on user type
            updateNavigationForUserType(userType);
            
            // Show/hide Post Ride tab based on user type
            const postRideTab = document.querySelector('[data-tab="post-ride"]');
            if (userType === 'passenger') {
                postRideTab.style.display = 'none';
                
                // If currently on post-ride tab, switch to find-rides
                if (document.getElementById('post-ride').classList.contains('active')) {
                    switchTab('find-rides');
                }
            } else {
                postRideTab.style.display = 'flex';
            }
        }
        
        // Update navigation based on user type
        function updateNavigationForUserType(userType) {
            const dashboardTab = document.querySelector('[data-tab="dashboard"]');
            
            if (userType === 'driver') {
                dashboardTab.innerHTML = '<i class="fas fa-car"></i><span>Driver</span>';
            } else if (userType === 'both') {
                dashboardTab.innerHTML = '<i class="fas fa-exchange-alt"></i><span>Switch</span>';
                // Add click handler for switching views
                dashboardTab.onclick = function() {
                    const passengerDash = document.getElementById('passenger-dashboard');
                    const driverDash = document.getElementById('driver-dashboard');
                    
                    if (passengerDash.style.display !== 'none') {
                        passengerDash.style.display = 'none';
                        driverDash.style.display = 'block';
                        dashboardTab.innerHTML = '<i class="fas fa-user"></i><span>Passenger</span>';
                    } else {
                        passengerDash.style.display = 'block';
                        driverDash.style.display = 'none';
                        dashboardTab.innerHTML = '<i class="fas fa-car"></i><span>Driver</span>';
                    }
                    
                    // Activate dashboard tab
                    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
                    dashboardTab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById('dashboard').classList.add('active');
                };
            } else {
                dashboardTab.innerHTML = '<i class="fas fa-chart-line"></i><span>Dashboard</span>';
                dashboardTab.onclick = null;
            }
        }
        
        // Request management functions
        function filterRequests(status) {
            // Update active tab
            document.querySelectorAll('.request-filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-filter="${status}"]`).classList.add('active');

            // Show/hide requests based on status
            document.querySelectorAll('.request-item').forEach(item => {
                if (item.dataset.status === status) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // Check if category is empty
            const visibleItems = document.querySelectorAll(`.request-item[data-status="${status}"]:not([style*="none"])`);
            const noRequestsMsg = document.getElementById('no-requests');
            
            if (visibleItems.length === 0) {
                noRequestsMsg.style.display = 'block';
            } else {
                noRequestsMsg.style.display = 'none';
            }
        }

        function toggleRequestDetails(button) {
            const requestItem = button.closest('.request-item');
            const specialSection = requestItem.querySelector('.request-special');
            
            if (specialSection.style.display === 'none') {
                specialSection.style.display = 'block';
                button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Details';
            } else {
                specialSection.style.display = 'none';
                button.innerHTML = '<i class="fas fa-eye"></i> View Details';
            }
        }

        function acceptBookingRequest(requestId, button) {
            const requestItem = button.closest('.request-item');
            const passengerName = requestItem.querySelector('.passenger-name').textContent;
            
            if (confirm(`Accept booking request from ${passengerName}?`)) {
                // Update request status
                requestItem.dataset.status = 'accepted';
                requestItem.className = 'request-item accepted';
                
                // Update status display
                const statusElement = requestItem.querySelector('.request-status');
                statusElement.className = 'request-status accepted';
                statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Accepted';
                
                // Update actions
                const actionsContainer = requestItem.querySelector('.request-actions');
                actionsContainer.innerHTML = `
                    <button class="btn btn-sm btn-primary" onclick="contactPassenger('${passengerName}')">
                        <i class="fas fa-phone"></i> Contact
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="cancelAcceptedBooking('${requestId}')">
                        <i class="fas fa-ban"></i> Cancel
                    </button>
                `;
                
                // Update counters
                updateRequestCounters();
                
                // Show success message
                alert(`✅ Booking accepted! ${passengerName} will be notified and you'll receive their contact details.`);
                
                // Switch to accepted tab
                filterRequests('accepted');
            }
        }

        function declineBookingRequest(requestId, button) {
            const requestItem = button.closest('.request-item');
            const passengerName = requestItem.querySelector('.passenger-name').textContent;
            
            if (confirm(`Decline booking request from ${passengerName}?`)) {
                // Update request status
                requestItem.dataset.status = 'declined';
                requestItem.className = 'request-item declined';
                
                // Update status display
                const statusElement = requestItem.querySelector('.request-status');
                statusElement.className = 'request-status declined';
                statusElement.innerHTML = '<i class="fas fa-times-circle"></i> Declined';
                
                // Update actions
                const actionsContainer = requestItem.querySelector('.request-actions');
                actionsContainer.innerHTML = `
                    <div style="color: #666; font-style: italic; font-size: 0.9rem;">
                        Request declined
                    </div>
                `;
                
                // Update counters
                updateRequestCounters();
                
                alert(`❌ Booking declined. ${passengerName} will be notified.`);
            }
        }

        function updateRequestCounters() {
            const pendingCount = document.querySelectorAll('.request-item[data-status="pending"]').length;
            const acceptedCount = document.querySelectorAll('.request-item[data-status="accepted"]').length;
            const declinedCount = document.querySelectorAll('.request-item[data-status="declined"]').length;
            
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('accepted-count').textContent = acceptedCount;
            document.getElementById('declined-count').textContent = declinedCount;
        }

        function refreshRideRequests() {
            alert('🔄 Refreshing ride requests...\n\nIn a real app, this would fetch the latest requests from the server.');
        }

        function contactPassenger(passengerName) {
            alert(`📞 Contacting ${passengerName}...\n\nIn a real app, this would open chat or show contact details.`);
        }

        function cancelAcceptedBooking(requestId) {
            if (confirm('Are you sure you want to cancel this accepted booking? The passenger will be notified.')) {
                alert('🚫 Booking cancelled. The passenger has been notified and can look for alternative rides.');
            }
        }

        function viewDetailedEarnings() {
            alert('📊 Opening detailed earnings report...\n\nThis would show:\n• Daily/weekly/monthly breakdowns\n• Payment history\n• Tax information\n• Payout schedules');
        }

        // Stops management (duplicate functions removed - using main implementation above)

        // Accept booking request (legacy function - keeping for compatibility)
        function acceptBooking(requestId) {
            acceptBookingRequest(requestId, event.target);
        }

        // Decline booking request (legacy function - keeping for compatibility)
        function declineBooking(requestId) {
            declineBookingRequest(requestId, event.target);
        }
        
        // Leave a review for a ride
        function leaveReview(name, userType = 'driver') {
            openReviewModal(name, userType);
        }
        
        // Open review modal with category-based ratings
        function openReviewModal(name, userType) {
            const modal = document.getElementById('review-modal');
            const modalTitle = document.getElementById('review-modal-title');
            const reviewForm = document.getElementById('review-form-content');
            
            modalTitle.textContent = `Rate ${name}`;
            
            // Define rating categories based on user type
            const driverCategories = [
                { key: 'safety', label: 'Driving Safety', icon: 'shield-alt' },
                { key: 'cleanliness', label: 'Car Cleanliness', icon: 'sparkles' },
                { key: 'communication', label: 'Communication', icon: 'comments' },
                { key: 'punctuality', label: 'Punctuality', icon: 'clock' },
                { key: 'overall', label: 'Overall Experience', icon: 'star' }
            ];
            
            const passengerCategories = [
                { key: 'punctuality', label: 'Punctuality', icon: 'clock' },
                { key: 'friendliness', label: 'Friendliness', icon: 'smile' },
                { key: 'communication', label: 'Communication', icon: 'comments' },
                { key: 'respect', label: 'Respectfulness', icon: 'handshake' },
                { key: 'overall', label: 'Overall Experience', icon: 'star' }
            ];
            
            const categories = userType === 'driver' ? driverCategories : passengerCategories;
            
            // Generate review form HTML
            let formHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                        <i class="fas fa-${userType === 'driver' ? 'car' : 'user'}" style="color: var(--primary-color);"></i>
                        <span style="font-weight: 600;">${userType === 'driver' ? 'Driver' : 'Passenger'} Review</span>
                    </div>
                </div>
            `;
            
            categories.forEach(category => {
                formHTML += `
                    <div class="review-category" style="margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <i class="fas fa-${category.icon}" style="color: var(--primary-color); width: 16px;"></i>
                            <label style="font-weight: 500; font-size: 0.9rem;">${category.label}</label>
                        </div>
                        <div class="star-rating" data-category="${category.key}">
                            ${[1,2,3,4,5].map(num => `
                                <span class="star" data-rating="${num}" onclick="setRating('${category.key}', ${num})">
                                    <i class="fas fa-star"></i>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            
            formHTML += `
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label">Additional Comments (Optional)</label>
                    <textarea id="review-comment" class="form-input" rows="3" placeholder="Share your experience..."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button class="btn btn-secondary" onclick="closeReviewModal()" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="submitReview('${name}', '${userType}')" style="flex: 1;">Submit Review</button>
                </div>
            `;
            
            reviewForm.innerHTML = formHTML;
            modal.style.display = 'flex';
            
            // Initialize ratings object
            window.currentReviewRatings = {};
        }
        
        // Set star rating for a category
        function setRating(category, rating) {
            window.currentReviewRatings[category] = rating;
            
            const starContainer = document.querySelector(`[data-category="${category}"]`);
            const stars = starContainer.querySelectorAll('.star');
            
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Submit the review
        function submitReview(name, userType) {
            const comment = document.getElementById('review-comment').value;
            const ratings = window.currentReviewRatings;
            
            // Check if all categories are rated
            const requiredCategories = userType === 'driver' ? 5 : 5; // Both have 5 categories
            if (Object.keys(ratings).length < requiredCategories) {
                alert('Please rate all categories before submitting.');
                return;
            }
            
            // Calculate overall average
            const average = Object.values(ratings).reduce((sum, rating) => sum + rating, 0) / Object.keys(ratings).length;
            
            console.log('Review submitted:', {
                reviewee: name,
                userType: userType,
                ratings: ratings,
                average: average.toFixed(1),
                comment: comment
            });
            
            alert(`Thank you for your detailed review! Your ${average.toFixed(1)}-star review for ${name} has been submitted.`);
            closeReviewModal();
        }
        
        // Close review modal
        function closeReviewModal() {
            document.getElementById('review-modal').style.display = 'none';
            window.currentReviewRatings = {};
        }
        
        // View detailed reviews
        function viewDetailedReviews(type) {
            const reviewsData = {
                'driver-reviews': [
                    {
                        reviewer: 'Sarah P.',
                        date: 'March 10, 2024',
                        ratings: {
                            safety: 5,
                            cleanliness: 4,
                            communication: 5,
                            punctuality: 5,
                            overall: 5
                        },
                        comment: 'Excellent driver! Very safe on the road and kept the car spotless. Great communication throughout the trip.'
                    },
                    {
                        reviewer: 'User',
                        date: 'March 8, 2024',
                        ratings: {
                            safety: 4,
                            cleanliness: 5,
                            communication: 4,
                            punctuality: 4,
                            overall: 4
                        },
                        comment: 'Good experience overall. Car was very clean and drive was smooth.'
                    }
                ],
                'passenger-reviews': [
                    {
                        reviewer: 'John D.',
                        date: 'March 12, 2024',
                        ratings: {
                            punctuality: 5,
                            friendliness: 5,
                            communication: 4,
                            respect: 4,
                            overall: 4
                        },
                        comment: 'Great passenger! Very punctual and friendly throughout the ride.'
                    }
                ]
            };
            
            const reviews = reviewsData[type] || [];
            const userType = type.includes('driver') ? 'Driver' : 'Passenger';
            
            let reviewsHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <h4 style="margin-bottom: 1rem; color: var(--primary-color);">
                        <i class="fas fa-${type.includes('driver') ? 'car' : 'user'}"></i> 
                        Detailed ${userType} Reviews
                    </h4>
            `;
            
            reviews.forEach(review => {
                reviewsHTML += `
                    <div style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; border-left: 4px solid var(--primary-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="font-weight: 600;">${review.reviewer}</span>
                            <span style="font-size: 0.8rem; opacity: 0.7;">${review.date}</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.75rem; font-size: 0.85rem;">
                `;
                
                Object.entries(review.ratings).forEach(([category, rating]) => {
                    const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                    reviewsHTML += `
                        <div style="display: flex; justify-content: space-between;">
                            <span>${categoryName}:</span>
                            <span>${'⭐'.repeat(rating)}</span>
                        </div>
                    `;
                });
                
                reviewsHTML += `
                        </div>
                        
                        ${review.comment ? `
                            <div style="font-style: italic; padding: 0.5rem; background: rgba(255, 255, 255, 0.5); border-radius: 8px; font-size: 0.9rem;">
                                "${review.comment}"
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            reviewsHTML += `
                    <div style="text-align: center; margin-top: 1rem;">
                        <button class="btn btn-primary" onclick="closeDetailedReviews()">Close</button>
                    </div>
                </div>
            `;
            
            // Create detailed reviews modal
            let detailedModal = document.getElementById('detailed-reviews-modal');
            if (!detailedModal) {
                detailedModal = document.createElement('div');
                detailedModal.id = 'detailed-reviews-modal';
                detailedModal.className = 'modal';
                detailedModal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                        <div id="detailed-reviews-content"></div>
                    </div>
                `;
                document.body.appendChild(detailedModal);
            }
            
            document.getElementById('detailed-reviews-content').innerHTML = reviewsHTML;
            detailedModal.style.display = 'flex';
        }
        
        // Close detailed reviews modal
        function closeDetailedReviews() {
            const modal = document.getElementById('detailed-reviews-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // View all reviews from a specific user type
        function viewAllReviews(userType) {
            const reviews = userType === 'driver' ? getDriverReviews() : getPassengerReviews();
            const title = userType === 'driver' ? 'Driver Reviews' : 'Passenger Reviews';
            
            // Create and show the reviews modal
            showReviewsModal(title, reviews, userType);
        }
        
        // Get passenger reviews from database
        async function getPassengerReviews() {
            try {
                const { data, error } = await supabase
                    .from('reviews')
                    .select('*')
                    .eq('reviewee_type', 'passenger')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching passenger reviews:', error);
                return [];
            }
        }
        
        // Get driver reviews from database
        async function getDriverReviews() {
            try {
                const { data, error } = await supabase
                    .from('reviews')
                    .select('*')
                    .eq('reviewee_type', 'driver')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error fetching driver reviews:', error);
                return [];
            }
        }
        
        // Show reviews modal with all reviews
        function showReviewsModal(title, reviews, userType) {
            let modalContent = `
                <div class="reviews-modal-header">
                    <h3><i class="fas fa-${userType === 'driver' ? 'car' : 'user'}"></i> ${title}</h3>
                    <span>(${reviews.length} reviews)</span>
                </div>
                <div class="reviews-list">
            `;
            
            reviews.forEach(review => {
                const stars = '⭐'.repeat(Math.round(review.ratings.overall));
                
                modalContent += `
                    <div class="review-item">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-name">${review.reviewer}</div>
                                <div class="review-date">${review.date}</div>
                            </div>
                            <div class="review-rating">${stars} (${review.ratings.overall.toFixed(1)})</div>
                        </div>
                        
                        <div class="review-categories">
                `;
                
                // Add category bars for each rating
                Object.entries(review.ratings).forEach(([category, rating]) => {
                    if (category !== 'overall') {
                        const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                        const percent = (rating / 5) * 100;
                        
                        modalContent += `
                            <div class="review-category-item">
                                <span class="review-category-name">${categoryName}</span>
                                <div class="review-category-bar">
                                    <div class="review-category-fill" style="width: ${percent}%;"></div>
                                </div>
                                <span class="review-category-score">${rating.toFixed(1)}</span>
                            </div>
                        `;
                    }
                });
                
                modalContent += `
                        </div>
                        
                        <div class="review-comment">${review.comment}</div>
                    </div>
                `;
            });
            
            modalContent += `
                </div>
                <button class="btn btn-primary" onclick="closeReviewsModal()">Close</button>
            `;
            
            // Create modal if it doesn't exist
            let reviewsModal = document.getElementById('all-reviews-modal');
            if (!reviewsModal) {
                reviewsModal = document.createElement('div');
                reviewsModal.id = 'all-reviews-modal';
                reviewsModal.className = 'modal';
                reviewsModal.innerHTML = `
                    <div class="modal-content reviews-modal-content">
                        <div id="reviews-modal-body"></div>
                    </div>
                `;
                document.body.appendChild(reviewsModal);
            }
            
            document.getElementById('reviews-modal-body').innerHTML = modalContent;
            reviewsModal.style.display = 'flex';
        }
        
        // Close reviews modal
        function closeReviewsModal() {
            const modal = document.getElementById('all-reviews-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Verify driver license
        async function verifyLicense() {
            try {
                const province = document.getElementById('license-province').value;
                const licenseNumber = document.getElementById('license-number').value;
                const licenseExpiry = document.getElementById('license-expiry').value;
                const licenseImageInput = document.getElementById('license-image');
                
                if (!province || !licenseNumber || !licenseExpiry || !licenseImageInput.files[0]) {
                    alert('Please fill in all license verification fields.');
                    return;
                }
                
                // Get current user ID
                const currentUserId = getCurrentUserId();
                if (!currentUserId) {
                    alert('You must be logged in to verify your license.');
                    return;
                }
                
                // Check if user already has a verified license that hasn't expired
                const { data: existingVerifications, error: checkError } = await supabase
                    .from('license_verifications')
                    .select('verification_status, expiry_date')
                    .eq('user_id', currentUserId)
                    .eq('verification_status', 'verified')
                    .gte('expiry_date', new Date().toISOString().split('T')[0])
                    .limit(1);
                
                if (checkError) {
                    console.error('Error checking existing license:', checkError);
                    alert('An error occurred while checking your verification status. Please try again.');
                    return;
                }
                
                if (existingVerifications && existingVerifications.length > 0) {
                    const expiryDate = new Date(existingVerifications[0].expiry_date);
                    const formattedExpiry = expiryDate.toLocaleDateString();
                    
                    if (confirm(`You already have a verified license valid until ${formattedExpiry}. Do you still want to submit a new verification?`)) {
                        // Continue with submission
                    } else {
                        return; // User cancelled
                    }
                }
                
                // Upload license image to storage
                const file = licenseImageInput.files[0];
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUserId}_${Date.now()}.${fileExt}`;
                const filePath = `license-documents/${fileName}`;
                
                // Upload the file
                const { error: uploadError } = await supabase.storage
                    .from('license-documents')
                    .upload(filePath, file);
                
                if (uploadError) {
                    console.error('Error uploading license image:', uploadError);
                    alert('Failed to upload license image. Please try again.');
                    return;
                }
                
                // Get public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('license-documents')
                    .getPublicUrl(filePath);
                
                // Store verification data in the database
                const { error: insertError } = await supabase
                    .from('license_verifications')
                    .insert([{
                        user_id: currentUserId,
                        license_number: licenseNumber,
                        issuing_state_country: province,
                        expiry_date: licenseExpiry,
                        verification_status: 'submitted',
                        license_document_url: publicUrl,
                        submitted_at: new Date().toISOString()
                    }]);
                
                if (insertError) {
                    console.error('Error saving license verification:', insertError);
                    alert('An error occurred while submitting your verification. Please try again.');
                    return;
                }
                
                // Update UI
                alert('License verification submitted! Our team will review your information within 24-48 hours. You will be notified once verification is complete.');
                
                // Update license status display
                document.getElementById('license-status').style.color = 'var(--warning-color)';
                document.getElementById('license-status-text').innerHTML = '<i class="fas fa-clock"></i> License verification in progress';
                document.getElementById('license-status').style.display = 'block';
                
                // Update profile license display
                await checkProfileLicenseStatus();
                
                // Check license status for ride posting
                await checkLicenseStatus();
                
            } catch (error) {
                console.error('Error in verifyLicense:', error);
                alert('An error occurred during license verification. Please try again.');
            }
        }
        
        // Function to get current user ID
        function getCurrentUserId() {
            // Get the authenticated user's ID from Supabase session
            if (currentUser && currentUser.id) {
                return currentUser.id;
            }
            // Fallback to localStorage for non-Supabase sessions
            const storedId = localStorage.getItem('currentUserId');
            if (storedId && storedId !== 'user123') {
                return storedId;
            }
            // Return null if no valid user ID found
            return null;
        }
        
        // Check profile license verification status
        async function checkProfileLicenseStatus() {
            try {
                // Check if supabase is initialized
                if (!supabase) {
                    console.log('Supabase not yet initialized for license check');
                    return;
                }
                
                // Get current user ID
                const currentUserId = getCurrentUserId();
                if (!currentUserId) {
                    console.log('No valid user ID found for license check');
                    return;
                }
                
                // Get latest license verification record
                const { data, error } = await supabase
                    .from('license_verifications')
                    .select('verification_status, expiry_date, submitted_at')
                    .eq('user_id', currentUserId)
                    .order('submitted_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('Error checking profile license status:', error);
                    return;
                }
                
                // Get elements
                const verificationStatus = document.getElementById('license-verification-status');
                const verificationForm = document.getElementById('license-verification-form');
                const statusMessage = document.getElementById('license-status-message');
                const expiryInfo = document.getElementById('license-expiry-info');
                
                // If no verification record exists
                if (!data || data.length === 0) {
                    verificationStatus.style.display = 'none';
                    verificationForm.style.display = 'block';
                    return;
                }
                
                const record = data[0];
                const status = record.verification_status.toLowerCase();
                
                // Check if license is expired
                let isExpired = false;
                let expiryDate = null;
                
                if (record.expiry_date) {
                    expiryDate = new Date(record.expiry_date);
                    const today = new Date();
                    isExpired = expiryDate < today;
                }
                
                verificationStatus.style.display = 'block';
                
                // Format submission date
                const submittedDate = new Date(record.submitted_at);
                const formattedSubmission = submittedDate.toLocaleDateString();
                
                // Format expiry date if available
                let formattedExpiry = 'Not specified';
                if (expiryDate) {
                    formattedExpiry = expiryDate.toLocaleDateString();
                }
                
                // Update expiry info
                expiryInfo.innerHTML = `<strong>Submitted:</strong> ${formattedSubmission} &bull; <strong>Expires:</strong> ${formattedExpiry}`;
                
                // Update status message and styling based on verification status
                if (isExpired) {
                    verificationStatus.style.backgroundColor = 'rgba(229, 62, 62, 0.1)';
                    verificationStatus.style.borderLeft = '4px solid var(--error-color)';
                    statusMessage.innerHTML = '<strong style="color: var(--error-color);"><i class="fas fa-exclamation-circle"></i> License Expired</strong><br>Your license has expired. Please submit a new verification.';
                    verificationForm.style.display = 'block';
                } else if (status === 'pending' || status === 'submitted') {
                    verificationStatus.style.backgroundColor = 'rgba(237, 137, 54, 0.1)';
                    verificationStatus.style.borderLeft = '4px solid var(--warning-color)';
                    statusMessage.innerHTML = '<strong style="color: var(--warning-color);"><i class="fas fa-clock"></i> Verification Pending</strong><br>Your license verification is being reviewed. This typically takes 24-48 hours.';
                    verificationForm.style.display = 'none';
                } else if (status === 'verified') {
                    verificationStatus.style.backgroundColor = 'rgba(56, 178, 172, 0.1)';
                    verificationStatus.style.borderLeft = '4px solid var(--success-color)';
                    statusMessage.innerHTML = '<strong style="color: var(--success-color);"><i class="fas fa-check-circle"></i> License Verified</strong><br>Your license has been verified. You can post rides.';
                    verificationForm.style.display = 'none';
                } else if (status === 'declined' || status === 'rejected') {
                    verificationStatus.style.backgroundColor = 'rgba(229, 62, 62, 0.1)';
                    verificationStatus.style.borderLeft = '4px solid var(--error-color)';
                    statusMessage.innerHTML = '<strong style="color: var(--error-color);"><i class="fas fa-times-circle"></i> Verification Declined</strong><br>Your license verification was declined. Please submit a clearer image or contact support.';
                    verificationForm.style.display = 'block';
                } else {
                    verificationStatus.style.backgroundColor = 'rgba(237, 137, 54, 0.1)';
                    verificationStatus.style.borderLeft = '4px solid var(--warning-color)';
                    statusMessage.innerHTML = '<strong style="color: var(--warning-color);"><i class="fas fa-question-circle"></i> Status Unknown</strong><br>We couldn\'t determine your verification status. Please contact support.';
                    verificationForm.style.display = 'block';
                }
            } catch (error) {
                console.error('Error in checkProfileLicenseStatus:', error);
            }
        }
        
        // Check license verification status for posting rides
        async function checkLicenseStatus() {
            try {
                // Get current user ID
                const currentUserId = getCurrentUserId();
                if (!currentUserId) {
                    console.log('No valid user ID found for license verification check');
                    return;
                }
                
                // Get user type
                const userType = document.getElementById('user-type').value;
                
                // Only check license verification for drivers
                if (userType !== 'driver' && userType !== 'both') {
                    document.getElementById('license-verification-warning').style.display = 'none';
                    document.getElementById('post-ride-btn').disabled = false;
                    document.getElementById('post-ride-btn').style.opacity = '1';
                    return;
                }
                
                // Get latest license verification status from the database
                const { data, error } = await supabase
                    .from('license_verifications')
                    .select('verification_status, expiry_date')
                    .eq('user_id', currentUserId)
                    .order('submitted_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('Error checking license status:', error);
                    return;
                }
                
                // Set license status display
                const licenseStatusEl = document.getElementById('license-status');
                const licenseStatusTextEl = document.getElementById('license-status-text');
                
                // If no verification record exists
                if (!data || data.length === 0) {
                    document.getElementById('license-verification-warning').style.display = 'block';
                    document.getElementById('post-ride-btn').disabled = true;
                    document.getElementById('post-ride-btn').style.opacity = '0.6';
                    
                    licenseStatusEl.style.display = 'none';
                    return;
                }
                
                const verificationRecord = data[0];
                licenseStatusEl.style.display = 'block';
                
                // Check if license is expired
                let isExpired = false;
                if (verificationRecord.expiry_date) {
                    const expiryDate = new Date(verificationRecord.expiry_date);
                    const today = new Date();
                    isExpired = expiryDate < today;
                }
                
                // Update UI based on verification status
                const status = verificationRecord.verification_status.toLowerCase();
                
                if (isExpired) {
                    licenseStatusEl.style.color = 'var(--error-color)';
                    licenseStatusTextEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> License expired - please update';
                    document.getElementById('license-verification-warning').style.display = 'block';
                    document.getElementById('post-ride-btn').disabled = true;
                    document.getElementById('post-ride-btn').style.opacity = '0.6';
                } else if (status === 'pending' || status === 'submitted') {
                    licenseStatusEl.style.color = 'var(--warning-color)';
                    licenseStatusTextEl.innerHTML = '<i class="fas fa-clock"></i> License verification pending';
                    document.getElementById('license-verification-warning').style.display = 'block';
                    document.getElementById('post-ride-btn').disabled = true;
                    document.getElementById('post-ride-btn').style.opacity = '0.6';
                } else if (status === 'verified') {
                    licenseStatusEl.style.color = 'var(--success-color)';
                    licenseStatusTextEl.innerHTML = '<i class="fas fa-check-circle"></i> License verified';
                    document.getElementById('license-verification-warning').style.display = 'none';
                    document.getElementById('post-ride-btn').disabled = false;
                    document.getElementById('post-ride-btn').style.opacity = '1';
                } else if (status === 'declined' || status === 'rejected') {
                    licenseStatusEl.style.color = 'var(--error-color)';
                    licenseStatusTextEl.innerHTML = '<i class="fas fa-times-circle"></i> License verification declined';
                    document.getElementById('license-verification-warning').style.display = 'block';
                    document.getElementById('post-ride-btn').disabled = true;
                    document.getElementById('post-ride-btn').style.opacity = '0.6';
                } else {
                    licenseStatusEl.style.color = 'var(--warning-color)';
                    licenseStatusTextEl.innerHTML = '<i class="fas fa-question-circle"></i> License status unknown';
                    document.getElementById('license-verification-warning').style.display = 'block';
                    document.getElementById('post-ride-btn').disabled = true;
                    document.getElementById('post-ride-btn').style.opacity = '0.6';
                }
            } catch (error) {
                console.error('Error in checkLicenseStatus:', error);
            }
        }
        
        // Chat functionality
        let currentChatRideId = null;
        let currentChatParticipant = null;
        
        // Stripe configuration
        const STRIPE_PUBLIC_KEY = 'pk_test_51KJOZeL4t8YZbMFMKJmWLhQ4QzY8TvZrYzF8YzY8TvZrYzF8YzY8TvZrYzF8YzY8TvZrYzF8';
        let stripe = null;
        let elements = null;
        let bankAccountElement = null;
        
        // Payout system variables
        let currentPaymentMethod = null;
        let nextPayoutDate = null;
        let chatSubscription = null;

        // Open chat modal
        function openChat(rideId, participantName, participantType) {
            currentChatRideId = rideId;
            currentChatParticipant = participantName || "User";
            
            document.getElementById('chat-participant-name').textContent = participantName || "User";
            document.getElementById('chat-participant-type').textContent = participantType === 'driver' ? 'Driver' : 'Passenger';
            document.getElementById('chat-modal').style.display = 'flex';
            
            // Load existing messages
            loadChatMessages();
            
            // Set up real-time subscription
            setupChatSubscription();
        }
        
        function viewRideDetails(rideId) {
            // This would show a modal with ride details and route map
            // For now, we'll fetch the ride information from the database and display it in a modal
            if (!rideId) {
                alert("No ride ID provided");
                return;
            }
            
            // Show a loading message
            const detailsModal = document.getElementById('ride-details-modal') || createRideDetailsModal();
            detailsModal.innerHTML = `
                <div class="modal-content" style="position: relative; width: 90%; max-width: 500px; background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <button onclick="closeRideDetailsModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 style="margin-top: 0; margin-bottom: 1rem;">Loading Ride Details...</h3>
                    <div style="display: flex; justify-content: center; padding: 2rem;">
                        <div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            detailsModal.style.display = "flex";
            
            // In a real implementation, we'd fetch the ride data from the database
            fetchRideDetails(rideId);
        }
        
        // Create the modal for ride details if it doesn't exist
        function createRideDetailsModal() {
            const modal = document.createElement('div');
            modal.id = 'ride-details-modal';
            modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center;';
            document.body.appendChild(modal);
            return modal;
        }
        
        // Close the ride details modal
        function closeRideDetailsModal() {
            const modal = document.getElementById('ride-details-modal');
            if (modal) {
                modal.style.display = "none";
            }
        }
        
        // Fetch ride details from the database
        async function fetchRideDetails(rideId) {
            try {
                console.log('Fetching details for ride ID:', rideId);
                
                // First, get the ride details
                const { data: ride, error } = await supabase
                    .from('rides')
                    .select('*')
                    .eq('id', rideId)
                    .single();
                
                if (error) {
                    console.error('Error fetching ride details:', error);
                    throw error;
                }
                
                // Then get the driver details
                const { data: driverData, error: driverError } = await supabase
                    .from('users')
                    .select('full_name, email, phone, driver_rating')
                    .eq('id', ride.driver_id)
                    .single();
                
                if (driverError) {
                    console.error('Error fetching driver details:', driverError);
                    // Continue without driver data
                } else {
                    // Add driver data to ride object
                    ride.users = driverData;
                }
                
                // Get ride bookings for this ride
                const { data: bookings, error: bookingsError } = await supabase
                    .from('ride_bookings')
                    .select(`
                        *,
                        users (full_name)
                    `)
                    .eq('ride_id', rideId);
                
                if (bookingsError) {
                    console.error('Error fetching ride bookings:', bookingsError);
                    throw bookingsError;
                }
                
                // Get ride stops if any
                const { data: stops, error: stopsError } = await supabase
                    .from('ride_stops')
                    .select('*')
                    .eq('ride_id', rideId)
                    .order('stop_order', { ascending: true });
                
                if (stopsError) {
                    console.error('Error fetching ride stops:', stopsError);
                    // Continue without stops data
                } else if (stops && stops.length > 0) {
                    // Add stops data to ride object
                    ride.stops = stops;
                    console.log('Successfully fetched ride stops:', stops);
                }
                
                console.log('Successfully fetched ride details:', ride);
                displayRideDetails(ride, bookings || []);
                
            } catch (error) {
                console.error('Error fetching ride details:', error);
                // If there's an error or we can't fetch from the database, show a fallback with demo data
                displayFallbackRideDetails(rideId);
            }
        }
        
        // Display ride details in the modal
        function displayRideDetails(ride, bookings) {
            const detailsModal = document.getElementById('ride-details-modal');
            if (!detailsModal) return;
            
            // Get departure and destination addresses, handle undefined values
            const from = (ride.departure_address && ride.departure_address !== 'undefined') 
                ? ride.departure_address 
                : 'Unknown Location';
                
            const to = (ride.destination_address && ride.destination_address !== 'undefined') 
                ? ride.destination_address 
                : 'Unknown Destination';
            
            // Calculate price with proper error handling
            let price = ride.total_price_per_seat;
            if (!price || price === 0 || price === '0' || price === 'undefined') {
                const basePrice = parseFloat(ride.price_per_seat) || 0;
                price = basePrice * 1.12;
            }
            
            if (!price || isNaN(price) || price === 'undefined') {
                price = 0;
            }
            
            const formattedPrice = typeof price === 'number' ? price.toFixed(2) : parseFloat(price).toFixed(2);
            const departureTime = new Date(ride.departure_time);
            const date = departureTime.toLocaleDateString();
            const time = departureTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Calculate booked and available seats
            const totalSeats = ride.available_seats || 3;
            const bookedSeats = bookings.filter(b => b.status === 'confirmed').length;
            
            // Process stops if available
            const hasStops = ride.stops && ride.stops.length > 0;
            
            detailsModal.innerHTML = `
                <div class="modal-content" style="position: relative; width: 90%; max-width: 500px; background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <button onclick="closeRideDetailsModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 style="margin-top: 0; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-route" style="color: var(--primary-color);"></i> Ride Details
                    </h3>
                    
                    <!-- Route Map Preview -->
                    <div style="height: 180px; background: #f5f7fa; border-radius: 8px; margin: 1rem 0; position: relative; overflow: hidden;">
                        <!-- Route visualization placeholder - would be replaced with a real map -->
                        <div style="position: absolute; top: 50%; left: 10px; right: 10px; height: 3px; background: var(--primary-color); border-radius: 2px;"></div>
                        
                        <!-- Origin marker -->
                        <div style="position: absolute; top: 50%; left: 10px; transform: translate(0, -50%); width: 16px; height: 16px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 6px; height: 6px; background: white; border-radius: 50%;"></div>
                        </div>
                        
                        ${hasStops ? ride.stops.map((stop, index) => {
                            // Calculate position based on index
                            const position = 10 + ((100 - 20) / (ride.stops.length + 1)) * (index + 1);
                            return `
                            <!-- Stop ${index + 1} marker -->
                            <div style="position: absolute; top: 50%; left: ${position}%; transform: translate(-50%, -50%); width: 14px; height: 14px; background: #2196F3; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <div style="width: 6px; height: 6px; background: white; border-radius: 50%;"></div>
                            </div>
                            <div style="position: absolute; top: 60%; left: ${position}%; transform: translate(-50%, 0); font-size: 0.7rem; font-weight: 600; text-align: center;">
                                Stop ${index + 1}
                            </div>
                            `;
                        }).join('') : ''}
                        
                        <!-- Destination marker -->
                        <div style="position: absolute; top: 50%; right: 10px; transform: translate(0, -50%); width: 16px; height: 16px; background: var(--error-color); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                            <div style="width: 6px; height: 6px; background: white; border-radius: 50%;"></div>
                        </div>
                        
                        <!-- Location labels -->
                        <div style="position: absolute; top: 30%; left: 10px; font-size: 0.8rem; font-weight: 600; max-width: 40%;">${from}</div>
                        <div style="position: absolute; top: 30%; right: 10px; font-size: 0.8rem; font-weight: 600; max-width: 40%; text-align: right;">${to}</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div style="background: rgba(240, 240, 245, 0.5); padding: 0.75rem; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">Date</p>
                            <p style="margin: 0; font-weight: 600;">${date}</p>
                        </div>
                        <div style="background: rgba(240, 240, 245, 0.5); padding: 0.75rem; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">Time</p>
                            <p style="margin: 0; font-weight: 600;">${time}</p>
                        </div>
                        <div style="background: rgba(240, 240, 245, 0.5); padding: 0.75rem; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">Price</p>
                            <p style="margin: 0; font-weight: 600;">$${formattedPrice}</p>
                        </div>
                        <div style="background: rgba(240, 240, 245, 0.5); padding: 0.75rem; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.8rem; color: var(--text-color); opacity: 0.7;">Seats</p>
                            <p style="margin: 0; font-weight: 600;">${bookedSeats}/${totalSeats} booked</p>
                        </div>
                    </div>

                    ${hasStops ? `
                    <!-- Stops Section -->
                    <div style="background: rgba(240, 240, 245, 0.3); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            <i class="fas fa-map-marker-alt"></i> Intermediate Stops (${ride.stops.length})
                        </h4>
                        <div style="max-height: 150px; overflow-y: auto; padding-left: 0.5rem;">
                            ${ride.stops.map((stop, index) => `
                                <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                    <div style="width: 20px; height: 20px; background: #2196F3; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.5rem; font-size: 0.7rem;">
                                        ${index + 1}
                                    </div>
                                    <div>
                                        <p style="margin: 0; font-size: 0.85rem;">${stop.address || 'Stop ' + (index + 1)}</p>
                                        ${stop.eta ? `<p style="margin: 0; font-size: 0.75rem; color: #666;">ETA: ${stop.eta}</p>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Driver Info Section -->
                    <div style="background: rgba(240, 240, 245, 0.3); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            <i class="fas fa-user"></i> Driver Information
                        </h4>
                        <p style="margin: 0; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">${ride.users?.full_name || 'Driver Name'}</span>
                            <span>⭐ ${ride.users?.rating || '4.8'}</span>
                        </p>
                        <p style="margin: 0.25rem 0; font-size: 0.85rem;">
                            <i class="fas fa-car" style="margin-right: 0.25rem;"></i> ${ride.vehicle_info || 'Vehicle info not available'}
                        </p>
                    </div>
                    
                    <!-- Passengers List -->
                    ${bookings.length > 0 ? `
                        <div style="background: rgba(240, 240, 245, 0.3); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem;">
                            <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                                <i class="fas fa-users"></i> Passengers (${bookings.filter(b => b.status === 'confirmed').length})
                            </h4>
                            <div style="max-height: 150px; overflow-y: auto;">
                                ${bookings.map(booking => `
                                    <div style="display: flex; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(0,0,0,0.05);">
                                        <div style="width: 32px; height: 32px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem; font-size: 0.8rem;">
                                            ${booking.users.full_name ? booking.users.full_name.substring(0, 2).toUpperCase() : 'UN'}
                                        </div>
                                        <div style="flex: 1;">
                                            <p style="margin: 0; font-weight: 600;">${booking.users.full_name || 'Anonymous'}</p>
                                            <p style="margin: 0; font-size: 0.8rem; color: #666;">${booking.seats_requested || 1} seat(s) • ${booking.pickup_location || 'Main pickup'} → ${booking.dropoff_location || 'Main destination'}</p>
                                        </div>
                                        <div>
                                            <span style="background: ${getStatusColor(booking.status)}; color: white; padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem;">
                                                ${getStatusText(booking.status)}
                                            </span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 1rem;">
                        <button onclick="closeRideDetailsModal()" style="flex: 1; background: var(--border-color); color: var(--text-color); border: none; border-radius: 12px; padding: 0.75rem; cursor: pointer; font-weight: 600;">
                            Close
                        </button>
                        <button onclick="openChat('${ride.id}')" style="flex: 1; background: var(--primary-color); color: white; border: none; border-radius: 12px; padding: 0.75rem; cursor: pointer; font-weight: 600;">
                            <i class="fas fa-comments" style="margin-right: 0.5rem;"></i> Chat
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Helper functions for ride details
        function getStatusColor(status) {
            return status === 'pending' ? 'var(--warning-color)' : 
                   status === 'confirmed' ? 'var(--success-color)' : 'var(--error-color)';
        }
        
        function getStatusText(status) {
            return status === 'pending' ? 'Pending' : 
                   status === 'confirmed' ? 'Confirmed' : 'Declined';
        }
        
        // Fallback display for ride details when database fetch fails
        function displayFallbackRideDetails(rideId) {
            const detailsModal = document.getElementById('ride-details-modal');
            if (!detailsModal) return;
            
            detailsModal.innerHTML = `
                <div class="modal-content" style="position: relative; width: 90%; max-width: 500px; background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <button onclick="closeRideDetailsModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; cursor: pointer; font-size: 1.2rem;">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3 style="margin-top: 0; margin-bottom: 1rem;">Ride Details</h3>
                    <p>Ride ID: ${rideId}</p>
                    <p>Unable to fetch complete ride details. Please try again later.</p>
                    <button onclick="closeRideDetailsModal()" style="background: var(--primary-color); color: white; border: none; border-radius: 12px; padding: 0.75rem; width: 100%; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                        Close
                    </button>
                </div>
            `;
        }

        // Close chat modal
        function closeChat() {
            document.getElementById('chat-modal').style.display = 'none';
            currentChatRideId = null;
            currentChatParticipant = null;
            
            // Clean up subscription
            if (chatSubscription) {
                if (typeof chatSubscription.unsubscribe === 'function') {
                    chatSubscription.unsubscribe();
                } else {
                    clearInterval(chatSubscription);
                }
                chatSubscription = null;
            }
        }

        // Load chat messages
        async function loadChatMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            
            try {
                // Load real chat messages from database
                const { data, error } = await supabase
                    .from('chat_messages')
                    .select('*')
                    .eq('ride_id', currentChatRideId)
                    .order('created_at', { ascending: true });
                
                if (error) throw error;
                
                const messages = data.map(msg => ({
                    id: msg.id,
                    sender: msg.sender_id === getCurrentUserId() ? "You" : msg.sender_name || "Other User",
                    message: msg.message,
                    timestamp: new Date(msg.created_at),
                    isCurrentUser: msg.sender_id === getCurrentUserId()
                }));
                
                displayMessages(messages);
            } catch (error) {
                console.error('Error loading chat messages:', error);
                displayMessages([]); // Show empty chat on error
            }
        }

        // Display messages in chat
        function displayMessages(messages) {
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.isCurrentUser ? 'sent' : 'received'}`;
                
                const timeString = msg.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageDiv.innerHTML = `
                    <div class="message-content">${msg.message}</div>
                    <div class="message-time">${timeString}</div>
                `;
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add message to chat
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message sent';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${message}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Clear input
            input.value = '';
            
            // Send message to Supabase
            sendMessageToDatabase(message);
            
            // Simulate response after a delay
            setTimeout(() => {
                simulateIncomingMessage();
            }, 2000 + Math.random() * 3000);
        }

        // Simulate incoming message
        function simulateIncomingMessage() {
            const responses = [
                "Thanks for the update!",
                "Sounds good to me.",
                "See you then!",
                "I'll be ready.",
                "Great, thanks for letting me know."
            ];
            
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message received';
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${randomResponse}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Set up chat subscription with Supabase real-time
        function setupChatSubscription() {
            if (!supabase || !currentChatRideId) return;
            
            // Subscribe to chat messages for this ride
            chatSubscription = supabase
                .channel(`chat-${currentChatRideId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chat_messages',
                    filter: `ride_id=eq.${currentChatRideId}`
                }, (payload) => {
                    console.log('Real-time message received:', payload);
                    displayRealtimeMessage(payload.new);
                })
                .subscribe();
                
            console.log('Chat subscription established for ride:', currentChatRideId);
        }
        
        // Global real-time subscriptions
        let ridesSubscription = null;
        let bookingsSubscription = null;
        
        // Set up real-time subscriptions for rides and bookings
        function setupRealTimeSubscriptions() {
            if (!supabase || !currentUser) return;
            
            // Clean up existing subscriptions
            if (ridesSubscription) ridesSubscription.unsubscribe();
            if (bookingsSubscription) bookingsSubscription.unsubscribe();
            
            // Subscribe to rides changes
            ridesSubscription = supabase
                .channel('rides-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'rides'
                }, (payload) => {
                    console.log('Real-time rides change:', payload);
                    // Reload rides data when changes occur
                    if (getCurrentTab() === 'my-rides' || getCurrentTab() === 'find-rides') {
                        setTimeout(loadMyRidesFromDatabase, 500); // Small delay to ensure data consistency
                    }
                })
                .subscribe();
            
            // Subscribe to bookings changes
            bookingsSubscription = supabase
                .channel('bookings-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'ride_bookings'
                }, (payload) => {
                    console.log('Real-time bookings change:', payload);
                    // Reload rides data when bookings change
                    if (getCurrentTab() === 'my-rides') {
                        setTimeout(loadMyRidesFromDatabase, 500); // Small delay to ensure data consistency
                    }
                })
                .subscribe();
                
            console.log('Real-time subscriptions established for user:', currentUser.id);
        }
        
        // Get current active tab
        function getCurrentTab() {
            const activeTab = document.querySelector('.tab-button.active');
            return activeTab ? activeTab.getAttribute('data-tab') : null;
        }
        
        // Display real-time message
        function displayRealtimeMessage(messageData) {
            // Don't display our own messages
            if (messageData.sender_id === currentUser?.id) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message received';
            
            const timestamp = new Date(messageData.created_at);
            const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${messageData.content}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Show notification if chat is not visible
            showChatNotification(messageData);
        }
        
        // Send message to database
        async function sendMessageToDatabase(content) {
            if (!supabase || !currentUser || !currentChatRideId) {
                console.error('Missing requirements for sending message');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('chat_messages')
                    .insert([
                        {
                            ride_id: currentChatRideId,
                            sender_id: currentUser.id,
                            content: content,
                            message_type: 'text'
                        }
                    ]);
                
                if (error) {
                    console.error('Error sending message:', error);
                } else {
                    console.log('Message sent successfully');
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }
        
        // Show chat notification
        function showChatNotification(messageData) {
            if (document.getElementById('chat-modal').style.display === 'none') {
                // Show browser notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification('New Message', {
                        body: messageData.content,
                        icon: '/favicon.ico',
                        tag: 'chat-message'
                    });
                }
            }
        }

        // Handle Enter key in chat input
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Production Features Initialization
        function initializeProductionFeatures() {
            // Error logging and monitoring
            initializeErrorLogging();
            
            // Performance monitoring
            initializePerformanceMonitoring();
            
            // Security enhancements
            initializeSecurityFeatures();
            
            // Analytics and usage tracking
            initializeAnalytics();
            
            // Connection monitoring
            initializeConnectionMonitoring();
            
            console.log('🚀 Production features initialized');
        }
        
        // Error logging system
        function initializeErrorLogging() {
            // Global error handler
            window.addEventListener('error', (event) => {
                logError({
                    type: 'javascript_error',
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    stack: event.error?.stack,
                    timestamp: new Date().toISOString(),
                    user_agent: navigator.userAgent,
                    user_id: currentUser?.id
                });
            });
            
            // Unhandled promise rejections
            window.addEventListener('unhandledrejection', (event) => {
                logError({
                    type: 'unhandled_promise',
                    message: event.reason?.message || event.reason,
                    stack: event.reason?.stack,
                    timestamp: new Date().toISOString(),
                    user_id: currentUser?.id
                });
            });
            
            // Custom error logging function
            window.logCustomError = function(message, context = {}) {
                logError({
                    type: 'custom_error',
                    message: message,
                    context: context,
                    timestamp: new Date().toISOString(),
                    user_id: currentUser?.id
                });
            };
        }
        
        // Log errors to local storage and console
        function logError(errorData) {
            console.error('🚨 Error logged:', errorData);
            
            // Store errors locally for offline scenarios
            const errors = JSON.parse(localStorage.getItem('app_errors') || '[]');
            errors.push(errorData);
            
            // Keep only last 50 errors
            if (errors.length > 50) {
                errors.splice(0, errors.length - 50);
            }
            
            localStorage.setItem('app_errors', JSON.stringify(errors));
            
            // Send to server if online (in real app, send to error tracking service)
            if (navigator.onLine && supabase) {
                sendErrorToServer(errorData);
            }
        }
        
        // Send error to server
        async function sendErrorToServer(errorData) {
            try {
                // In production, replace with actual error tracking service
                console.log('📤 Would send to error service:', errorData);
            } catch (error) {
                console.error('Failed to send error to server:', error);
            }
        }
        
        // Performance monitoring
        function initializePerformanceMonitoring() {
            // Page load performance
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = {
                        load_time: performance.now(),
                        dom_ready: performance.timing.domContentLoadedEventEnd - performance.timing.navigationStart,
                        first_paint: performance.getEntriesByType('paint')[0]?.startTime,
                        largest_paint: performance.getEntriesByType('largest-contentful-paint')[0]?.startTime
                    };
                    
                    logPerformance('page_load', perfData);
                }, 0);
            });
            
            // AI model performance tracking
            window.logAIPerformance = function(operation, duration, success = true) {
                logPerformance('ai_operation', {
                    operation: operation,
                    duration: duration,
                    success: success,
                    timestamp: new Date().toISOString()
                });
            };
        }
        
        // Log performance metrics
        function logPerformance(metric, data) {
            const perfData = {
                metric: metric,
                data: data,
                timestamp: new Date().toISOString(),
                user_agent: navigator.userAgent,
                connection: navigator.connection?.effectiveType
            };
            
            console.log('📊 Performance metric:', perfData);
            
            // Store locally
            const metrics = JSON.parse(localStorage.getItem('app_metrics') || '[]');
            metrics.push(perfData);
            
            if (metrics.length > 100) {
                metrics.splice(0, metrics.length - 100);
            }
            
            localStorage.setItem('app_metrics', JSON.stringify(metrics));
        }
        
        // Security features
        function initializeSecurityFeatures() {
            // Content Security Policy simulation
            if (typeof window.trustedTypes !== 'undefined') {
                console.log('✅ Trusted Types supported');
            }
            
            // Input sanitization
            window.sanitizeInput = function(input) {
                if (typeof input !== 'string') return input;
                return input
                    .replace(/[<>'"]/g, (char) => {
                        const map = { '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;' };
                        return map[char];
                    });
            };
            
            // Rate limiting for API calls
            window.rateLimiter = {
                calls: new Map(),
                limit: function(key, maxCalls = 10, timeWindow = 60000) {
                    const now = Date.now();
                    const calls = this.calls.get(key) || [];
                    
                    // Remove old calls outside time window
                    const validCalls = calls.filter(time => now - time < timeWindow);
                    
                    if (validCalls.length >= maxCalls) {
                        return false; // Rate limited
                    }
                    
                    validCalls.push(now);
                    this.calls.set(key, validCalls);
                    return true; // Allowed
                }
            };
        }
        
        // Analytics and usage tracking
        function initializeAnalytics() {
            // Track user interactions
            const trackingEvents = ['click', 'scroll', 'focus'];
            
            trackingEvents.forEach(eventType => {
                document.addEventListener(eventType, (event) => {
                    if (event.target.matches('button, .nav-tab, .btn')) {
                        logUserAction(eventType, {
                            element: event.target.tagName,
                            className: event.target.className,
                            text: event.target.textContent?.slice(0, 50)
                        });
                    }
                }, { passive: true });
            });
            
            // Track feature usage
            window.trackFeatureUsage = function(feature, metadata = {}) {
                logUserAction('feature_usage', {
                    feature: feature,
                    metadata: metadata
                });
            };
        }
        
        // Log user actions
        function logUserAction(action, data) {
            const actionData = {
                action: action,
                data: data,
                timestamp: new Date().toISOString(),
                user_id: currentUser?.id,
                page: window.location.pathname
            };
            
            // Store locally for analytics
            const actions = JSON.parse(localStorage.getItem('user_actions') || '[]');
            actions.push(actionData);
            
            if (actions.length > 200) {
                actions.splice(0, actions.length - 200);
            }
            
            localStorage.setItem('user_actions', JSON.stringify(actions));
        }
        
        // Connection monitoring
        function initializeConnectionMonitoring() {
            // Online/offline detection
            window.addEventListener('online', () => {
                console.log('🌐 Connection restored');
                showConnectionStatus('online');
                
                // Sync pending data when back online
                syncPendingData();
            });
            
            window.addEventListener('offline', () => {
                console.log('📵 Connection lost');
                showConnectionStatus('offline');
            });
        }
        
        // Show connection status
        function showConnectionStatus(status) {
            const statusDiv = document.getElementById('connection-status') || createConnectionStatusDiv();
            
            if (status === 'offline') {
                statusDiv.innerHTML = `
                    <div style="background: #ff6b6b; color: white; padding: 0.5rem; text-align: center; font-size: 0.85rem;">
                        <i class="fas fa-wifi-slash"></i> You're offline. Some features may be limited.
                    </div>
                `;
                statusDiv.style.display = 'block';
            } else {
                statusDiv.innerHTML = `
                    <div style="background: #51cf66; color: white; padding: 0.5rem; text-align: center; font-size: 0.85rem;">
                        <i class="fas fa-wifi"></i> Connected. All features available.
                    </div>
                `;
                statusDiv.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Create connection status div
        function createConnectionStatusDiv() {
            const div = document.createElement('div');
            div.id = 'connection-status';
            div.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; z-index: 9999; display: none;';
            document.body.appendChild(div);
            return div;
        }
        
        // Sync pending data when online
        async function syncPendingData() {
            // Get pending errors and metrics
            const errors = JSON.parse(localStorage.getItem('app_errors') || '[]');
            const metrics = JSON.parse(localStorage.getItem('app_metrics') || '[]');
            
            // Send to server if any pending data
            if (errors.length > 0 || metrics.length > 0) {
                console.log('🔄 Syncing pending data...', { errors: errors.length, metrics: metrics.length });
                
                // In production, send to actual analytics service
                try {
                    // Simulate API calls
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Clear synced data
                    localStorage.removeItem('app_errors');
                    localStorage.removeItem('app_metrics');
                    
                    console.log('✅ Data synced successfully');
                } catch (error) {
                    console.error('❌ Failed to sync data:', error);
                }
            }
        }

        // Initialize user type on page load (moved to main DOMContentLoaded listener)
        function initializeUserType() {
            // Set default user type to passenger
            const userTypeSelect = document.getElementById('user-type');
            if (userTypeSelect) {
                selectUserType('passenger'); // This will set the value and update the UI
            }
            
            // Set up tab change events to check license status when post-ride tab is selected
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.dataset.tab === 'post-ride') {
                        checkLicenseStatus();
                    }
                });
            });
        }

        // All admin dashboard functions removed - use Supabase database for admin management

        // Dashboard stats and KPI functions removed - use Supabase for data management

        async function loadActivityFeed() {
            const activityFeed = document.getElementById('admin-activity-feed');
            if (!activityFeed) return;
            
            try {
                // Load real activity data from user_activities table
                const { data, error } = await supabase
                    .from('user_activities')
                    .select(`
                        activity_type,
                        activity_data,
                        created_at,
                        users!inner(full_name)
                    `)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                let activities = [];
                
                if (data && data.length > 0) {
                    // Convert database activities to display format
                    activities = data.map(activity => {
                        const timeDiff = getTimeAgo(activity.created_at);
                        const userName = activity.users?.full_name || 'Unknown User';
                        
                        switch (activity.activity_type) {
                            case 'user_registered':
                                return {
                                    icon: 'fas fa-user-plus',
                                    iconClass: 'success',
                                    text: `<strong>${userName}</strong> completed registration`,
                                    time: timeDiff
                                };
                            case 'ride_posted':
                                return {
                                    icon: 'fas fa-car',
                                    iconClass: 'primary',
                                    text: `<strong>${userName}</strong> posted a new ride`,
                                    time: timeDiff
                                };
                            case 'ride_booked':
                                return {
                                    icon: 'fas fa-ticket-alt',
                                    iconClass: 'warning',
                                    text: `<strong>${userName}</strong> booked a ride`,
                                    time: timeDiff
                                };
                            case 'license_uploaded':
                                return {
                                    icon: 'fas fa-id-card',
                                    iconClass: 'info',
                                    text: `<strong>${userName}</strong> uploaded license for verification`,
                                    time: timeDiff
                                };
                            case 'profile_updated':
                                return {
                                    icon: 'fas fa-user-edit',
                                    iconClass: 'secondary',
                                    text: `<strong>${userName}</strong> updated their profile`,
                                    time: timeDiff
                                };
                            default:
                                return {
                                    icon: 'fas fa-bell',
                                    iconClass: 'info',
                                    text: `<strong>${userName}</strong> performed ${activity.activity_type}`,
                                    time: timeDiff
                                };
                        }
                    });
                } else {
                    // Show message if no activities found
                    activities = [{
                        icon: 'fas fa-info-circle',
                        iconClass: 'info',
                        text: 'No recent activities found',
                        time: 'Just now'
                    }];
                }
                
                activityFeed.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.iconClass}">
                            <i class="${activity.icon}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.text}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading activity feed:', error);
                // Fallback to a simple message if database query fails
                activityFeed.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">Unable to load activity feed</div>
                            <div class="activity-time">Error: ${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Helper function to calculate time ago
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInMinutes < 1) return 'Just now';
            if (diffInMinutes < 60) return `${diffInMinutes} minute${diffInMinutes > 1 ? 's' : ''} ago`;
            if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
            if (diffInDays < 30) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            return date.toLocaleDateString();
        }

        async function loadUsersData() {
            const usersTableBody = document.getElementById('users-table-body');
            if (!usersTableBody) return;

            try {
                // Load real users from database
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Check localStorage for admin overrides to determine user status
                const overrides = JSON.parse(localStorage.getItem(ADMIN_OVERRIDE_KEY) || '{}');
                const priceOverrides = JSON.parse(localStorage.getItem(ADMIN_PRICE_OVERRIDE_KEY) || '{}');
                
                const users = data.map(user => ({
                    name: user.full_name || 'Unknown User',
                    email: user.email,
                    role: user.user_type || 'Unknown',
                    status: user.is_active ? 'Active' : 'Inactive',
                    joined: new Date(user.created_at).toLocaleDateString(),
                    rides: 0, // TODO: Calculate from rides table
                    rating: user.average_rating || 0,
                    dailyLimit: overrides[user.email] ? 'Hidden Override (∞)' : 'Standard (2)',
                    priceLimit: priceOverrides[user.email] ? 'No Constraints' : 'Standard (0.15-0.25/km)',
                    hasOverride: overrides[user.email] || false,
                    hasPriceOverride: priceOverrides[user.email] || false
                }));

                if (users.length === 0) {
                    usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #718096;">No users found</td></tr>';
                    return;
                }

                usersTableBody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                ${user.name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div>
                                <div style="font-weight: 600; color: #2d3748;">${user.name}</div>
                                <div style="font-size: 0.8rem; color: #718096;">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge badge-${user.role.toLowerCase()}">${user.role}</span>
                    </td>
                    <td>
                        <span class="status-badge ${user.status.toLowerCase()}">${user.status}</span>
                    </td>
                    <td>${new Date(user.joined).toLocaleDateString()}</td>
                    <td>${user.rides}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.25rem;">
                            <span>${user.rating}</span>
                            <i class="fas fa-star" style="color: #fbbf24; font-size: 0.8rem;"></i>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: ${user.hasOverride ? '#22c55e' : 'var(--text-color)'}; font-weight: ${user.hasOverride ? '600' : '400'};">
                                ${user.dailyLimit}
                            </span>
                            ${user.role.includes('Driver') ? `
                                <button class="btn-icon ${user.hasOverride ? 'success' : ''}" onclick="toggleDailyLimitOverride('${user.email}', ${!user.hasOverride})" title="${user.hasOverride ? 'Remove Hidden Override' : 'Grant Hidden Override'}">
                                    <i class="fas fa-${user.hasOverride ? 'eye-slash' : 'user-secret'}"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: ${user.hasPriceOverride ? '#22c55e' : 'var(--text-color)'}; font-weight: ${user.hasPriceOverride ? '600' : '400'};">
                                ${user.priceLimit}
                            </span>
                            ${user.role.includes('Driver') ? `
                                <button class="btn-icon ${user.hasPriceOverride ? 'success' : ''}" onclick="togglePriceConstraintOverride('${user.email}', ${!user.hasPriceOverride})" title="${user.hasPriceOverride ? 'Remove Price Override' : 'Grant Price Override'}">
                                    <i class="fas fa-${user.hasPriceOverride ? 'eye-slash' : 'dollar-sign'}"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-icon" onclick="editUser('${user.email}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon" onclick="viewUser('${user.email}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-icon danger" onclick="suspendUser('${user.email}')">
                                <i class="fas fa-ban"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            } catch (error) {
                console.error('Error loading users:', error);
                usersTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error loading users</td></tr>';
            }
        }

        // Placeholder functions for other tabs
        function loadAnalyticsData() { console.log('Loading analytics data...'); }
        async function loadPaymentsData() {
            console.log('Loading payments data...');
            // TODO: Implement real payments data loading
        }
        function loadSafetyData() { console.log('Loading safety data...'); }
        function loadSupportData() { console.log('Loading support data...'); }
        function loadSettingsData() { console.log('Loading settings data...'); }

        // Utility functions
        function toggleSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const main = document.querySelector('.admin-main');
            const overlay = document.querySelector('.sidebar-overlay');
            
            // Check if we're on mobile (sidebar has position: fixed)
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                const isOpen = sidebar.classList.toggle('open');
                if (overlay) {
                    overlay.classList.toggle('active', isOpen);
                }
            } else {
                // Desktop behavior - collapse/expand sidebar
                sidebar.classList.toggle('collapsed');
                main.classList.toggle('expanded');
            }
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.admin-sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            const main = document.querySelector('.admin-main');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sidebar.classList.remove('open');
                if (overlay) {
                    overlay.classList.remove('active');
                }
            } else {
                sidebar.classList.add('collapsed');
                main.classList.add('expanded');
            }
        }

        function searchUsers() {
            const query = document.getElementById('user-search').value.toLowerCase();
            // Implement user search functionality
            console.log('Searching users:', query);
        }

        function filterUsers(filter) {
            // Remove active class from all filter buttons
            document.querySelectorAll('.filters-bar .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            event.target.classList.add('active');
            console.log('Filtering users:', filter);
        }

        function filterLicenses(filter) {
            // Remove active class from all filter buttons
            document.querySelectorAll('.filters-bar .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            event.target.classList.add('active');
            console.log('Filtering licenses:', filter);
        }

        // Action functions
        function exportData(type) {
            console.log('Exporting data:', type);
            alert(`Exporting ${type} data...`);
        }

        function showSystemHealth() {
            console.log('Showing system health...');
            alert('System Health: All systems operational');
        }

        // Validate ride posting limits
        async function validateRidePosting(rideDate, rideTime) {
            try {
                // Check if admin has overridden limits for this user (hidden from driver)
                const hasAdminOverride = await checkAdminOverride(currentUser?.id);
                if (hasAdminOverride) {
                    return { allowed: true, message: 'Validation passed' };
                }

                // Check daily ride count for the specified date
                const dailyRideCount = await getDailyRideCount(currentUser?.id, rideDate);
                
                if (dailyRideCount >= DAILY_RIDE_LIMIT) {
                    return {
                        allowed: false,
                        message: `Daily limit exceeded! You can only post ${DAILY_RIDE_LIMIT} trips per day. You have already posted ${dailyRideCount} trip(s) for ${rideDate}.`
                    };
                }

                // Check for time conflicts with existing rides on the same date
                const hasTimeConflict = await checkTimeConflict(currentUser?.id, rideDate, rideTime);
                
                if (hasTimeConflict) {
                    return {
                        allowed: false,
                        message: `Time conflict detected! You already have a ride scheduled at ${rideTime} on ${rideDate}. Please choose a different time.`
                    };
                }

                return { allowed: true, message: 'Validation passed' };
            } catch (error) {
                console.error('Error validating ride posting:', error);
                return { allowed: false, message: 'Error checking ride limits. Please try again.' };
            }
        }

        // Check if user has admin override for daily limits (hidden implementation)
        async function checkAdminOverride(userId) {
            try {
                const { data: limits, error } = await supabase
                    .from('daily_ride_limits')
                    .select('admin_override')
                    .eq('user_id', userId)
                    .single();
                
                if (error) {
                    // If no record exists, user has no override
                    return false;
                }
                
                return limits.admin_override === true;
            } catch (error) {
                console.error('Error checking admin override:', error);
                return false;
            }
        }
        
        // Check if user has admin override for price constraints (hidden implementation)
        async function checkPriceOverride(userId) {
            try {
                const { data: limits, error } = await supabase
                    .from('daily_ride_limits')
                    .select('price_override')
                    .eq('user_id', userId)
                    .single();
                
                if (error) {
                    // If no record exists, user has no price override
                    return false;
                }
                
                return limits.price_override === true;
            } catch (error) {
                console.error('Error checking price override:', error);
                return false;
            }
        }

        // Get count of rides posted by user on a specific date
        async function getDailyRideCount(userId, date) {
            try {
                const { data: rides, error } = await supabase
                    .from('rides')
                    .select('id')
                    .eq('driver_id', userId)
                    .gte('departure_time', date + ' 00:00:00')
                    .lt('departure_time', date + ' 23:59:59');
                
                if (error) {
                    console.error('Error fetching daily ride count:', error);
                    return 0;
                }
                
                return rides.length;
            } catch (error) {
                console.error('Error in getDailyRideCount:', error);
                return 0;
            }
        }

        // Check for time conflicts on the same date
        async function checkTimeConflict(userId, date, time) {
            try {
                const dateTimeString = `${date} ${time}:00`;
                
                const { data: rides, error } = await supabase
                    .from('rides')
                    .select('departure_time')
                    .eq('driver_id', userId)
                    .eq('departure_time', dateTimeString);
                
                if (error) {
                    console.error('Error checking time conflict:', error);
                    return false;
                }
                
                return rides.length > 0;
            } catch (error) {
                console.error('Error in checkTimeConflict:', error);
                return false;
            }
        }

        // Validate future date constraints
        function validateFutureDate() {
            const dateInput = document.getElementById('post-date');
            const selectedDate = new Date(dateInput.value);
            const today = new Date();
            const maxDate = new Date();
            
            // Set times to start of day for accurate comparison
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);
            maxDate.setDate(maxDate.getDate() + MAX_ADVANCE_DAYS);
            maxDate.setHours(0, 0, 0, 0);
            
            const dateInfo = document.getElementById('date-limit-info');
            
            if (selectedDate < today) {
                dateInfo.textContent = 'Cannot select past dates';
                dateInfo.style.color = '#ef4444';
                dateInput.value = '';
                return false;
            } else if (selectedDate > maxDate) {
                dateInfo.textContent = `Maximum ${MAX_ADVANCE_DAYS} days in advance`;
                dateInfo.style.color = '#ef4444';
                dateInput.value = '';
                return false;
            } else {
                dateInfo.textContent = `Maximum ${MAX_ADVANCE_DAYS} days in advance`;
                dateInfo.style.color = 'var(--text-color)';
                return true;
            }
        }

        // Set date input constraints on page load
        function initializeDateConstraints() {
            const dateInput = document.getElementById('post-date');
            if (dateInput) {
                const today = new Date();
                const maxDate = new Date();
                maxDate.setDate(maxDate.getDate() + MAX_ADVANCE_DAYS);
                
                // Set min and max attributes
                dateInput.min = today.toISOString().split('T')[0];
                dateInput.max = maxDate.toISOString().split('T')[0];
            }
        }

        // Admin functions to manage ride limits
        async function setAdminOverride(userId, override = true) {
            // In a real app, this would update the database
            console.log(`Setting admin override for user ${userId}: ${override}`);
            
            // Store in localStorage for demo purposes
            const overrides = JSON.parse(localStorage.getItem(ADMIN_OVERRIDE_KEY) || '{}');
            if (override) {
                overrides[userId] = true;
            } else {
                delete overrides[userId];
            }
            localStorage.setItem(ADMIN_OVERRIDE_KEY, JSON.stringify(overrides));
            
            return true;
        }

        // Admin function to toggle daily limit override (hidden from drivers)
        async function toggleDailyLimitOverride(userEmail, enableOverride) {
            const action = enableOverride ? 'grant' : 'remove';
            const message = enableOverride 
                ? `Grant unlimited daily ride posting to ${userEmail}?\n\nNote: This permission will be HIDDEN from the driver. They will not see any indication that their limits have been overridden.` 
                : `Remove daily limit override for ${userEmail}? They will return to the standard 2 rides per day limit.\n\nNote: The driver will not be notified of this change.`;
                
            if (confirm(message)) {
                try {
                    // In a real app, this would call the API to update user permissions
                    // Update localStorage to simulate the override (using email as userId for demo)
                    const overrides = JSON.parse(localStorage.getItem(ADMIN_OVERRIDE_KEY) || '{}');
                    if (enableOverride) {
                        overrides[userEmail] = true;
                    } else {
                        delete overrides[userEmail];
                    }
                    localStorage.setItem(ADMIN_OVERRIDE_KEY, JSON.stringify(overrides));
                    
                    console.log(`${action} override for user:`, userEmail);
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    alert(`Daily limit override ${enableOverride ? 'granted' : 'removed'} for ${userEmail}\n\n${enableOverride ? '✅ Driver can now post unlimited rides per day (hidden from driver)' : '❌ Driver returned to standard 2 rides per day limit'}`);
                    
                    // Refresh the users table
                    loadUsersData();
                } catch (error) {
                    console.error('Error updating daily limit override:', error);
                    alert('Failed to update daily limit override. Please try again.');
                }
            }
        }
        
        // Admin function to toggle price constraint override (hidden from drivers)
        async function togglePriceConstraintOverride(userEmail, enableOverride) {
            const action = enableOverride ? 'grant' : 'remove';
            const message = enableOverride 
                ? `Grant price constraint override to ${userEmail}?\n\nThis will allow the driver to set prices outside the platform's standard limits ($0.15-$0.25 per km).\n\nNote: This permission will be HIDDEN from the driver.` 
                : `Remove price constraint override for ${userEmail}? They will return to the standard price limits.\n\nNote: The driver will not be notified of this change.`;
                
            if (confirm(message)) {
                try {
                    // In a real app, this would call the API to update user permissions
                    // Update localStorage to simulate the override (using email as userId for demo)
                    const overrides = JSON.parse(localStorage.getItem(ADMIN_PRICE_OVERRIDE_KEY) || '{}');
                    if (enableOverride) {
                        overrides[userEmail] = true;
                    } else {
                        delete overrides[userEmail];
                    }
                    localStorage.setItem(ADMIN_PRICE_OVERRIDE_KEY, JSON.stringify(overrides));
                    
                    console.log(`${action} price override for user:`, userEmail);
                    
                    // Simulate API call
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    alert(`Price constraint override ${enableOverride ? 'granted' : 'removed'} for ${userEmail}\n\n${enableOverride ? '✅ Driver can now set prices outside platform limits (hidden from driver)' : '❌ Driver returned to standard price constraints'}`);
                    
                    // Refresh the users table
                    loadUsersData();
                } catch (error) {
                    console.error('Error updating price constraint override:', error);
                    alert('Failed to update price constraint override. Please try again.');
                }
            }
        }

        function editUser(email) { console.log('Editing user:', email); }
        function viewUser(email) { console.log('Viewing user:', email); }
        function suspendUser(email) { console.log('Suspending user:', email); }
        function approveVerification(email) { console.log('Approving verification:', email); }
        function rejectVerification(email) { console.log('Rejecting verification:', email); }
        function viewLicense(email) { console.log('Viewing license:', email); }

        async function loadRidesData() {
            const ridesTableBody = document.getElementById('rides-table-body');
            if (!ridesTableBody) return;
            
            try {
                // Load real rides data from database using proper Supabase query
                const { data, error } = await supabase
                    .from('rides')
                    .select(`
                        id,
                        origin_address,
                        destination_address,
                        departure_date,
                        departure_time,
                        available_seats,
                        total_price_per_seat,
                        service_fee,
                        users!inner(full_name)
                    `)
                    .order('departure_date', { ascending: false })
                    .order('departure_time', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    ridesTableBody.innerHTML = data.map(ride => {
                        const route = `${ride.origin_address || 'Unknown'} → ${ride.destination_address || 'Unknown'}`;
                        const departureDate = new Date(ride.departure_date).toLocaleDateString();
                        // Calculate price with proper error handling
                        let priceValue = ride.total_price_per_seat;
                        if (!priceValue || priceValue === 0 || priceValue === 'undefined') {
                            const basePrice = parseFloat(ride.price_per_seat) || 0;
                            priceValue = basePrice * 1.12;
                        }
                        const price = `$${(parseFloat(priceValue) || 0).toFixed(2)}`;
                        const passengers = `0/${ride.available_seats || 0}`; // Simplified for now
                        const status = getRideStatus(ride.departure_date, 0, ride.available_seats);
                        
                        return `
                            <tr>
                                <td style="font-weight: 500; max-width: 200px; word-wrap: break-word;">${route}</td>
                                <td>${ride.users?.full_name || 'Unknown Driver'}</td>
                                <td>${departureDate}</td>
                                <td style="font-weight: 600; color: var(--admin-primary);">${price}</td>
                                <td>${passengers}</td>
                                <td><span class="status ${status.toLowerCase()}" style="color: ${status === 'Active' ? '#22c55e' : status === 'Completed' ? '#3b82f6' : '#ef4444'}; font-weight: 500;">${status}</span></td>
                                <td>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn btn-sm" onclick="viewRide('${ride.id}')" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.25rem 0.5rem; font-size: 0.8rem;">View</button>
                                        ${status === 'Active' ? `
                                            <button class="btn btn-sm" onclick="cancelRide('${ride.id}')" style="background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; padding: 0.25rem 0.5rem; font-size: 0.8rem;">Cancel</button>
                                        ` : ''}
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    ridesTableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center" style="padding: 2rem;">
                                <i class="fas fa-car" style="font-size: 2rem; color: #ccc; margin-bottom: 1rem;"></i>
                                <div>No rides found in the database</div>
                            </td>
                        </tr>
                    `;
                }
                
            } catch (error) {
                console.error('Error loading rides data:', error);
                ridesTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc3545; margin-bottom: 1rem;"></i>
                            <div>Error loading rides: ${error.message}</div>
                        </td>
                    </tr>
                `;
            }
        }
        
        function getRideStatus(departureDate, bookedSeats, availableSeats) {
            const today = new Date();
            const departure = new Date(departureDate);
            
            if (departure < today) {
                return 'Completed';
            } else if (bookedSeats >= availableSeats) {
                return 'Full';
            } else {
                return 'Active';
            }
        }

        function loadLicenseVerifications() {
            const licenseGrid = document.getElementById('license-grid');
            if (!licenseGrid) return;
            
            // Get the active filter
            const activeFilter = document.querySelector('.admin-filters .filter-btn.active');
            const filterValue = activeFilter ? activeFilter.getAttribute('data-filter') : 'pending';
            
            // Show loading state
            licenseGrid.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--admin-primary);"></i><p style="margin-top: 1rem;">Loading license verifications...</p></div>';
            
            // Query Supabase for license verifications
            async function fetchLicenseVerifications() {
                try {
                    // Convert filter value to database value
                    let statusFilter = filterValue;
                    if (filterValue === 'approved') statusFilter = 'verified';
                    if (filterValue === 'all') statusFilter = null;
                    
                    // Build query with proper Supabase syntax
                    let queryBuilder = supabase
                        .from('license_verifications')
                        .select(`
                            id,
                            verification_status,
                            submitted_at,
                            reviewed_at,
                            license_number,
                            license_document_url,
                            users!inner(full_name, email)
                        `)
                        .order('submitted_at', { ascending: false })
                        .limit(20);
                    
                    // Add filter if not 'all'
                    if (statusFilter && statusFilter !== 'all') {
                        queryBuilder = queryBuilder.ilike('verification_status', statusFilter);
                    }
                    
                    const { data, error } = await queryBuilder;
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        // Format the data for display
                        const formattedData = data.map(item => {
                            return {
                                id: item.id,
                                name: item.users?.full_name || 'Unknown User',
                                email: item.users?.email || 'No email',
                                submitted: formatDate(item.submitted_at),
                                status: getStatusLabel(item.verification_status),
                                licenseNumber: item.license_number || 'Not provided',
                                docs: getDocs(item.license_document_url),
                                documentUrl: item.license_document_url
                            };
                        });
                        
                        renderLicenseVerifications(formattedData);
                    } else {
                        licenseGrid.innerHTML = `<div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-info-circle" style="font-size: 2rem; color: var(--admin-primary);"></i>
                            <p style="margin-top: 1rem;">No ${filterValue} license verifications found.</p>
                        </div>`;
                    }
                } catch (error) {
                    console.error('Error fetching license verifications:', error);
                    licenseGrid.innerHTML = `<div style="text-align: center; padding: 2rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--error-color);"></i>
                        <p style="margin-top: 1rem;">Error loading license verifications. Please try again.</p>
                        <p style="color: var(--error-color);">${error.message}</p>
                    </div>`;
                }
            }
            
            // Helper functions
            function formatDate(dateString) {
                if (!dateString) return 'Unknown date';
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }
            
            function getStatusLabel(status) {
                if (!status) return 'pending';
                status = status.toLowerCase();
                if (status === 'verified') return 'approved';
                if (status === 'submitted') return 'pending';
                return status;
            }
            
            function getDocs(url) {
                if (!url) return 'No documents';
                const filename = url.split('/').pop();
                return filename || 'license_document.jpg';
            }
            
            // Render the license verifications
            function renderLicenseVerifications(verifications) {
                licenseGrid.innerHTML = verifications.map(verification => `
                    <div class="license-card ${verification.status}">
                        <div class="license-header">
                            <div>
                                <h4 style="margin: 0; color: #2d3748;">${verification.name}</h4>
                                <p style="margin: 0.25rem 0 0 0; color: #666; font-size: 0.9rem;">${verification.email}</p>
                            </div>
                            <span class="license-status ${verification.status}">${verification.status.charAt(0).toUpperCase() + verification.status.slice(1)}</span>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">License Number: <strong>${verification.licenseNumber}</strong></div>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 0.5rem;">Submitted: ${verification.submitted}</div>
                            <div style="font-size: 0.9rem; color: #666;">Documents: ${verification.docs}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${verification.status === 'pending' ? `
                                <button class="btn btn-sm" onclick="approveLicense('${verification.id}')" style="background: #22c55e; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">Approve</button>
                                <button class="btn btn-sm" onclick="rejectLicense('${verification.id}')" style="background: #ef4444; color: white; padding: 0.5rem 1rem; font-size: 0.8rem;">Reject</button>
                            ` : ''}
                            <button class="btn btn-sm" onclick="viewLicenseDocuments('${verification.documentUrl}')" style="background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; padding: 0.5rem 1rem; font-size: 0.8rem;">View Docs</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Execute the fetch
            fetchLicenseVerifications();
        }

        function loadRevenueData() {
            const revenueTableBody = document.getElementById('revenue-table-body');
            const transactions = [
                { date: '2024-01-25', rideId: 'R-1001', driver: 'Sarah Johnson', passenger: 'Emma Wilson', baseAmount: '$40.00', serviceFee: '$4.80', total: '$44.80' },
                { date: '2024-01-25', rideId: 'R-1002', driver: 'Michael Chen', passenger: 'David Lee', baseAmount: '$75.00', serviceFee: '$9.00', total: '$84.00' },
                { date: '2024-01-24', rideId: 'R-1003', driver: 'David Rodriguez', passenger: 'Lisa Park', baseAmount: '$32.00', serviceFee: '$3.84', total: '$35.84' },
                { date: '2024-01-24', rideId: 'R-1004', driver: 'Sarah Johnson', passenger: 'Mike Johnson', baseAmount: '$22.00', serviceFee: '$2.64', total: '$24.64' },
                { date: '2024-01-23', rideId: 'R-1005', driver: 'Lisa Thompson', passenger: 'Anna Smith', baseAmount: '$55.00', serviceFee: '$6.60', total: '$61.60' }
            ];

            revenueTableBody.innerHTML = transactions.map(transaction => `
                <tr>
                    <td>${transaction.date}</td>
                    <td style="font-family: monospace; color: var(--admin-primary); font-weight: 500;">${transaction.rideId}</td>
                    <td>${transaction.driver}</td>
                    <td>${transaction.passenger}</td>
                    <td style="font-weight: 500;">${transaction.baseAmount}</td>
                    <td style="font-weight: 600; color: var(--admin-primary);">${transaction.serviceFee}</td>
                    <td style="font-weight: 600;">${transaction.total}</td>
                </tr>
            `).join('');
        }

        // Admin Action Functions
        function filterUsers(filter) {
            // Update filter button states
            document.querySelectorAll('.admin-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Re-load users data with filter
            loadUsersData();
        }

        function filterRides(filter) {
            // Update filter button states
            document.querySelectorAll('.admin-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Re-load rides data with filter
            loadRidesData();
        }

        function filterLicenses(filter) {
            // Update filter button states
            document.querySelectorAll('.admin-filters .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            // Re-load license data with filter - now this will actually use the filter
            loadLicenseVerifications();
            
            // Track filter usage for analytics
            console.log(`License filter applied: ${filter}`);
        }

        function searchUsers() {
            const searchElement = document.getElementById('user-search');
            if (!searchElement) {
                console.warn('user-search element not found');
                return;
            }
            const searchTerm = searchElement.value.toLowerCase();
            // In real implementation, this would filter the table rows
            console.log('Searching users for:', searchTerm);
        }

        function searchAdminRides() {
            const searchElement = document.getElementById('ride-search');
            if (!searchElement) {
                console.warn('ride-search element not found');
                return;
            }
            const searchTerm = searchElement.value.toLowerCase();
            // In real implementation, this would filter the table rows
            console.log('Searching rides for:', searchTerm);
        }

        function viewUser(email) {
            alert(`Viewing user details for: ${email}`);
        }

        function suspendUser(email) {
            if (confirm(`Are you sure you want to suspend user: ${email}?`)) {
                alert(`User ${email} has been suspended`);
                loadUsersData(); // Refresh the table
            }
        }

        function viewRide(rideId) {
            alert(`Viewing ride details for ride ID: ${rideId}`);
            // TODO: Implement detailed ride view modal
        }

        async function cancelRide(rideId) {
            if (confirm(`Are you sure you want to cancel this ride?`)) {
                try {
                    // Update ride status in database using proper Supabase syntax
                    const { error } = await supabase
                        .from('rides')
                        .update({ status: 'cancelled' })
                        .eq('id', rideId);
                    
                    if (error) throw error;
                    
                    alert('Ride has been cancelled successfully');
                    loadRidesData(); // Refresh the table
                } catch (error) {
                    console.error('Error cancelling ride:', error);
                    alert(`Error cancelling ride: ${error.message}`);
                }
            }
        }

        async function approveLicense(id) {
            if (confirm(`Approve this license verification?`)) {
                try {
                    // Get current user ID for admin tracking
                    const { data: { user } } = await supabase.auth.getUser();
                    const adminId = user?.id;
                    
                    if (!adminId) {
                        alert('You must be logged in as an admin to approve licenses');
                        return;
                    }
                    
                    // Update the license verification status in the database
                    const { error } = await supabase
                        .from('license_verifications')
                        .update({ 
                            verification_status: 'verified', 
                            verified_by: adminId,
                            reviewed_at: new Date().toISOString()
                        })
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    // Get the user ID from license verification to update user record
                    const { data: licenseData, error: licenseError } = await supabase
                        .from('license_verifications')
                        .select('user_id, users!inner(email)')
                        .eq('id', id)
                        .single();
                    
                    if (licenseError) throw licenseError;
                    
                    // Update the user's license_verified status
                    const { error: userError } = await supabase
                        .from('users')
                        .update({ license_verified: true })
                        .eq('id', licenseData.user_id);
                    
                    if (userError) throw userError;
                    
                    const email = licenseData.users?.email || 'the user';
                    
                    alert(`License verification approved for ${email}`);
                    loadLicenseVerifications(); // Refresh the grid
                    
                } catch (error) {
                    console.error('Error approving license:', error);
                    alert(`Error approving license verification: ${error.message}`);
                }
            }
        }

        async function rejectLicense(id) {
            const reason = prompt('Please provide a reason for rejecting this license verification:');
            if (!reason) return; // User cancelled
            
            try {
                // Get current user ID for admin tracking
                const { data: { user } } = await supabase.auth.getUser();
                const adminId = user?.id;
                
                if (!adminId) {
                    alert('You must be logged in as an admin to reject licenses');
                    return;
                }
                
                // Update the license verification status in the database
                const { error } = await supabase
                    .from('license_verifications')
                    .update({ 
                        verification_status: 'rejected', 
                        verified_by: adminId,
                        reviewed_at: new Date().toISOString(),
                        admin_notes: reason
                    })
                    .eq('id', id);
                
                if (error) throw error;
                
                // Get the user's email for confirmation message
                const { data: userData, error: userError } = await supabase
                    .from('license_verifications')
                    .select('users!inner(email)')
                    .eq('id', id)
                    .single();
                
                if (userError) throw userError;
                
                const email = userData?.users?.email || 'the user';
                
                alert(`License verification rejected for ${email}`);
                loadLicenseVerifications(); // Refresh the grid
                
            } catch (error) {
                console.error('Error rejecting license:', error);
                alert(`Error rejecting license verification: ${error.message}`);
            }
        }

        function viewLicenseDocuments(documentUrl) {
            if (!documentUrl) {
                alert('No document URL available');
                return;
            }
            
            // Create a modal to display the license document
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            modal.style.zIndex = '1000';
            modal.style.display = 'flex';
            modal.style.flexDirection = 'column';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.padding = '20px';
            
            const content = document.createElement('div');
            content.style.backgroundColor = 'white';
            content.style.borderRadius = '8px';
            content.style.width = '90%';
            content.style.maxWidth = '800px';
            content.style.maxHeight = '90vh';
            content.style.overflow = 'auto';
            content.style.position = 'relative';
            content.style.padding = '20px';
            
            const closeButton = document.createElement('button');
            closeButton.innerHTML = '&times;';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.border = 'none';
            closeButton.style.background = 'none';
            closeButton.style.fontSize = '24px';
            closeButton.style.cursor = 'pointer';
            closeButton.style.color = '#333';
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            const heading = document.createElement('h3');
            heading.textContent = 'License Document';
            heading.style.marginBottom = '20px';
            
            const image = document.createElement('img');
            image.src = documentUrl;
            image.style.maxWidth = '100%';
            image.style.height = 'auto';
            image.style.display = 'block';
            image.style.marginBottom = '20px';
            image.style.boxShadow = '0 2px 5px rgba(0, 0, 0, 0.1)';
            
            // Add download link
            const downloadLink = document.createElement('a');
            downloadLink.href = documentUrl;
            downloadLink.target = '_blank';
            downloadLink.textContent = 'Download Original Document';
            downloadLink.style.display = 'inline-block';
            downloadLink.style.padding = '8px 16px';
            downloadLink.style.backgroundColor = '#4CAF50';
            downloadLink.style.color = 'white';
            downloadLink.style.textDecoration = 'none';
            downloadLink.style.borderRadius = '4px';
            
            content.appendChild(closeButton);
            content.appendChild(heading);
            content.appendChild(image);
            content.appendChild(downloadLink);
            modal.appendChild(content);
            
            document.body.appendChild(modal);
        }

        function exportData(type) {
            alert(`Exporting ${type} data to CSV...`);
        }

        function updateRevenuePeriod() {
            const period = document.getElementById('revenue-period').value;
            alert(`Updating revenue data for period: ${period}`);
            loadRevenueData();
        }

        function generateReport(type) {
            alert(`Generating ${type} report...`);
        }

        function showSystemHealth() {
            alert('System Health: All services operational\n• Database: ✓ Online\n• Payment Processing: ✓ Online\n• Notification Service: ✓ Online\n• File Storage: ✓ Online');
        }
        
        // Initialize push notifications
        async function initializePushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    // Register service worker
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker registered successfully');
                    
                    // Request notification permission
                    if (Notification.permission === 'default') {
                        const permission = await Notification.requestPermission();
                        console.log('Notification permission:', permission);
                    }
                    
                    // Subscribe to push notifications if permission granted
                    if (Notification.permission === 'granted') {
                        await subscribeToPush(registration);
                    }
                } catch (error) {
                    console.error('Failed to initialize push notifications:', error);
                }
            }
        }
        
        // Subscribe to push notifications
        async function subscribeToPush(registration) {
            try {
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true
                });
                
                // Send subscription to server (Supabase)
                await saveSubscriptionToDatabase(subscription);
                console.log('Push subscription successful');
            } catch (error) {
                console.log('Failed to subscribe to push notifications:', error);
            }
        }
        
        // AI System Initialization and Functions
        async function initializeAISystem() {
            try {
                console.log('🤖 Initializing AI System with TensorFlow.js...');
                
                // Load user preferences from localStorage
                loadUserPreferences();
                
                // Initialize simple neural network for ride matching
                aiModel = createRideMatchingModel();
                
                console.log('✅ AI System initialized successfully');
                
                // Show AI ready indicator
                setTimeout(() => {
                    showAIReadyIndicator();
                }, 1000);
                
            } catch (error) {
                console.error('❌ AI System initialization failed:', error);
            }
        }
        
        // Create simple neural network for ride matching
        function createRideMatchingModel() {
            const model = tf.sequential({
                layers: [
                    tf.layers.dense({
                        inputShape: [6], // [distance, price_diff, time_diff, user_rating, route_popularity, historical_preference]
                        units: 32,
                        activation: 'relu'
                    }),
                    tf.layers.dense({
                        units: 16,
                        activation: 'relu'
                    }),
                    tf.layers.dense({
                        units: 8,
                        activation: 'relu'
                    }),
                    tf.layers.dense({
                        units: 1,
                        activation: 'sigmoid' // Output match score 0-1
                    })
                ]
            });
            
            model.compile({
                optimizer: 'adam',
                loss: 'binaryCrossentropy',
                metrics: ['accuracy']
            });
            
            return model;
        }
        
        // Load user preferences from storage
        function loadUserPreferences() {
            const saved = localStorage.getItem('ai_user_preferences');
            if (saved) {
                userPreferences = JSON.parse(saved);
            } else {
                userPreferences = {
                    maxPrice: 50,
                    preferredTimeRange: 30, // minutes flexibility
                    maxDistance: 25, // km
                    priceWeight: 0.3,
                    timeWeight: 0.4,
                    distanceWeight: 0.3,
                    favoriteRoutes: [],
                    preferredDriverRating: 4.0
                };
            }
            rideHistory = JSON.parse(localStorage.getItem('ai_ride_history') || '[]');
        }
        
        // Save user preferences
        function saveUserPreferences() {
            localStorage.setItem('ai_user_preferences', JSON.stringify(userPreferences));
            localStorage.setItem('ai_ride_history', JSON.stringify(rideHistory));
        }
        
        // AI-powered ride matching
        async function getIntelligentRideRecommendations(searchParams, availableRides) {
            if (!aiModel || !availableRides.length) return availableRides;
            
            try {
                console.log('🧠 Running AI analysis for ride recommendations...');
                
                const scoredRides = await Promise.all(availableRides.map(async (ride) => {
                    const score = await calculateAIMatchScore(ride, searchParams);
                    return { ...ride, aiScore: score, aiRecommended: score > AI_CONFIG.MATCHING_THRESHOLD };
                }));
                
                // Sort by AI score (highest first)
                const sortedRides = scoredRides.sort((a, b) => b.aiScore - a.aiScore);
                
                // Update ride history for learning
                updateRideHistory(searchParams, sortedRides);
                
                console.log(`✨ AI ranked ${sortedRides.length} rides, ${sortedRides.filter(r => r.aiRecommended).length} highly recommended`);
                
                return sortedRides;
                
            } catch (error) {
                console.error('AI matching error:', error);
                return availableRides; // Fallback to original list
            }
        }
        
        // Calculate AI match score for a ride
        async function calculateAIMatchScore(ride, searchParams) {
            try {
                // Prepare input features
                const features = [
                    normalizeDistance(ride.distance || 0),
                    normalizePriceDifference(ride.price_per_seat, userPreferences.maxPrice),
                    normalizeTimeDifference(ride.departure_time, searchParams.departure_time),
                    normalizeRating(ride.driver_rating || 4.0),
                    normalizeRoutePopularity(ride.departure_address, ride.destination_address),
                    normalizeHistoricalPreference(ride)
                ];
                
                // Run prediction
                const inputTensor = tf.tensor2d([features]);
                const prediction = aiModel.predict(inputTensor);
                const score = await prediction.data();
                
                // Cleanup tensors
                inputTensor.dispose();
                prediction.dispose();
                
                return score[0];
                
            } catch (error) {
                console.error('Error calculating AI score:', error);
                return 0.5; // Default neutral score
            }
        }
        
        // Normalization functions
        function normalizeDistance(distance) {
            return Math.min(distance / userPreferences.maxDistance, 1);
        }
        
        function normalizePriceDifference(ridePrice, maxPrice) {
            return 1 - Math.min(ridePrice / maxPrice, 1);
        }
        
        function normalizeTimeDifference(rideTime, preferredTime) {
            const timeDiff = Math.abs(new Date(rideTime) - new Date(preferredTime)) / (1000 * 60);
            return Math.max(0, 1 - (timeDiff / userPreferences.preferredTimeRange));
        }
        
        function normalizeRating(rating) {
            return Math.max(0, (rating - 3) / 2); // Scale 3-5 to 0-1
        }
        
        function normalizeRoutePopularity(from, to) {
            const route = `${from}-${to}`;
            const popularity = userPreferences.favoriteRoutes.filter(r => r.includes(from) || r.includes(to)).length;
            return Math.min(popularity / 5, 1);
        }
        
        function normalizeHistoricalPreference(ride) {
            const similarRides = rideHistory.filter(h => 
                h.from.includes(ride.departure_address.split(',')[0]) || 
                h.to.includes(ride.destination_address.split(',')[0])
            ).length;
            return Math.min(similarRides / 10, 1);
        }
        
        // Update ride history for learning
        function updateRideHistory(searchParams, results) {
            const entry = {
                timestamp: new Date().toISOString(),
                from: searchParams.from,
                to: searchParams.to,
                selectedRide: null, // Will be updated when user books
                searchResults: results.length,
                topRecommendations: results.slice(0, 3).map(r => r.id)
            };
            
            rideHistory.push(entry);
            
            // Keep only last 100 searches
            if (rideHistory.length > 100) {
                rideHistory = rideHistory.slice(-100);
            }
            
            saveUserPreferences();
        }
        
        // Show AI ready indicator
        function showAIReadyIndicator() {
            const indicator = document.createElement('div');
            indicator.innerHTML = `
                <div style="position: fixed; top: 70px; right: 10px; background: linear-gradient(135deg, #6C63FF, #4FD1C5); color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; z-index: 1000; box-shadow: 0 4px 15px rgba(108, 99, 255, 0.3); display: flex; align-items: center; gap: 6px;">
                    <i class="fas fa-brain" style="animation: pulse 2s infinite;"></i>
                    AI Ready
                </div>
                <style>
                    @keyframes pulse {
                        0%, 100% { opacity: 1; }
                        50% { opacity: 0.7; }
                    }
                </style>
            `;
            document.body.appendChild(indicator);
            
            // Remove indicator after 3 seconds
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }
        
        // AI-powered search enhancement
        async function enhanceSearchWithAI(originalResults, searchParams) {
            if (!originalResults.length) return originalResults;
            
            // Get AI recommendations
            const aiResults = await getIntelligentRideRecommendations(searchParams, originalResults);
            
            return aiResults;
        }
        
        // Save subscription to database
        async function saveSubscriptionToDatabase(subscription) {
            if (!supabase || !currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('notification_subscriptions')
                    .upsert([
                        {
                            user_id: currentUser.id,
                            endpoint: subscription.endpoint,
                            p256dh: subscription.keys?.p256dh || null,
                            auth: subscription.keys?.auth || null
                        }
                    ]);
                
                if (error) {
                    console.error('Error saving subscription:', error);
                } else {
                    console.log('Subscription saved to database');
                }
            } catch (error) {
                console.error('Error saving subscription:', error);
            }
        }
        
        // Add location tracking functions
        let locationWatchId = null;
        let currentUserLocation = null;
        
        // Start location tracking for rides
        async function startLocationTracking(rideId) {
            if (!navigator.geolocation) {
                console.error('Geolocation not supported');
                return;
            }
            
            const options = {
                enableHighAccuracy: true,
                timeout: 5000,
                maximumAge: 0
            };
            
            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    currentUserLocation = position;
                    updateLocationInDatabase(rideId, position);
                },
                (error) => {
                    console.error('Location error:', error);
                },
                options
            );
            
            console.log('Location tracking started for ride:', rideId);
        }
        
        // Stop location tracking
        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                console.log('Location tracking stopped');
            }
        }
        
        // Update location in database
        async function updateLocationInDatabase(rideId, position) {
            if (!supabase || !currentUser) return;
            
            try {
                const { error } = await supabase
                    .from('ride_locations')
                    .insert([
                        {
                            ride_id: rideId,
                            user_id: currentUser.id,
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        }
                    ]);
                
                if (error) {
                    console.error('Error updating location:', error);
                } else {
                    console.log('Location updated in database');
                }
            } catch (error) {
                console.error('Error updating location:', error);
            }
        }
        
        // Get current location
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position),
                    (error) => reject(error),
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            });
        }
        
    </script>
</body>
</html>